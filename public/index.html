<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hey Hey First Grade! - Mr. Davis's Class</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['"Poppins"','ui-sans-serif','system-ui'],
            body: ['"Inter"','ui-sans-serif','system-ui'],
          },
          colors: {
            brand: {
              mustard:'#E0B14A', slate:'#7B8E9E', coral:'#E9867D',
              blush:'#F2C9BE', cream:'#F7EFE2', pebble:'#E6D5B8',
              ink:'#2B2B2B', white:'#FFFFFF'
            }
          },
          boxShadow:{ soft:'0 10px 30px rgba(43,43,43,0.10)' }
        }
      }
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBVFcyBYlz3DmCkOervIswwjPf6wwFZlhU",
      authDomain: "first-grade-news-hub.firebaseapp.com",
      projectId: "first-grade-news-hub",
      storageBucket: "first-grade-news-hub.firebasestorage.app",
      messagingSenderId: "472215115326",
      appId: "1:472215115326:web:0d1f2cb7c1d5615676636f",
      measurementId: "G-5SF4RE6KLS"
    };
    // Initialize Firebase with error handling
    let db, auth, storage;
    try {
      firebase.initializeApp(firebaseConfig);
      try { firebase.analytics(); } catch (e) { console.warn('Firebase analytics failed:', e); }
      db = firebase.firestore();
      auth = firebase.auth();
      storage = firebase.storage();
      console.log('Firebase initialized successfully');
    } catch (e) {
      console.error('Firebase initialization failed:', e);
      // Set db to undefined so we can check for it later
      db = undefined;
      auth = undefined;
      storage = undefined;
    }
    
    // Ensure the user is signed in before performing Firestore writes
    async function ensureSignedIn() {
      const user = firebase.auth().currentUser;
      if (!user) {
        await firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
      }
    }
  </script>
  
  <style>
    :root{
      --md-mustard:#E0B14A; --md-slate:#7B8E9E; --md-coral:#E9867D;
      --md-blush:#F2C9BE; --md-cream:#F7EFE2; --md-pebble:#E6D5B8;
      --md-ink:#2B2B2B; --md-white:#FFFFFF;
      --hdr-bg: var(--md-mustard);
      --card-bg: var(--md-cream);
    }
    
    /* Modern Dark Mode Variables */
    body.dark {
      --md-mustard: #F4D03F; /* Lighter mustard for dark mode */
      --md-slate: #85929E; /* Lighter slate for dark mode */
      --md-coral: #F1948A; /* Lighter coral for dark mode */
      --md-blush: #F8C4B4; /* Lighter blush for dark mode */
      --md-cream: #1A1D23; /* Dark background for cards */
      --md-pebble: #C8B99C; /* Lighter pebble for dark mode */
      --md-ink: #E8E8E8; /* Light text for dark mode */
      --md-white: #2C3E50; /* Dark surface for dark mode */
      --hdr-bg: #2C3E50; /* Dark header background */
      --card-bg: #1A1D23; /* Dark card background */
    }
    .fade-in{opacity:0;transform:translateY(8px);transition:opacity .35s,transform .35s}
    .fade-in.visible{opacity:1;transform:translateY(0)}
    .pagePanel{display:none}
    .pagePanel.active{display:block}
    .edit-only{display:none!important}
    body.editing .edit-only{display:inline-flex!important}
    body.editing [data-edit="teacher"][contenteditable="true"]{outline:2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent);outline-offset:4px;border-radius:.5rem}
    .teacher-only-edit:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
    body.editing .teacher-only-edit:not(:disabled) {
      background-color: white; color: var(--md-ink); cursor: text;
      outline: 2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent); outline-offset: 2px;
    }
    /* Hide Practice Website URL inputs when not in edit mode */
    .website-url-input { display: none; }
    body.editing .website-url-input { display: block; }
    /* Snack message textarea styling */
    #snackMessage:disabled { background-color: transparent; color: var(--md-ink); cursor: default; border: none; }
    body.editing #snackMessage:not(:disabled) {
      background-color: rgba(255,255,255,0.7); cursor: text;
      outline: 2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent); outline-offset: 2px;
    }
    /* Styling for disabled about me, class roster, birthday, and website fields */
    #aboutMeDescText[contenteditable="false"] { background-color: transparent; border: none; cursor: default; }
    body.editing #aboutMeDescText[contenteditable="true"] { 
      outline: 2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent); outline-offset: 2px;
    }
    #classRosterTextarea:disabled, .website-url-input:disabled, textarea[id*="BirthdaysTextarea"]:disabled { 
      background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; border-color: #e5e7eb;
    }
    body.editing #classRosterTextarea:not(:disabled), body.editing .website-url-input:not(:disabled), body.editing textarea[id*="BirthdaysTextarea"]:not(:disabled) {
      background-color: white; color: var(--md-ink); cursor: text;
      outline: 2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent); outline-offset: 2px;
    }
    /* Photo card and gallery cursor only in edit mode */
    .photo-card{cursor: default;}
    body.editing .photo-card{cursor: pointer;}
    .gallery-imgs{cursor: default;}
    body.editing .gallery-imgs{cursor: pointer;}
    body.dark{background: #17212B; color: var(--md-ink);}
    body.dark .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.5)}
    body.dark .bg-white { background: var(--md-white) !important; }
    body.dark .bg-yellow-50 { background: rgba(244, 208, 63, 0.1) !important; }
    body.dark .bg-blue-50 { background: rgba(133, 146, 158, 0.1) !important; }
    body.dark .bg-green-50 { background: rgba(125, 206, 160, 0.1) !important; }
    body.dark .border { border-color: rgba(232, 232, 232, 0.2) !important; }
    body.dark .text-gray-400 { color: #A0A0A0 !important; }
    #pinOverlay { display: none; }
    #pinOverlay.show { display: flex; }
    .pageTab.active, .pageTab.ring-4 { box-shadow: 0 0 0 3px #fff9; }
    .snack-claimed { background: #e0b14a33; }
    .gallery-arrows { position:absolute;top:50%;left:0;width:100%;display:flex;justify-content:space-between;align-items:center;pointer-events:none; }
    .gallery-arrows button { pointer-events:auto;border:none;background:rgba(255,255,255,.75);border-radius:50%;font-size:1.5rem;padding:0.25em 0.6em;cursor:pointer; }
    .gallery-imgs { position:relative;}
    .gallery-imgs img { width:100%; height:100%; object-fit:cover; border-radius:1rem;}
  </style>
</head>
<body class="bg-[color:var(--md-cream)] text-[color:var(--md-ink)] font-body">
  <!-- HEADER -->
  <header class="relative w-full" style="background: var(--hdr-bg);">
    <div class="max-w-6xl mx-auto px-6 py-10 sm:py-12">
      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-display font-extrabold text-white">
        Hey Hey First Grade!
      </h1>
      <p id="weekText" class="mt-2 text-white/95 font-semibold"
         data-edit="teacher" contenteditable="false">Week of September 1‚Äì5</p>
      <div class="mt-6 flex flex-wrap items-center gap-3">
        <button id="toggleHighContrast"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white text-[color:var(--md-ink)] font-semibold hover:opacity-90">
          <span>üåì</span><span>Light/Dark</span>
        </button>
        <a href="mailto:dgonzalezjr@crossroadsschoolskc.org"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
           style="background: var(--md-coral);">
          <span>üìß</span><span>Contact Me</span>
        </a>
        <a id="classDojoBtn" href="https://classdojo.com" target="_blank"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
           style="background:#6b7280;">
          <span>üéØ</span><span>ClassDojo</span>
        </a>
        <button class="pageTab inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                data-page="transportation" style="background: var(--md-slate);">
          <span>üöå</span><span>Transportation</span>
        </button>
        <button class="pageTab inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                data-page="aboutme" style="background: var(--md-coral);">
          <span>üë®‚Äçüè´</span><span>About Me</span>
        </button>
        <button class="pageTab inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                data-page="birthdays" style="background: var(--md-coral);">
          <span>üéÇ</span><span>Birthdays</span>
        </button>
      </div>
    </div>
  </header>
  <!-- Tab Separator -->
  <div class="w-full">
    <div class="border-t-4" style="border-color: color-mix(in oklab, var(--md-slate) 70%, var(--md-white) 30%); box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
  </div>
  <main class="max-w-6xl mx-auto px-6 pb-16">
    <nav id="tabs" class="mt-6 mb-4 flex flex-wrap gap-2">
      <button class="pageTab active ring-4 ring-white/40 px-4 py-2 rounded-xl font-semibold text-white"
              data-page="home" style="background: var(--md-coral);">Home</button>
      <button class="pageTab px-4 py-2 rounded-xl font-semibold text-white"
              data-page="scholar" style="background: var(--md-mustard);">Scholar</button>
      <button class="pageTab px-4 py-2 rounded-xl font-semibold text-white"
              data-page="skills" style="background: var(--md-slate);">Skills</button>
      <button class="pageTab px-4 py-2 rounded-xl font-semibold text-white"
              data-page="listening" style="background: var(--md-coral);">Listening & Learning</button>
      <button class="pageTab px-4 py-2 rounded-xl font-semibold text-[color:var(--md-ink)]"
              data-page="math" style="background: var(--md-blush);">Math</button>
      <button class="pageTab px-4 py-2 rounded-xl font-semibold text-white"
              data-page="extras" style="background:#6b7280;">Extras</button>
      <button class="pageTab px-4 py-2 rounded-xl font-semibold text-white"
              data-page="specials" style="background:#f59e0b;">Specials</button>
      <button class="pageTab px-4 py-2 rounded-xl font-semibold text-white"
              data-page="practice" style="background: var(--md-pebble); color: var(--md-ink);">Practice Websites</button>
    </nav>
    <!-- HOME TAB -->
    <section data-page-panel="home" class="pagePanel fade-in active">
      <!-- What We Did -->
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <h2 class="text-2xl font-display font-bold mb-5 text-center">What We Did This Week</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <!-- 2 small + 1 large photo grid -->
          <div class="col-span-1 flex flex-col gap-4">
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="photo-card rounded-xl aspect-[4/3] bg-[color:var(--md-blush)] flex items-center justify-center text-3xl font-bold" onclick="editPhoto(this)">+</div>
              <div class="photo-card rounded-xl aspect-[4/3] bg-[color:var(--md-blush)] flex items-center justify-center text-3xl font-bold" onclick="editPhoto(this)">+</div>
            </div>
            <div class="photo-card rounded-xl aspect-[4/3] bg-[color:var(--md-blush)] flex items-center justify-center text-3xl font-bold" onclick="editPhoto(this)">+</div>
          </div>
          <!-- Editable recap -->
          <div class="md:col-span-2">
            <div class="rounded-xl p-4 sm:p-5 h-full flex items-center" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-blush) 30%); border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
              <p id="recapText" class="leading-relaxed w-full" data-edit="teacher" contenteditable="false">
                This week we explored magical stories and practiced our sight words. The students loved reading about brave characters and sharing their favorite parts! We also worked on counting by 5s and 10s using fun games and manipulatives. Our art projects focused on fall colors and textures - the students created beautiful leaf collages and practiced writing descriptive words.
              </p>
            </div>
          </div>
        </div>
      </div>
      <!-- Important Dates + Looking Ahead -->
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <div class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-display font-bold">Important Dates</h2>
              <button class="edit-only px-4 py-2 rounded-xl text-white font-semibold" style="background: var(--md-coral);" onclick="addEvent()">+ Add Event</button>
            </div>
            <div id="eventsList" class="space-y-4">
              <div class="event-item flex items-center gap-3 p-3 rounded-xl bg-yellow-50 border" style="border-color:var(--md-mustard)">
                <span class="event-emoji text-xl" data-edit="teacher" contenteditable="false">üéÉ</span>
                <span class="event-text font-semibold flex-1" data-edit="teacher" contenteditable="false">Halloween Party - October 31st at 2pm</span>
                <button class="edit-only text-red-500 hover:text-red-700" onclick="this.parentNode.remove()">‚úñ</button>
              </div>
              <div class="event-item flex items-center gap-3 p-3 rounded-xl bg-blue-50 border" style="border-color:var(--md-slate)">
                <span class="event-emoji text-xl" data-edit="teacher" contenteditable="false">ü¶É</span>
                <span class="event-text font-semibold flex-1" data-edit="teacher" contenteditable="false">Thanksgiving Break - November 23-27</span>
                <button class="edit-only text-red-500 hover:text-red-700" onclick="this.parentNode.remove()">‚úñ</button>
              </div>
            </div>
            <div class="p-4 rounded-xl mt-6" style="background: color-mix(in oklab, var(--md-white) 70%, #8b5cf6 30%); border: 1px solid color-mix(in oklab, #8b5cf6 60%, var(--md-white) 40%);">
              <h3 class="font-semibold mb-2">üìÖ School Calendar</h3>
              <a id="schoolCalendarLink" href="#" class="text-sm text-blue-600 hover:text-blue-800 underline" onclick="editSchoolCalendarLink(event, this)">View School Calendar</a>
              <p class="text-xs text-gray-600 mt-1">Click to visit the school calendar</p>
            </div>
          </div>
          <div>
            <div class="rounded-2xl p-5 h-full" style="background: color-mix(in oklab, var(--md-white) 68%, var(--md-blush) 32%); border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
              <h3 class="font-semibold mb-3">üîÆ Looking Ahead</h3>
              <ul class="space-y-2 text-sm" data-edit="teacher" contenteditable="false">
                <li>‚Ä¢ Field trip permission slips due</li>
                <li>‚Ä¢ Parent-teacher conferences</li>
                <li>‚Ä¢ Winter concert practice begins</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <!-- Snack Helpers -->
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-2xl font-display font-bold">ü•® Snack Helpers</h2>
            <p class="text-sm text-[color:var(--md-ink)]/80 mt-1">Check an item and add your name.</p>
          </div>
          <button id="snackAdd" class="px-3 py-2 rounded-lg text-white" style="background: var(--md-coral);" onclick="addSnackItem()">+ Add other snack</button>
        </div>
        <!-- Snack importance message -->
        <div class="mb-4 p-3 rounded-lg" style="background: color-mix(in oklab, var(--md-mustard) 20%, var(--md-white) 80%); border: 1px solid color-mix(in oklab, var(--md-mustard) 40%, var(--md-white) 60%);">
          <div class="flex justify-between items-start mb-2 edit-only" style="display: none;">
            <h4 class="font-semibold text-sm">Snack Message</h4>
            <button id="saveSnackMessageBtn" class="px-3 py-1 rounded-lg text-white text-xs font-semibold" style="background: var(--md-coral);" onclick="saveSnackMessage()">üíæ Save</button>
          </div>
          <textarea 
            id="snackMessage" 
            class="w-full text-sm border-0 resize-none" 
            style="background: transparent; outline: none;" 
            placeholder="Click to add a message about why snacks are important..."
            disabled 
            readonly
            rows="4">Snacks help keep our energy up during learning time and teach us about sharing and community!</textarea>
        </div>
        <div id="snacksGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Default snack cards - always visible, names only editable by teacher/admin -->
          <div class="p-4 rounded-xl bg-white default-snack-card" data-default-snack="true" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="1">
              <span class="text-xl">ü•Ø</span>
              <span class="font-medium snack-title" data-edit="teacher" contenteditable="false">Breakfast Bars</span>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="2">
              <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="3">Save</button>
            </div>
          </div>
          <div class="p-4 rounded-xl bg-white default-snack-card" data-default-snack="true" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="4">
              <span class="text-xl">üç¨</span>
              <span class="font-medium snack-title" data-edit="teacher" contenteditable="false">Gummies</span>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="5">
              <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="6">Save</button>
            </div>
          </div>
          <div class="p-4 rounded-xl bg-white default-snack-card" data-default-snack="true" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="7">
              <span class="text-xl">üçö</span>
              <span class="font-medium snack-title" data-edit="teacher" contenteditable="false">Rice Krispy Treats</span>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="8">
              <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="9">Save</button>
            </div>
          </div>
          <div class="p-4 rounded-xl bg-white default-snack-card" data-default-snack="true" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="10">
              <span class="text-xl">üßÉ</span>
              <span class="font-medium snack-title" data-edit="teacher" contenteditable="false">Juice</span>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="11">
              <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="12">Save</button>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- SCHOLAR TAB -->
    <section data-page-panel="scholar" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-10 mb-8" style="background: var(--md-white); border: 1px solid color-mix(in oklab, var(--md-mustard) 50%, var(--md-white) 50%);">
        <div class="grid lg:grid-cols-[auto,1fr] gap-8 items-center">
          <div class="w-40 h-40 sm:w-48 sm:h-48 rounded-full border-4 img-frame photo-card overflow-hidden mx-auto lg:mx-0" 
               style="border-color: var(--md-mustard);" onclick="editProfilePhoto(this, 'scholar')"></div>
          <div class="text-center lg:text-left relative">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full mb-4" style="background: color-mix(in oklab, var(--md-mustard) 25%, var(--md-white));">
              <span>üåü</span>
              <span class="text-sm font-semibold">Scholar of the Week</span>
            </div>
            <h3 class="text-3xl sm:text-4xl font-display font-extrabold mb-4" data-edit="teacher" contenteditable="false">Emma S.</h3>
            <p class="text-lg leading-relaxed mb-6" data-edit="teacher" contenteditable="false">
              Emma has shown incredible kindness this week by helping her classmates and always having a positive attitude. She's been working so hard on her reading and it really shows!
            </p>
            <button id="celebrateBtn" onclick="triggerConfetti()" 
                    class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-white" 
                    style="background: var(--md-coral);">
              <span>üéâ</span><span>Celebrate!</span>
            </button>
          </div>
        </div>
      </div>
    </section>
    <!-- SKILLS TAB -->
    <section data-page-panel="skills" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <h2 class="text-2xl font-display font-bold mb-4" style="color: var(--md-coral);">üìñ Skills Spotlight</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
            <p class="leading-relaxed" data-edit="teacher" contenteditable="false">
              This week we're focusing on building strong reading foundations through sight word recognition and phonics practice. Students are learning to blend sounds together to read new words and are practicing writing complete sentences with proper capitalization and punctuation.
            </p>
          </div>
          <div class="rounded-xl p-4" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-coral) 30%); border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h3 class="font-semibold mb-3">Sounds / Sight Words / Vocab</h3>
            <ul class="text-sm list-disc pl-5" data-edit="teacher" contenteditable="false">
              <li>Short vowel sounds</li>
              <li>Words: the, and, is, to</li>
              <li>Family vocabulary</li>
              <li>Action words</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
    <!-- LISTENING & LEARNING TAB -->
    <section data-page-panel="listening" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <h2 class="text-2xl font-display font-bold mb-4" style="color: var(--md-coral);">üëÇ Listening & Learning</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
            <p class="leading-relaxed" data-edit="teacher" contenteditable="false">
              We're building strong listening skills through daily read-alouds and interactive discussions. Students practice following multi-step directions and learn to ask thoughtful questions about the stories we read together.
            </p>
          </div>
          <div class="rounded-xl p-4" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-coral) 30%); border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h3 class="font-semibold mb-3">Ask your scholar...</h3>
            <ul class="text-sm list-disc pl-5" data-edit="teacher" contenteditable="false">
              <li>What happened in today's story?</li>
              <li>Who was your favorite character?</li>
              <li>What do you think happens next?</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
    <!-- MATH TAB -->
    <section data-page-panel="math" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <div class="flex items-center justify-between mb-5">
          <h2 class="text-2xl font-display font-bold" style="color: var(--md-slate);">üßÆ Math Adventures</h2>
        </div>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
            <p class="leading-relaxed" data-edit="teacher" contenteditable="false">
              We're exploring number patterns and building addition skills using hands-on manipulatives and fun games. Students are learning to count by 2s, 5s, and 10s while practicing addition facts within 20.
            </p>
          </div>
          <div class="rounded-xl p-4" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-blush) 30%); border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
            <h3 class="font-semibold mb-3">Vocabulary & Strategies</h3>
            <ul class="text-sm list-disc pl-5" data-edit="teacher" contenteditable="false">
              <li>Addition, sum, plus</li>
              <li>Count on strategy</li>
              <li>Number line</li>
              <li>Ten frames</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
    <!-- EXTRAS TAB -->
    <section data-page-panel="extras" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8" style="background: var(--card-bg);">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-display font-bold" style="color: var(--md-coral);">‚ú® Classroom Updates</h2>
          <div class="flex gap-2">
            <button id="saveExtrasBtn" class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveExtrasCards()">üíæ Save Cards</button>
            <button id="addExtrasCardBtn" class="px-3 py-2 rounded-lg text-white text-sm" style="background: var(--md-slate);" onclick="addExtrasCard()">+ Add Card</button>
          </div>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6" id="extrasGrid">
          <div class="text-center p-8 rounded-2xl" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-mustard) 30%); border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <div class="text-6xl mb-4 emoji-edit" contenteditable="false" style="cursor: default;">üéØ</div>
            <h3 class="font-semibold mb-2" contenteditable="false" style="cursor: default;">Class Goal</h3>
            <p class="text-sm" contenteditable="false" style="cursor: default;">We're working together to read 100 books this month!</p>
            <button class="mt-2 text-red-500 hover:text-red-700 text-xs" onclick="this.closest('.text-center').remove();" style="display: none;">Remove Card</button>
          </div>
          <div class="text-center p-8 rounded-2xl" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-coral) 30%); border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <div class="text-6xl mb-4 emoji-edit" contenteditable="false" style="cursor: default;">üì£</div>
            <h3 class="font-semibold mb-2" contenteditable="false" style="cursor: default;">Shout-outs</h3>
            <p class="text-sm" contenteditable="false" style="cursor: default;">Amazing job on our math assessments this week!</p>
            <button class="mt-2 text-red-500 hover:text-red-700 text-xs" onclick="this.closest('.text-center').remove();" style="display: none;">Remove Card</button>
          </div>
        </div>
      </div>
    </section>
    <!-- SPECIALS TAB -->
    <section data-page-panel="specials" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <h2 class="text-2xl font-display font-bold mb-6" style="color: #f59e0b;">üé® Specials Classes</h2>
        <div class="grid md:grid-cols-2 gap-8">
          <!-- Art -->
          <div class="rounded-2xl overflow-hidden relative" style="background: color-mix(in oklab, var(--md-white) 70%, #ef4444 30%); border: 1px solid color-mix(in oklab, #ef4444 60%, var(--md-white) 40%);">
            <div class="gallery-imgs aspect-[4/3] bg-white m-4 flex items-center justify-center relative" onclick="editGalleryPhoto(this, 'art')" data-gallery-type="art">
              <img src="" alt="Art Gallery" style="display:none;">
              <span class="text-3xl text-gray-400">+</span>
              <span class="gallery-arrows">
                <button onclick="event.stopPropagation(); prevGalleryImg(this)">‚Äπ</button>
                <button onclick="event.stopPropagation(); nextGalleryImg(this)">‚Ä∫</button>
              </span>
              <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteGalleryPhoto(this, 'art')" title="Delete Photo">‚úñ</button>
            </div>
            <div class="rounded-lg p-4 m-4 bg-white" style="color: var(--md-ink);">
              <h3 class="font-semibold">üé® Art</h3>
              <p class="text-sm" data-edit="teacher" contenteditable="false">Creative masterpieces from art class</p>
            </div>
          </div>
          <!-- STEM -->
          <div class="rounded-2xl overflow-hidden relative" style="background: color-mix(in oklab, var(--md-white) 70%, #10b981 30%); border: 1px solid color-mix(in oklab, #10b981 60%, var(--md-white) 40%);">
            <div class="gallery-imgs aspect-[4/3] bg-white m-4 flex items-center justify-center relative" onclick="editGalleryPhoto(this, 'stem')" data-gallery-type="stem">
              <img src="" alt="STEM Gallery" style="display:none;">
              <span class="text-3xl text-gray-400">+</span>
              <span class="gallery-arrows">
                <button onclick="event.stopPropagation(); prevGalleryImg(this)">‚Äπ</button>
                <button onclick="event.stopPropagation(); nextGalleryImg(this)">‚Ä∫</button>
              </span>
              <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteGalleryPhoto(this, 'stem')" title="Delete Photo">‚úñ</button>
            </div>
            <div class="rounded-lg p-4 m-4 bg-white" style="color: var(--md-ink);">
              <h3 class="font-semibold">üî¨ STEM</h3>
              <p class="text-sm" data-edit="teacher" contenteditable="false">Science experiments and discoveries</p>
            </div>
          </div>
          <!-- Gym -->
          <div class="rounded-2xl overflow-hidden relative" style="background: color-mix(in oklab, var(--md-white) 70%, #3b82f6 30%); border: 1px solid color-mix(in oklab, #3b82f6 60%, var(--md-white) 40%);">
            <div class="gallery-imgs aspect-[4/3] bg-white m-4 flex items-center justify-center relative" onclick="editGalleryPhoto(this, 'gym')" data-gallery-type="gym">
              <img src="" alt="Gym Gallery" style="display:none;">
              <span class="text-3xl text-gray-400">+</span>
              <span class="gallery-arrows">
                <button onclick="event.stopPropagation(); prevGalleryImg(this)">‚Äπ</button>
                <button onclick="event.stopPropagation(); nextGalleryImg(this)">‚Ä∫</button>
              </span>
              <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteGalleryPhoto(this, 'gym')" title="Delete Photo">‚úñ</button>
            </div>
            <div class="rounded-lg p-4 m-4 bg-white" style="color: var(--md-ink);">
              <h3 class="font-semibold">üèÉ‚Äç‚ôÇÔ∏è Gym</h3>
              <p class="text-sm" data-edit="teacher" contenteditable="false">Physical activities and games</p>
            </div>
          </div>
          <!-- Music -->
          <div class="rounded-2xl overflow-hidden relative" style="background: color-mix(in oklab, var(--md-white) 70%, #8b5cf6 30%); border: 1px solid color-mix(in oklab, #8b5cf6 60%, var(--md-white) 40%);">
            <div class="gallery-imgs aspect-[4/3] bg-white m-4 flex items-center justify-center relative" onclick="editGalleryPhoto(this, 'music')" data-gallery-type="music">
              <img src="" alt="Music Gallery" style="display:none;">
              <span class="text-3xl text-gray-400">+</span>
              <span class="gallery-arrows">
                <button onclick="event.stopPropagation(); prevGalleryImg(this)">‚Äπ</button>
                <button onclick="event.stopPropagation(); nextGalleryImg(this)">‚Ä∫</button>
              </span>
              <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteGalleryPhoto(this, 'music')" title="Delete Photo">‚úñ</button>
            </div>
            <div class="rounded-lg p-4 m-4 bg-white" style="color: var(--md-ink);">
              <h3 class="font-semibold">üéµ Music</h3>
              <p class="text-sm" data-edit="teacher" contenteditable="false">Songs and musical learning</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- PRACTICE WEBSITES TAB -->
    <section data-page-panel="practice" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--md-cream);">
        <div class="flex items-center justify-between mb-5">
          <h2 class="text-2xl font-display font-bold" style="color: var(--md-slate);">üåê Practice Websites</h2>
          <button id="saveWebsitesBtn" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-slate);" onclick="saveWebsiteUrls()">üíæ Save URLs</button>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="website-card text-center p-6 rounded-xl bg-white" style="border: 1px solid color-mix(in oklab, var(--md-slate) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">üì±</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">ClassDojo</h3>
            <a href="https://classdojo.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-white text-sm" style="background: var(--md-slate);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://classdojo.com" onchange="updateWebsiteUrl(this)">
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" style="border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">üéØ</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">Clever ‚Äì Learning Portal</h3>
            <a href="https://clever.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-white text-sm" style="background: var(--md-mustard);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://clever.com" onchange="updateWebsiteUrl(this)">
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" style="border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">üìò</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">Math Practice</h3>
            <a href="https://mathplayground.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-white text-sm" style="background: var(--md-coral);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://mathplayground.com" onchange="updateWebsiteUrl(this)">
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" style="border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">üìö</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">Skills Practice</h3>
            <a href="https://readingeggs.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold" style="background: var(--md-blush); color: var(--md-ink);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://readingeggs.com" onchange="updateWebsiteUrl(this)">
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" style="border: 1px solid color-mix(in oklab, var(--md-pebble) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">üî§</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">Blending Practice</h3>
            <a href="https://starfall.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-sm" style="background: var(--md-pebble); color: var(--md-ink);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://starfall.com" onchange="updateWebsiteUrl(this)">
          </div>
        </div>
      </div>
    </section>
    <!-- TRANSPORTATION TAB (always editable) -->
    <section data-page-panel="transportation" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--md-cream);">
        <h2 class="text-2xl font-display font-bold mb-6" style="color: #f59e0b;">üöå Transportation</h2>
        <div class="space-y-6">
          <div class="bg-white rounded-xl p-6" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">üöå Bus Riders</h3>
              <button id="saveBusRidersBtn" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveTransportationField('busRiders')">üíæ Save</button>
            </div>
            <textarea id="busRidersTextarea" class="w-full h-32 p-3 text-sm border rounded-lg resize-none" placeholder="Student name and bus number"></textarea>
          </div>
          <div class="bg-white rounded-xl p-6" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">üöó Car Riders</h3>
              <button id="saveCarRidersBtn" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveTransportationField('carRiders')">üíæ Save</button>
            </div>
            <textarea id="carRidersTextarea" class="w-full h-32 p-3 text-sm border rounded-lg resize-none"></textarea>
          </div>
          <div class="bg-white rounded-xl p-6" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">üè† Porch Pickup</h3>
              <button id="savePorchPickupBtn" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveTransportationField('porchPickup')">üíæ Save</button>
            </div>
            <textarea id="porchPickupTextarea" class="w-full h-32 p-3 text-sm border rounded-lg resize-none"></textarea>
          </div>
        </div>
      </div>
    </section>
    <!-- ABOUT ME TAB -->
    <section data-page-panel="aboutme" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-10 mb-8" style="background: var(--md-cream);">
        <div class="grid md:grid-cols-[auto,1fr] gap-8 items-center">
          <div class="w-40 h-40 sm:w-48 sm:h-48 rounded-full border-4 img-frame photo-card overflow-hidden mx-auto md:mx-0" 
               style="border-color: var(--md-mustard);" onclick="editProfilePhoto(this, 'aboutme')"></div>
          <div>
            <h2 class="text-2xl font-display font-bold mb-6" style="color: var(--md-coral);">üëã About Mr. Davis</h2>
            <div class="mb-6">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">About Me</h3>
                <button id="saveAboutMeDescBtn" class="px-3 py-1 rounded-lg text-white text-xs font-semibold" style="background: var(--md-coral);" onclick="saveAboutMeField('aboutMeDesc')">üíæ Save</button>
              </div>
              <p id="aboutMeDescText" class="leading-relaxed" contenteditable="false" style="min-height: 60px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;">
                I've been teaching first grade for 8 years and absolutely love working with young learners! I believe every child can succeed with the right support and encouragement.
              </p>
            </div>
            <div class="mb-6">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">Fun Facts</h3>
                <button id="saveFunFactsBtn" class="px-3 py-1 rounded-lg text-white text-xs font-semibold" style="background: var(--md-coral);" onclick="saveAboutMeField('funFacts')">üíæ Save</button>
              </div>
              <ul id="funFactsList" class="list-disc pl-5 space-y-1" contenteditable="false" style="min-height: 80px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;">
                <li>I love reading mystery novels</li>
                <li>I have two cats named Whiskers and Mittens</li>
                <li>I enjoy hiking on weekends</li>
                <li>I can play the guitar</li>
              </ul>
            </div>
          </div>
        </div>
        <!-- Favorites Section moved to bottom -->
        <div class="mt-8">
          <h3 class="font-semibold mb-4 text-center">Personal Favorites</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-xl p-4 text-center">
              <div class="text-2xl mb-2">üé®</div>
              <h4 class="font-semibold text-sm mb-1">Favorite Color</h4>
              <p id="favoriteColorText" class="text-xs" contenteditable="false" style="min-height: 20px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;">Blue</p>
              <button id="saveFavoriteColorBtn" class="mt-2 px-2 py-1 rounded text-white text-xs" style="background: var(--md-coral);" onclick="saveAboutMeField('favoriteColor')">üíæ</button>
            </div>
            <div class="bg-white rounded-xl p-4 text-center">
              <div class="text-2xl mb-2">üç™</div>
              <h4 class="font-semibold text-sm mb-1">Favorite Snack</h4>
              <p id="favoriteSnackText" class="text-xs" contenteditable="false" style="min-height: 20px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;">Cookies</p>
              <button id="saveFavoriteSnackBtn" class="mt-2 px-2 py-1 rounded text-white text-xs" style="background: var(--md-coral);" onclick="saveAboutMeField('favoriteSnack')">üíæ</button>
            </div>
            <div class="bg-white rounded-xl p-4 text-center">
              <div class="text-2xl mb-2">ü•§</div>
              <h4 class="font-semibold text-sm mb-1">Favorite Drink</h4>
              <p id="favoriteDrinkText" class="text-xs" contenteditable="false" style="min-height: 20px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;">Coffee</p>
              <button id="saveFavoriteDrinkBtn" class="mt-2 px-2 py-1 rounded text-white text-xs" style="background: var(--md-coral);" onclick="saveAboutMeField('favoriteDrink')">üíæ</button>
            </div>
            <div class="bg-white rounded-xl p-4 text-center">
              <div class="text-2xl mb-2">üì∫</div>
              <h4 class="font-semibold text-sm mb-1">Favorite Show</h4>
              <p id="favoriteShowText" class="text-xs" contenteditable="false" style="min-height: 20px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;">The Office</p>
              <button id="saveFavoriteShowBtn" class="mt-2 px-2 py-1 rounded text-white text-xs" style="background: var(--md-coral);" onclick="saveAboutMeField('favoriteShow')">üíæ</button>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- BIRTHDAYS TAB -->
    <section data-page-panel="birthdays" class="pagePanel fade-in">
      <h2 class="text-2xl font-display font-bold mb-6" style="color: var(--md-coral);">üéÇ Class Roster & Birthdays</h2>
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8 bg-white" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
        <div class="flex justify-between items-center mb-5">
          <h3 class="text-xl font-semibold">üë• Class Roster</h3>
          <button id="saveClassRosterBtn" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveBirthdayField('classRoster')">üíæ Save</button>
        </div>
        <textarea id="classRosterTextarea" class="w-full h-40 p-4 text-sm border rounded-lg resize-none" placeholder="‚Ä¢ Type your student names here...
‚Ä¢ One student per line
‚Ä¢ Use bullet points or dashes">‚Ä¢ Emma S.
‚Ä¢ Jake M.
‚Ä¢ Sarah L.
‚Ä¢ Alex R.
‚Ä¢ Mia K.
‚Ä¢ Noah T.</textarea>
      </div>
      <div class="rounded-2xl shadow-soft p-6 sm:p-8" style="background: var(--md-cream);">
        <div class="flex justify-between items-center mb-5">
          <h3 class="text-xl font-semibold">üéÇ Birthday Calendar</h3>
          <button id="saveAllBirthdaysBtn" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveAllBirthdays()">üíæ Save All Birthdays</button>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">‚ùÑÔ∏è January</h4>
            <textarea id="januaryBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">üíï February</h4>
            <textarea id="februaryBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">üå∏ March</h4>
            <textarea id="marchBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-slate) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">üå∑ April</h4>
            <textarea id="aprilBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-pebble) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">üå∫ May</h4>
            <textarea id="mayBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">‚òÄÔ∏è June</h4>
            <textarea id="juneBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">üèñÔ∏è July</h4>
            <textarea id="julyBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">üåª August</h4>
            <textarea id="augustBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-slate) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">üçé September</h4>
            <textarea id="septemberBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-pebble) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">üçÇ October</h4>
            <textarea id="octoberBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays...">15th ‚Äì Emma S.
28th ‚Äì Jake M.</textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ü¶É November</h4>
            <textarea id="novemberBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays...">12th ‚Äì Sarah L.
25th ‚Äì Alex R.</textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">üéÑ December</h4>
            <textarea id="decemberBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays...">8th ‚Äì Mia K.
22nd ‚Äì Noah T.</textarea>
          </div>
        </div>
      </div>
    </section>
  </main>
  <footer class="bg-white border-t border-gray-200 mt-16">
    <div class="max-w-6xl mx-auto px-6 py-8">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">¬© 2025 Mr. Davis's First Grade Class</p>
        </div>
        <div class="flex gap-3">
          <button id="saveChangesBtn" class="px-4 py-2 rounded-xl font-semibold text-white shadow-soft" style="background: var(--md-coral); display: none;">
            üíæ Save Changes
          </button>
          <button id="editModeBtn" class="px-4 py-2 rounded-xl font-semibold text-white shadow-soft" style="background: var(--md-slate);">
            ‚úèÔ∏è Edit Mode
          </button>
        </div>
      </div>
    </div>
  </footer>
  <div id="pinOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center" style="z-index: 2000;">
    <div class="bg-white rounded-2xl shadow-soft p-8 max-w-md w-full mx-4">
      <h3 class="text-xl font-display font-bold mb-4 text-center">üîí Teacher Access</h3>
      <p class="text-center text-gray-600 mb-6">Enter your PIN to edit this page</p>
      <div class="space-y-4">
        <input id="pinInput" type="password" placeholder="Enter PIN" class="w-full px-4 py-3 rounded-xl border text-center text-lg">
        <div class="flex gap-3">
          <button id="pinCancel" class="flex-1 px-4 py-3 rounded-xl border font-semibold">Cancel</button>
          <button id="pinSubmit" class="flex-1 px-4 py-3 rounded-xl font-semibold text-white" style="background: var(--md-slate);">Enter</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Tab navigation
    function showPage(pageId) {
      document.querySelectorAll('.pagePanel').forEach(panel => {
        panel.classList.remove('active','visible');
        if(panel.dataset.pagePanel === pageId){
          panel.classList.add('active');
          setTimeout(()=>panel.classList.add('visible'),10);
        }
      });
      document.querySelectorAll('.pageTab').forEach(btn => {
        btn.classList.remove('active','ring-4','ring-white/40');
        if(btn.dataset.page === pageId){
          btn.classList.add('active','ring-4','ring-white/40');
        }
      });
    }
    document.addEventListener('DOMContentLoaded',function(){
      showPage('home');
      document.querySelectorAll('.pageTab').forEach(btn=>{
        btn.addEventListener('click',function(e){
          e.preventDefault();
          showPage(btn.dataset.page);
        });
      });
      // Edit Mode PIN overlay logic
      const TEACHER_PIN = '2213';
      
      // Initialize read-only state on page load
      initializeReadOnlyState();
      
      document.getElementById('editModeBtn').onclick = function() {
        document.getElementById('pinOverlay').classList.add('show');
        document.getElementById('pinInput').focus();
      };
      document.getElementById('pinCancel').onclick = function() {
        document.getElementById('pinOverlay').classList.remove('show');
        document.getElementById('pinInput').value = '';
      };
      document.getElementById('pinSubmit').onclick = function() {
        var pin = document.getElementById('pinInput').value;
        if(pin === TEACHER_PIN){
          enterEditMode();
          document.getElementById('pinOverlay').classList.remove('show');
        }else{
          document.getElementById('pinInput').style.borderColor='#ef4444';
          setTimeout(()=>{document.getElementById('pinInput').style.borderColor='';},900);
        }
      };
      // Light/Dark toggle
      document.getElementById('toggleHighContrast').onclick=function(){
        document.body.classList.toggle('dark');
      };
      
      // Save Changes button
      document.getElementById('saveChangesBtn').onclick = saveChangesToFirestore;
    });
    
    // Track original values for change detection
    let originalValues = {};
    
    function storeOriginalValues() {
      originalValues = {};
      document.querySelectorAll('[data-edit="teacher"]').forEach((el, index) => {
        const key = `element_${index}`;
        if (el.tagName === 'UL') {
          // For lists, store the inner HTML
          originalValues[key] = el.innerHTML;
        } else {
          // For text content
          originalValues[key] = el.textContent || el.innerText || '';
        }
      });
    }
    
    function hasChanges() {
      let hasChanges = false;
      document.querySelectorAll('[data-edit="teacher"]').forEach((el, index) => {
        const key = `element_${index}`;
        const originalValue = originalValues[key] || '';
        let currentValue = '';
        
        if (el.tagName === 'UL') {
          currentValue = el.innerHTML;
        } else {
          currentValue = el.textContent || el.innerText || '';
        }
        
        if (originalValue !== currentValue) {
          hasChanges = true;
        }
      });
      return hasChanges;
    }
    
    
    function initializeReadOnlyState() {
      // Disable About Me section
      const aboutMeDescText = document.getElementById('aboutMeDescText');
      if (aboutMeDescText) aboutMeDescText.contentEditable = false;
      const funFactsList = document.getElementById('funFactsList');
      if (funFactsList) funFactsList.contentEditable = false;
      const favoriteColorText = document.getElementById('favoriteColorText');
      if (favoriteColorText) favoriteColorText.contentEditable = false;
      const favoriteSnackText = document.getElementById('favoriteSnackText');
      if (favoriteSnackText) favoriteSnackText.contentEditable = false;
      const favoriteDrinkText = document.getElementById('favoriteDrinkText');
      if (favoriteDrinkText) favoriteDrinkText.contentEditable = false;
      const favoriteShowText = document.getElementById('favoriteShowText');
      if (favoriteShowText) favoriteShowText.contentEditable = false;
      const aboutMeSaveButtons = ['saveAboutMeDescBtn', 'saveFunFactsBtn', 'saveFavoriteColorBtn', 'saveFavoriteSnackBtn', 'saveFavoriteDrinkBtn', 'saveFavoriteShowBtn'];
      aboutMeSaveButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.style.display = 'none';
      });
      
      // Disable Class Roster section
      const classRosterTextarea = document.getElementById('classRosterTextarea');
      if (classRosterTextarea) { classRosterTextarea.disabled = true; classRosterTextarea.readOnly = true; }
      const saveClassRosterBtn = document.getElementById('saveClassRosterBtn');
      if (saveClassRosterBtn) saveClassRosterBtn.style.display = 'none';
      
      // Disable Birthday sections
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      months.forEach(month => {
        const monthTextarea = document.getElementById(`${month}BirthdaysTextarea`);
        if (monthTextarea) { monthTextarea.disabled = true; monthTextarea.readOnly = true; }
      });
      const saveAllBirthdaysBtn = document.getElementById('saveAllBirthdaysBtn');
      if (saveAllBirthdaysBtn) saveAllBirthdaysBtn.style.display = 'none';
      
      // Disable Practice Websites section  
      document.querySelectorAll('.website-url-input').forEach(input => {
        input.disabled = true;
        input.readOnly = true;
      });
      const saveWebsitesBtn = document.getElementById('saveWebsitesBtn');
      if (saveWebsitesBtn) saveWebsitesBtn.style.display = 'none';
      
      // Disable Extras section
      const saveExtrasBtn = document.getElementById('saveExtrasBtn');
      if (saveExtrasBtn) saveExtrasBtn.style.display = 'none';
      const addExtrasCardBtn = document.getElementById('addExtrasCardBtn');
      if (addExtrasCardBtn) addExtrasCardBtn.style.display = 'none';
      
      // Disable Extras contenteditable elements and remove buttons
      document.querySelectorAll('#extrasGrid [contenteditable]').forEach(el => {
        el.contentEditable = false;
        el.style.cursor = 'default';
      });
      document.querySelectorAll('#extrasGrid button[onclick*="remove"]').forEach(btn => {
        btn.style.display = 'none';
      });
    }
    
    async function enterEditMode(){
      await ensureSignedIn();
      storeOriginalValues();
      document.body.classList.add('editing');
      document.querySelectorAll('[data-edit="teacher"]').forEach(el=>el.contentEditable=true);
      document.querySelectorAll('.teacher-only-edit').forEach(el=>{el.disabled=false;el.readOnly=false;});
      // Enable snack message textarea and show edit controls
      const snackMessage = document.getElementById('snackMessage');
      if (snackMessage) {
        snackMessage.disabled = false;
        snackMessage.readOnly = false;
      }
      // Show edit-only elements
      document.querySelectorAll('.edit-only').forEach(el => {
        el.style.display = 'block';
      });
      
      // Enable About Me section
      const aboutMeDescText = document.getElementById('aboutMeDescText');
      if (aboutMeDescText) aboutMeDescText.contentEditable = true;
      const funFactsList = document.getElementById('funFactsList');
      if (funFactsList) funFactsList.contentEditable = true;
      const favoriteColorText = document.getElementById('favoriteColorText');
      if (favoriteColorText) favoriteColorText.contentEditable = true;
      const favoriteSnackText = document.getElementById('favoriteSnackText');
      if (favoriteSnackText) favoriteSnackText.contentEditable = true;
      const favoriteDrinkText = document.getElementById('favoriteDrinkText');
      if (favoriteDrinkText) favoriteDrinkText.contentEditable = true;
      const favoriteShowText = document.getElementById('favoriteShowText');
      if (favoriteShowText) favoriteShowText.contentEditable = true;
      const aboutMeSaveButtons = ['saveAboutMeDescBtn', 'saveFunFactsBtn', 'saveFavoriteColorBtn', 'saveFavoriteSnackBtn', 'saveFavoriteDrinkBtn', 'saveFavoriteShowBtn'];
      aboutMeSaveButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.style.display = 'inline-block';
      });
      
      // Enable Class Roster section
      const classRosterTextarea = document.getElementById('classRosterTextarea');
      if (classRosterTextarea) { classRosterTextarea.disabled = false; classRosterTextarea.readOnly = false; }
      const saveClassRosterBtn = document.getElementById('saveClassRosterBtn');
      if (saveClassRosterBtn) saveClassRosterBtn.style.display = 'inline-block';
      
      // Enable Birthday sections
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      months.forEach(month => {
        const monthTextarea = document.getElementById(`${month}BirthdaysTextarea`);
        if (monthTextarea) { monthTextarea.disabled = false; monthTextarea.readOnly = false; }
      });
      const saveAllBirthdaysBtn = document.getElementById('saveAllBirthdaysBtn');
      if (saveAllBirthdaysBtn) saveAllBirthdaysBtn.style.display = 'inline-block';
      
      // Enable Practice Websites section  
      document.querySelectorAll('.website-url-input').forEach(input => {
        input.disabled = false;
        input.readOnly = false;
      });
      const saveWebsitesBtn = document.getElementById('saveWebsitesBtn');
      if (saveWebsitesBtn) saveWebsitesBtn.style.display = 'inline-block';
      
      // Enable Extras section
      const saveExtrasBtn = document.getElementById('saveExtrasBtn');
      if (saveExtrasBtn) saveExtrasBtn.style.display = 'inline-block';
      const addExtrasCardBtn = document.getElementById('addExtrasCardBtn');
      if (addExtrasCardBtn) addExtrasCardBtn.style.display = 'inline-block';
      
      // Enable Extras contenteditable elements and remove buttons
      document.querySelectorAll('#extrasGrid [contenteditable]').forEach(el => {
        el.contentEditable = true;
        el.style.cursor = 'text';
      });
      document.querySelectorAll('#extrasGrid button[onclick*="remove"]').forEach(btn => {
        btn.style.display = 'inline-block';
      });
      
      // Update gallery images clickable state (disable when in edit mode)
      document.querySelectorAll('.gallery-imgs img').forEach(img => {
        const galleryContainer = img.closest('.gallery-imgs');
        const galleryType = galleryContainer ? galleryContainer.getAttribute('data-gallery-type') : '';
        makeGalleryImageClickable(img, galleryType);
      });
      
      document.getElementById('editModeBtn').textContent = 'üíæ Exit Edit Mode';
      document.getElementById('editModeBtn').onclick = exitEditMode;
    }
    function exitEditMode(){
      document.body.classList.remove('editing');
      document.querySelectorAll('[data-edit="teacher"]').forEach(el=>el.contentEditable=false);
      document.querySelectorAll('.teacher-only-edit').forEach(el=>{el.disabled=true;el.readOnly=true;});
      // Disable snack message textarea and hide edit controls
      const snackMessage = document.getElementById('snackMessage');
      if (snackMessage) {
        snackMessage.disabled = true;
        snackMessage.readOnly = true;
      }
      // Hide edit-only elements
      document.querySelectorAll('.edit-only').forEach(el => {
        el.style.display = 'none';
      });
      
      // Disable About Me section
      const aboutMeDescText = document.getElementById('aboutMeDescText');
      if (aboutMeDescText) aboutMeDescText.contentEditable = false;
      const funFactsList = document.getElementById('funFactsList');
      if (funFactsList) funFactsList.contentEditable = false;
      const favoriteColorText = document.getElementById('favoriteColorText');
      if (favoriteColorText) favoriteColorText.contentEditable = false;
      const favoriteSnackText = document.getElementById('favoriteSnackText');
      if (favoriteSnackText) favoriteSnackText.contentEditable = false;
      const favoriteDrinkText = document.getElementById('favoriteDrinkText');
      if (favoriteDrinkText) favoriteDrinkText.contentEditable = false;
      const favoriteShowText = document.getElementById('favoriteShowText');
      if (favoriteShowText) favoriteShowText.contentEditable = false;
      const aboutMeSaveButtons = ['saveAboutMeDescBtn', 'saveFunFactsBtn', 'saveFavoriteColorBtn', 'saveFavoriteSnackBtn', 'saveFavoriteDrinkBtn', 'saveFavoriteShowBtn'];
      aboutMeSaveButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.style.display = 'none';
      });
      
      // Disable Class Roster section
      const classRosterTextarea = document.getElementById('classRosterTextarea');
      if (classRosterTextarea) { classRosterTextarea.disabled = true; classRosterTextarea.readOnly = true; }
      const saveClassRosterBtn = document.getElementById('saveClassRosterBtn');
      if (saveClassRosterBtn) saveClassRosterBtn.style.display = 'none';
      
      // Disable Birthday sections
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      months.forEach(month => {
        const monthTextarea = document.getElementById(`${month}BirthdaysTextarea`);
        if (monthTextarea) { monthTextarea.disabled = true; monthTextarea.readOnly = true; }
      });
      const saveAllBirthdaysBtn = document.getElementById('saveAllBirthdaysBtn');
      if (saveAllBirthdaysBtn) saveAllBirthdaysBtn.style.display = 'none';
      
      // Disable Practice Websites section  
      document.querySelectorAll('.website-url-input').forEach(input => {
        input.disabled = true;
        input.readOnly = true;
      });
      const saveWebsitesBtn = document.getElementById('saveWebsitesBtn');
      if (saveWebsitesBtn) saveWebsitesBtn.style.display = 'none';
      
      // Disable Extras section
      const saveExtrasBtn = document.getElementById('saveExtrasBtn');
      if (saveExtrasBtn) saveExtrasBtn.style.display = 'none';
      const addExtrasCardBtn = document.getElementById('addExtrasCardBtn');
      if (addExtrasCardBtn) addExtrasCardBtn.style.display = 'none';
      
      // Disable Extras contenteditable elements and remove buttons
      document.querySelectorAll('#extrasGrid [contenteditable]').forEach(el => {
        el.contentEditable = false;
        el.style.cursor = 'default';
      });
      document.querySelectorAll('#extrasGrid button[onclick*="remove"]').forEach(btn => {
        btn.style.display = 'none';
      });
      
      // Update gallery images clickable state (enable when not in edit mode)
      document.querySelectorAll('.gallery-imgs img').forEach(img => {
        const galleryContainer = img.closest('.gallery-imgs');
        const galleryType = galleryContainer ? galleryContainer.getAttribute('data-gallery-type') : '';
        makeGalleryImageClickable(img, galleryType);
      });
      
      document.getElementById('editModeBtn').textContent = '‚úèÔ∏è Edit Mode';
      document.getElementById('editModeBtn').onclick = function(){
        document.getElementById('pinOverlay').classList.add('show');
        document.getElementById('pinInput').focus();
      };
      
      // Check for changes and show/hide save button
      const saveBtn = document.getElementById('saveChangesBtn');
      if (hasChanges()) {
        saveBtn.style.display = 'block';
      } else {
        saveBtn.style.display = 'none';
      }
    }
    function collectEditableFieldData() {
      const data = {};
      
      // Week text
      const weekEl = document.getElementById('weekText');
      if (weekEl) data.week = weekEl.textContent || '';
      
      // Recap text
      const recapEl = document.getElementById('recapText');
      if (recapEl) data.recap = recapEl.textContent || '';
      
      // Events list - collect all event items
      const eventsContainer = document.getElementById('eventsList');
      if (eventsContainer) {
        const events = [];
        eventsContainer.querySelectorAll('.event-item').forEach(item => {
          const emoji = item.querySelector('.event-emoji')?.textContent || '';
          const text = item.querySelector('.event-text')?.textContent || '';
          if (text) {
            events.push({ icon: emoji, text: text });
          }
        });
        data.dates_json = JSON.stringify(events);
      }
      
      // Looking ahead items
      const lookingAheadSection = Array.from(document.querySelectorAll('div.rounded-2xl')).find(div =>
        div.querySelector('h3') && div.querySelector('h3').textContent.includes('Looking Ahead')
      );
      if (lookingAheadSection) {
        const ul = lookingAheadSection.querySelector('ul[data-edit="teacher"]');
        if (ul) {
          const items = Array.from(ul.querySelectorAll('li')).map(li => li.textContent.replace(/^‚Ä¢\s*/, ''));
          data.looking_ahead = items.join('\n');
        }
      }
      
      // Snacks grid - collect snack items with checkbox states
      const snacksGrid = document.getElementById('snacksGrid');
      if (snacksGrid) {
        const snacks = [];
        snacksGrid.querySelectorAll('.p-4').forEach(card => {
          const emoji = card.querySelector('.text-xl')?.textContent || '';
          const item = card.querySelector('.snack-title')?.textContent || '';
          const claimedBy = card.querySelector('.snack-name')?.value || '';
          const checked = card.querySelector('.snack-checkbox')?.checked || false;
          const isDefault = card.getAttribute('data-default-snack') === 'true';
          if (item) {
            snacks.push({ 
              emoji: emoji, 
              item: item, 
              claimed_by: claimedBy, 
              checked: checked,
              is_default: isDefault
            });
          }
        });
        data.snacks_json = JSON.stringify(snacks);
      }
      
      // Snack message
      const snackMessageEl = document.getElementById('snackMessage');
      if (snackMessageEl) data.snack_message = snackMessageEl.value || '';
      
      // Scholar info
      const scholarNameEl = document.querySelector('[data-page-panel="scholar"] h3[data-edit="teacher"]');
      if (scholarNameEl) data.scholar_name = scholarNameEl.textContent || '';
      
      const scholarBlurbEl = document.querySelector('[data-page-panel="scholar"] p[data-edit="teacher"]');
      if (scholarBlurbEl) data.scholar_blurb = scholarBlurbEl.textContent || '';
      
      // Skills section
      const skillsDescEl = document.querySelector('[data-page-panel="skills"] p[data-edit="teacher"]');
      if (skillsDescEl) data.skills_text = skillsDescEl.textContent || '';
      
      const skillsUl = document.querySelector('[data-page-panel="skills"] ul[data-edit="teacher"]');
      if (skillsUl) {
        const sounds = Array.from(skillsUl.querySelectorAll('li')).map(li => li.textContent);
        data.sounds_json = JSON.stringify(sounds);
      }
      
      // Listening section
      const listeningDescEl = document.querySelector('[data-page-panel="listening"] p[data-edit="teacher"]');
      if (listeningDescEl) data.listening_text = listeningDescEl.textContent || '';
      
      const listeningUl = document.querySelector('[data-page-panel="listening"] ul[data-edit="teacher"]');
      if (listeningUl) {
        const asks = Array.from(listeningUl.querySelectorAll('li')).map(li => li.textContent);
        data.ask_json = JSON.stringify(asks);
      }
      
      // Math section
      const mathDescEl = document.querySelector('[data-page-panel="math"] p[data-edit="teacher"]');
      if (mathDescEl) data.math_text = mathDescEl.textContent || '';
      
      const mathUl = document.querySelector('[data-page-panel="math"] ul[data-edit="teacher"]');
      if (mathUl) {
        const vocab = Array.from(mathUl.querySelectorAll('li')).map(li => li.textContent);
        data.math_vocab_json = JSON.stringify(vocab);
      }
      
      // Calendar URL
      const calendarLink = document.getElementById('schoolCalendarLink');
      if (calendarLink) data.calendar_url = calendarLink.href || '';
      
      // Photo cards URLs
      const photoCards = document.querySelectorAll('.photo-card');
      const photoUrls = [];
      photoCards.forEach(card => {
        const url = card.getAttribute('data-photo-url') || '';
        photoUrls.push(url);
      });
      data.photo_urls_json = JSON.stringify(photoUrls);
      
      // Gallery photos URLs
      const galleries = {};
      ['art', 'stem', 'gym', 'music'].forEach(type => {
        const galleryEl = document.querySelector(`[data-gallery-type="${type}"]`);
        if (galleryEl) {
          const urlsStr = galleryEl.getAttribute('data-gallery-urls');
          if (urlsStr) {
            try {
              galleries[type] = JSON.parse(urlsStr);
            } catch (e) {
              // Fallback to old format
              galleries[type] = galleryEl.getAttribute('data-gallery-url') || '';
            }
          } else {
            // Fallback to old format
            galleries[type] = galleryEl.getAttribute('data-gallery-url') || '';
          }
        }
      });
      data.gallery_urls_json = JSON.stringify(galleries);
      
      // Transportation fields
      const busRidersEl = document.getElementById('busRidersTextarea');
      if (busRidersEl) data.bus_riders = busRidersEl.value || '';
      
      const carRidersEl = document.getElementById('carRidersTextarea');
      if (carRidersEl) data.car_riders = carRidersEl.value || '';
      
      const porchPickupEl = document.getElementById('porchPickupTextarea');
      if (porchPickupEl) data.porch_pickup = porchPickupEl.value || '';
      
      // Birthday fields
      const classRosterEl = document.getElementById('classRosterTextarea');
      if (classRosterEl) data.class_roster = classRosterEl.value || '';
      
      // Monthly birthday fields
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                      'july', 'august', 'september', 'october', 'november', 'december'];
      months.forEach(month => {
        const monthEl = document.getElementById(`${month}BirthdaysTextarea`);
        if (monthEl) data[`${month}_birthdays`] = monthEl.value || '';
      });
      
      // About Me fields
      const aboutMeDescEl = document.getElementById('aboutMeDescText');
      if (aboutMeDescEl) data.about_me_html = aboutMeDescEl.innerHTML || '';
      
      const funFactsEl = document.getElementById('funFactsList');
      if (funFactsEl) {
        // Extract list items from the contenteditable ul
        const listItems = Array.from(funFactsEl.querySelectorAll('li')).map(li => li.textContent || '');
        data.fun_facts_html = listItems;
      }
      
      const favoriteColorEl = document.getElementById('favoriteColorText');
      if (favoriteColorEl) data.favorite_color = favoriteColorEl.textContent || '';
      
      const favoriteSnackEl = document.getElementById('favoriteSnackText');
      if (favoriteSnackEl) data.favorite_snack = favoriteSnackEl.textContent || '';
      
      const favoriteDrinkEl = document.getElementById('favoriteDrinkText');
      if (favoriteDrinkEl) data.favorite_drink = favoriteDrinkEl.textContent || '';
      
      const favoriteShowEl = document.getElementById('favoriteShowText');
      if (favoriteShowEl) data.favorite_show = favoriteShowEl.textContent || '';
      
      // Extras cards
      const extrasGrid = document.getElementById('extrasGrid');
      if (extrasGrid) {
        const extras = [];
        extrasGrid.querySelectorAll('.text-center').forEach(card => {
          const emojiEl = card.querySelector('.emoji-edit, [data-edit="teacher"]');
          const titleEl = card.querySelector('h3');
          const bodyEl = card.querySelector('p');
          
          if (titleEl && bodyEl) {
            extras.push({
              emoji: emojiEl ? emojiEl.textContent || '‚ú®' : '‚ú®',
              title: titleEl.textContent || '',
              body_html: bodyEl.textContent || ''
            });
          }
        });
        data.extras_json = JSON.stringify(extras);
      }
      
      // Website URLs
      const websiteCards = document.querySelectorAll('.website-card');
      const websites = [];
      websiteCards.forEach(card => {
        const titleEl = card.querySelector('.website-title');
        const urlInput = card.querySelector('.website-url-input');
        const linkEl = card.querySelector('.website-link');
        
        if (titleEl && urlInput) {
          websites.push({
            title: titleEl.textContent || '',
            url: urlInput.value || linkEl?.href || ''
          });
        }
      });
      data.websites_json = JSON.stringify(websites);
      
      // Profile photos URLs
      const scholarProfileEl = document.querySelector('[onclick*="scholar"]');
      if (scholarProfileEl) data.scholar_profile_url = scholarProfileEl.getAttribute('data-profile-url') || '';
      
      const aboutMeProfileEl = document.querySelector('[onclick*="aboutme"]');
      if (aboutMeProfileEl) data.about_me_profile_url = aboutMeProfileEl.getAttribute('data-profile-url') || '';
      
      return data;
    }
    
    async function saveChangesToFirestore() {
      const saveBtn = document.getElementById('saveChangesBtn');
      const originalText = saveBtn.textContent;
      
      try {
        await ensureSignedIn();
        
        // Show saving state
        saveBtn.textContent = '‚è≥ Saving...';
        saveBtn.disabled = true;
        
        // Collect all editable field data
        const data = collectEditableFieldData();
        
        // Save to Firestore
        await db.collection('classData').doc('current').set(data, { merge: true });
        
        // Show success state
        saveBtn.textContent = '‚úÖ Saved!';
        
        // Reload data from Firestore
        setTimeout(async () => {
          const updatedData = await fetchFirestoreData();
          populateDataFromSheet(updatedData);
          
          // Hide save button and reset original values
          saveBtn.style.display = 'none';
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
          originalValues = {};
        }, 1000);
        
      } catch (error) {
        console.error('Failed to save changes:', error);
        saveBtn.textContent = '‚ùå Save Failed';
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }, 2000);
      }
    }
    
    // Home tab: Add event
    function addEvent() {
      // Create event directly editable on the page instead of using prompts
      const div = document.createElement('div');
      div.className = 'event-item flex items-center gap-3 p-3 rounded-xl bg-yellow-50 border';
      div.style.borderColor = 'var(--md-mustard)';
      div.innerHTML = `
        <span class="event-emoji text-xl" data-edit="teacher" contenteditable="true">üéâ</span>
        <span class="event-text font-semibold flex-1" data-edit="teacher" contenteditable="true">Click to edit event</span>
        <button class="edit-only text-red-500 hover:text-red-700" onclick="this.parentNode.remove()">‚úñ</button>
      `;
      document.getElementById('eventsList').appendChild(div);
      
      // Auto-focus the text field for immediate editing
      const textSpan = div.querySelector('.event-text');
      textSpan.focus();
      textSpan.select();
    }
    // Home tab: Add snack
    function addSnackItem() {
      // Create new snack card that parents can edit (user-added, not default)
      const newSnack = document.createElement('div');
      newSnack.className = 'p-4 rounded-xl bg-white user-added-snack-card';
      newSnack.setAttribute('data-default-snack', 'false');
      newSnack.style.border = '1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%)';
      
      // Get the highest current tabindex to continue sequence
      const existingCheckboxes = document.querySelectorAll('.snack-checkbox');
      let nextTabIndex = (existingCheckboxes.length * 3) + 1;
      
      newSnack.innerHTML = `
        <div class="flex items-center gap-3 mb-3">
          <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="${nextTabIndex}">
          <span class="text-xl" contenteditable="true" style="cursor: text;">üçé</span>
          <span class="font-medium snack-title" contenteditable="true" style="cursor: text;">New snack</span>
        </div>
        <div class="flex items-center gap-2">
          <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="${nextTabIndex + 1}">
          <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="${nextTabIndex + 2}">Save</button>
          <button class="text-gray-400 hover:text-red-500" onclick="this.closest('.p-4').remove()">‚úñ</button>
        </div>
      `;
      document.getElementById('snacksGrid').appendChild(newSnack);
      
      // Focus on the snack name for editing
      const snackNameSpan = newSnack.querySelector('.snack-title');
      snackNameSpan.focus();
      // Select all text for contenteditable elements
      if (window.getSelection && document.createRange) {
        const range = document.createRange();
        range.selectNodeContents(snackNameSpan);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
    
    // Toggle snack input based on checkbox state
    function toggleSnackInput(checkbox) {
      const card = checkbox.closest('.p-4');
      const nameInput = card.querySelector('.snack-name');
      const saveButton = card.querySelector('button[onclick*="claimSnack"]');
      
      if (checkbox.checked) {
        nameInput.disabled = false;
        saveButton.disabled = false;
        nameInput.focus();
        // Add visual feedback that it's now active
        card.style.backgroundColor = 'rgba(224, 177, 74, 0.1)';
      } else {
        nameInput.disabled = true;
        saveButton.disabled = true;
        nameInput.value = '';
        // Remove claimed styling and reset background
        card.classList.remove('snack-claimed');
        card.style.backgroundColor = 'white';
        
        // Save the unclaimed state to the backend
        saveSnackDataToFirestore().catch((error) => {
          console.error('Failed to save unclaim state:', error);
        });
      }
      
      // Only show global save button for teachers/admins in edit mode
      if (document.body.classList.contains('editing')) {
        const saveBtn = document.getElementById('saveChangesBtn');
        if (saveBtn) saveBtn.style.display = 'block';
      }
    }
    // Snack claim
    function claimSnack(btn) {
      const card = btn.closest('.p-4');
      const checkbox = card.querySelector('.snack-checkbox');
      const name = card.querySelector('.snack-name').value.trim();
      
      // Only allow claiming if checkbox is checked and name is provided
      if (checkbox && checkbox.checked && name) {
        card.classList.add('snack-claimed');
        btn.textContent = 'Saving...';
        btn.disabled = true;
        
        // Save to Firestore immediately
        saveSnackDataToFirestore().then(() => {
          btn.textContent = 'Saved!';
          setTimeout(() => {
            btn.textContent = 'Save';
            btn.disabled = false;
          }, 1800);
        }).catch((error) => {
          console.error('Failed to save snack data:', error);
          btn.textContent = 'Save Failed';
          setTimeout(() => {
            btn.textContent = 'Save';
            btn.disabled = false;
          }, 2000);
        });
        
        // Only show global save button for teachers/admins in edit mode
        // Parents get individual card saves only
        if (document.body.classList.contains('editing')) {
          const saveBtn = document.getElementById('saveChangesBtn');
          if (saveBtn) saveBtn.style.display = 'block';
        }
      } else if (!checkbox || !checkbox.checked) {
        alert('Please check the box first to claim this snack.');
      } else if (!name) {
        alert('Please enter your name to claim this snack.');
      }
    }
    
    // Function to save snack message
    async function saveSnackMessage() {
      const snackMessageEl = document.getElementById('snackMessage');
      const saveBtn = document.getElementById('saveSnackMessageBtn');
      
      if (!snackMessageEl || !saveBtn) return;
      
      const originalText = saveBtn.textContent;
      
      try {
        await ensureSignedIn();
        
        // Show saving state
        saveBtn.textContent = '‚è≥ Saving...';
        saveBtn.disabled = true;
        
        const message = snackMessageEl.value || '';
        
        // Try to save to Firestore first
        if (typeof db !== 'undefined') {
          await db.collection('classData').doc('current').set(
            { snack_message: message }, 
            { merge: true }
          );
        } else {
          // Fallback to localStorage for testing
          localStorage.setItem('classData_snack_message', message);
        }
        
        // Show success state
        saveBtn.textContent = '‚úÖ Saved!';
        
        // Reset button after delay
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }, 1500);
        
      } catch (error) {
        console.error('Failed to save snack message:', error);
        saveBtn.textContent = '‚ùå Error';
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }, 2000);
      }
    }
    
    // Function to save snack data to Firestore
    async function saveSnackDataToFirestore() {
      try {
        await ensureSignedIn();
        
        // Collect current snack data
        const snacksGrid = document.getElementById('snacksGrid');
        if (!snacksGrid) return;
        
        const snacks = [];
        snacksGrid.querySelectorAll('.p-4').forEach(card => {
          const emoji = card.querySelector('.text-xl')?.textContent || '';
          const item = card.querySelector('.snack-title')?.textContent || '';
          const claimedBy = card.querySelector('.snack-name')?.value || '';
          const checked = card.querySelector('.snack-checkbox')?.checked || false;
          const isDefault = card.getAttribute('data-default-snack') === 'true';
          if (item) {
            snacks.push({ 
              emoji: emoji, 
              item: item, 
              claimed_by: claimedBy, 
              checked: checked,
              is_default: isDefault
            });
          }
        });
        
        const snacksData = JSON.stringify(snacks);
        
        // Try to save to Firestore first
        if (typeof db !== 'undefined') {
          await db.collection('classData').doc('current').set(
            { snacks_json: snacksData }, 
            { merge: true }
          );
          console.log('Snack data saved to Firestore successfully');
        } else {
          // Fallback to localStorage for testing when Firebase is not available
          localStorage.setItem('classData_snacks_json', snacksData);
          console.log('Snack data saved to localStorage (Firebase not available)');
        }
        
      } catch (error) {
        console.error('Failed to save snack data:', error);
        // Fallback to localStorage on Firestore error
        try {
          const snacksGrid = document.getElementById('snacksGrid');
          if (snacksGrid) {
            const snacks = [];
            snacksGrid.querySelectorAll('.p-4').forEach(card => {
              const emoji = card.querySelector('.text-xl')?.textContent || '';
              const item = card.querySelector('.snack-title')?.textContent || '';
              const claimedBy = card.querySelector('.snack-name')?.value || '';
              const checked = card.querySelector('.snack-checkbox')?.checked || false;
              const isDefault = card.getAttribute('data-default-snack') === 'true';
              if (item) {
                snacks.push({ 
                  emoji: emoji, 
                  item: item, 
                  claimed_by: claimedBy, 
                  checked: checked,
                  is_default: isDefault
                });
              }
            });
            localStorage.setItem('classData_snacks_json', JSON.stringify(snacks));
            console.log('Snack data saved to localStorage as fallback');
          }
        } catch (localError) {
          console.error('Failed to save to localStorage as well:', localError);
          throw error;
        }
      }
    }
    
    // Extras tab: Add card
    function addExtrasCard() {
      // Create card directly editable on the page instead of using prompts
      const newCard = document.createElement('div');
      newCard.className = 'text-center p-8 rounded-2xl';
      newCard.style.background = 'color-mix(in oklab, var(--md-white) 70%, var(--md-mustard) 30%)';
      newCard.style.border = '1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%)';
      newCard.innerHTML = `
        <div class="text-6xl mb-4 emoji-edit" contenteditable="true" style="cursor: text;">‚ú®</div>
        <h3 class="font-semibold mb-2" contenteditable="true" style="cursor: text;">Click to edit title</h3>
        <p class="text-sm" contenteditable="true" style="cursor: text;">Click to edit description</p>
        <button class="mt-2 text-red-500 hover:text-red-700 text-xs" onclick="this.closest('.text-center').remove();" style="display: inline-block;">Remove Card</button>
      `;
      document.getElementById('extrasGrid').appendChild(newCard);
      
      // Auto-focus the title for immediate editing
      const titleEl = newCard.querySelector('h3');
      titleEl.focus();
      // Select all text for immediate editing
      if (window.getSelection && document.createRange) {
        const range = document.createRange();
        range.selectNodeContents(titleEl);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
    // Specials galleries: enhanced functionality
    function prevGalleryImg(btn) {
      const galleryContainer = btn.closest('.gallery-imgs');
      const galleryType = galleryContainer.getAttribute('data-gallery-type');
      
      const urlsStr = galleryContainer.getAttribute('data-gallery-urls');
      if (!urlsStr) return;
      
      try {
        const urls = JSON.parse(urlsStr);
        if (urls.length <= 1) return; // No navigation needed for single image
        
        let currentIndex = parseInt(galleryContainer.getAttribute('data-current-index') || '0');
        currentIndex = (currentIndex - 1 + urls.length) % urls.length;
        
        galleryContainer.setAttribute('data-current-index', currentIndex.toString());
        updateGalleryDisplay(galleryContainer, urls[currentIndex]);
      } catch (e) {
        console.error('Failed to navigate gallery:', e);
      }
    }
    
    function nextGalleryImg(btn) {
      const galleryContainer = btn.closest('.gallery-imgs');
      const galleryType = galleryContainer.getAttribute('data-gallery-type');
      
      const urlsStr = galleryContainer.getAttribute('data-gallery-urls');
      if (!urlsStr) return;
      
      try {
        const urls = JSON.parse(urlsStr);
        if (urls.length <= 1) return; // No navigation needed for single image
        
        let currentIndex = parseInt(galleryContainer.getAttribute('data-current-index') || '0');
        currentIndex = (currentIndex + 1) % urls.length;
        
        galleryContainer.setAttribute('data-current-index', currentIndex.toString());
        updateGalleryDisplay(galleryContainer, urls[currentIndex]);
      } catch (e) {
        console.error('Failed to navigate gallery:', e);
      }
    }
    
    // Delete gallery photo function
    function deleteGalleryPhoto(btn, galleryType) {
      if (!document.body.classList.contains('editing')) {
        return; // Only allow deletion in edit mode
      }
      
      if (confirm('Are you sure you want to delete this photo?')) {
        const galleryContainer = btn.closest('.gallery-imgs');
        const img = galleryContainer.querySelector('img');
        const plusIcon = galleryContainer.querySelector('.text-3xl');
        
        const urlsStr = galleryContainer.getAttribute('data-gallery-urls');
        if (urlsStr) {
          try {
            const urls = JSON.parse(urlsStr);
            const currentIndex = parseInt(galleryContainer.getAttribute('data-current-index') || '0');
            
            if (urls.length > 1) {
              // Remove current image from array
              urls.splice(currentIndex, 1);
              galleryContainer.setAttribute('data-gallery-urls', JSON.stringify(urls));
              
              // Adjust current index if needed
              let newIndex = currentIndex;
              if (newIndex >= urls.length) {
                newIndex = urls.length - 1;
              }
              galleryContainer.setAttribute('data-current-index', newIndex.toString());
              
              // Show the new current image
              updateGalleryDisplay(galleryContainer, urls[newIndex]);
              galleryContainer.setAttribute('data-gallery-url', urls[newIndex]);
            } else {
              // Last image - reset to empty state
              galleryContainer.removeAttribute('data-gallery-urls');
              galleryContainer.removeAttribute('data-current-index');
              galleryContainer.removeAttribute('data-gallery-url');
              
              if (img) {
                img.style.display = 'none';
                img.src = '';
              }
              if (plusIcon) {
                plusIcon.style.display = 'block';
              }
              btn.style.display = 'none';
            }
          } catch (e) {
            console.error('Failed to delete from gallery:', e);
          }
        } else {
          // Fallback to old behavior for single images
          if (img) {
            img.style.display = 'none';
            img.src = '';
          }
          if (plusIcon) {
            plusIcon.style.display = 'block';
          }
          btn.style.display = 'none';
          galleryContainer.removeAttribute('data-gallery-url');
        }
        
        // Show save button since we have changes
        const saveBtn = document.getElementById('saveChangesBtn');
        if (saveBtn) saveBtn.style.display = 'block';
        
        console.log(`Deleted photo from ${galleryType} gallery`);
      }
    }
    
    // Image enlargement modal functions
    function openImageModal(imageUrl) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      
      if (modal && modalImage && imageUrl) {
        modalImage.src = imageUrl;
        modal.style.display = 'flex';
        
        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
      }
    }
    
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      
      if (modal && modalImage) {
        modal.style.display = 'none';
        modalImage.src = '';
        
        // Restore body scroll
        document.body.style.overflow = '';
      }
    }
    
    // Function to make gallery images clickable for enlargement
    function makeGalleryImageClickable(img, galleryType) {
      // Only make clickable if not in edit mode and not Scholar/About Me pictures
      if (!document.body.classList.contains('editing') && 
          galleryType !== 'scholar' && 
          galleryType !== 'aboutme' && 
          img.src && img.src !== '') {
        img.style.cursor = 'pointer';
        img.onclick = function(e) {
          e.stopPropagation();
          openImageModal(img.src);
        };
      } else {
        img.style.cursor = 'default';
        img.onclick = null;
      }
    }
    
    // Add ESC key support for closing modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeImageModal();
      }
    });
    
    // Enhanced error handling helper function for uploads (global scope)
    window.handleUploadError = window.handleUploadError || function(error, context = 'upload') {
      console.error(`=== ${context.toUpperCase()} FAILED ===`);
      console.error('Error details:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      console.error('Error name:', error.name);
      
      let userMessage = `${context.charAt(0).toUpperCase() + context.slice(1)} failed: `;
      
      if (error.code) {
        switch (error.code) {
          case 'storage/unauthorized':
            userMessage += 'Permission denied. Please check Firebase storage rules.';
            break;
          case 'storage/canceled':
            userMessage += 'Upload was canceled.';
            break;
          case 'storage/unknown':
            userMessage += 'Unknown error occurred. Please try again.';
            break;
          case 'storage/invalid-format':
            userMessage += 'Invalid file format.';
            break;
          case 'storage/invalid-argument':
            userMessage += 'Invalid upload parameters.';
            break;
          case 'storage/retry-limit-exceeded':
            userMessage += 'Upload retry limit exceeded. Please try again later.';
            break;
          case 'storage/quota-exceeded':
            userMessage += 'Storage quota exceeded.';
            break;
          default:
            userMessage += `Firebase error (${error.code}): ${error.message || 'Unknown error'}`;
        }
      } else if (error.message) {
        if (error.message.includes('CORS')) {
          userMessage += 'CORS policy error. Please contact administrator.';
        } else if (error.message.includes('network')) {
          userMessage += 'Network connection error. Please check your internet connection.';
        } else if (error.message.includes('bucket')) {
          userMessage += 'Storage bucket configuration error. Please contact administrator.';
        } else {
          userMessage += error.message;
        }
      } else {
        userMessage += 'Unknown error occurred. Please try again.';
      }
      
      console.error('User message:', userMessage);
      return userMessage;
    };
    
    // Editable photo cards: file upload functionality
    function editPhoto(el) {
      // Only allow editing in edit mode
      if (!document.body.classList.contains('editing')) {
        return;
      }
      
      // Create file input
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      
      fileInput.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          // Show loading state
          el.innerHTML = '‚è≥';
          el.style.pointerEvents = 'none';
          
          // Generate unique filename
          const timestamp = Date.now();
          const fileName = `photo_${timestamp}_${file.name}`;
          
          // Upload to Firebase Storage
          const storageRef = storage.ref(`photos/${fileName}`);
          const uploadTask = await storageRef.put(file);
          const downloadURL = await uploadTask.ref.getDownloadURL();
          
          // Update the photo card display
          updatePhotoCardDisplay(el, downloadURL);
          
          // Store the photo URL in the element for later collection
          el.setAttribute('data-photo-url', downloadURL);
          
          // Show save button since we have changes
          const saveBtn = document.getElementById('saveChangesBtn');
          if (saveBtn) saveBtn.style.display = 'block';
          
        } catch (error) {
          const errorMessage = window.handleUploadError(error, 'photo upload');
          alert(errorMessage);
          // Reset to plus icon on error
          el.innerHTML = '+';
        }
        
        el.style.pointerEvents = 'auto';
        document.body.removeChild(fileInput);
      };
      
      document.body.appendChild(fileInput);
      fileInput.click();
    }
    
    // Helper function to update photo card display
    function updatePhotoCardDisplay(element, imageUrl) {
      element.innerHTML = `<img src="${imageUrl}" alt="Uploaded photo" style="width: 100%; height: 100%; object-fit: cover; border-radius: inherit;">`;
    }
    
    // Gallery photo upload functionality
    function editGalleryPhoto(el, galleryType) {
      // Only allow editing in edit mode
      if (!document.body.classList.contains('editing')) {
        return;
      }
      
      // Create file input
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      
      fileInput.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          // Show loading state
          const originalContent = el.innerHTML;
          el.innerHTML = '<span class="text-3xl text-gray-400">‚è≥</span>';
          el.style.pointerEvents = 'none';
          
          // Generate unique filename
          const timestamp = Date.now();
          const fileName = `gallery_${galleryType}_${timestamp}_${file.name}`;
          
          // Upload to Firebase Storage
          const storageRef = storage.ref(`galleries/${fileName}`);
          const uploadTask = await storageRef.put(file);
          const downloadURL = await uploadTask.ref.getDownloadURL();
          
          // Update the gallery display
          updateGalleryDisplay(el, downloadURL);
          
          // Add the photo URL to the array for later collection
          const urlsStr = el.getAttribute('data-gallery-urls');
          let urls = [];
          if (urlsStr) {
            try {
              urls = JSON.parse(urlsStr);
            } catch (e) {
              urls = [];
            }
          }
          urls.push(downloadURL);
          
          el.setAttribute('data-gallery-urls', JSON.stringify(urls));
          el.setAttribute('data-current-index', (urls.length - 1).toString());
          
          // Keep legacy attribute for backward compatibility
          el.setAttribute('data-gallery-url', downloadURL);
          
          // Show save button since we have changes
          const saveBtn = document.getElementById('saveChangesBtn');
          if (saveBtn) saveBtn.style.display = 'block';
          
        } catch (error) {
          const errorMessage = window.handleUploadError(error, 'gallery photo upload');
          alert(errorMessage);
          // Reset to plus icon on error
          el.innerHTML = '<span class="text-3xl text-gray-400">+</span>';
        }
        
        el.style.pointerEvents = 'auto';
        document.body.removeChild(fileInput);
      };
      
      document.body.appendChild(fileInput);
      fileInput.click();
    }
    
    // Helper function to update gallery display
    function updateGalleryDisplay(element, imageUrl) {
      const img = element.querySelector('img');
      const plusSpan = element.querySelector('span');
      
      if (img && plusSpan) {
        img.src = imageUrl;
        img.style.display = 'block';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        plusSpan.style.display = 'none';
        
        // Make image clickable for enlargement
        const galleryType = element.getAttribute('data-gallery-type');
        makeGalleryImageClickable(img, galleryType);
      }
    }
    // School calendar link edit
    function editSchoolCalendarLink(event, linkElement) {
      if (document.body.classList.contains('editing')) {
        event.preventDefault();
        const newUrl = prompt('Enter school calendar URL:', linkElement.href);
        if (newUrl) linkElement.href = newUrl;
      }
    }
  </script>

  <!-- Firebase Firestore Integration Script -->
  <script>
// Utility: Parse JSON fields from string or array
function parseArray(val) {
  if (!val) return [];
  if (Array.isArray(val)) return val;
  try { return JSON.parse(val); } catch { return []; }
}

// --- Section Updaters (these match your new sheet keys) ---
function updateWeekText(week) {
  const el = document.getElementById('weekText');
  if (el && week) el.textContent = week;
}
function updateRecapText(recap) {
  const el = document.getElementById('recapText');
  if (el && recap) el.textContent = recap;
}
function updateEventsList(dates_json) {
  const eventsContainer = document.getElementById('eventsList');
  if (!eventsContainer) return;
  const arr = parseArray(dates_json);
  eventsContainer.innerHTML = '';
  arr.forEach(ev => {
    const icon = ev.icon || 'üìå';
    const text = ev.text || '';
    const div = document.createElement('div');
    div.className = 'event-item flex items-center gap-3 p-3 rounded-xl bg-yellow-50 border';
    div.style.borderColor = 'var(--md-mustard)';
    div.innerHTML = `
      <span class="event-emoji text-xl" data-edit="teacher" contenteditable="false">${icon}</span>
      <span class="event-text font-semibold flex-1" data-edit="teacher" contenteditable="false">${text}</span>
      <button class="edit-only text-red-500 hover:text-red-700" onclick="this.parentNode.remove()">‚úñ</button>
    `;
    eventsContainer.appendChild(div);
  });
}
function updateLookingAhead(lookingAhead) {
  const section = Array.from(document.querySelectorAll('div.rounded-2xl')).find(div =>
    div.querySelector('h3') && div.querySelector('h3').textContent.includes('Looking Ahead')
  );
  if (!section) return;
  const ul = section.querySelector('ul[data-edit="teacher"]');
  if (!ul) return;
  let arr = [];
  if (Array.isArray(lookingAhead)) arr = lookingAhead;
  else if (typeof lookingAhead === 'string') arr = lookingAhead.split(/\r?\n/).filter(x=>x.trim());
  ul.innerHTML = '';
  arr.forEach(item => {
    const li = document.createElement('li');
    li.textContent = '‚Ä¢ ' + item;
    ul.appendChild(li);
  });
}
function updateSnacksGrid(snacks_json) {
  const snacksContainer = document.getElementById('snacksGrid');
  if (!snacksContainer) return;
  
  // Don't clear the container, as we want to preserve the default cards
  // Instead, only remove user-added cards and update existing ones
  const userAddedCards = snacksContainer.querySelectorAll('.user-added-snack-card');
  userAddedCards.forEach(card => card.remove());
  
  const arr = parseArray(snacks_json);
  
  // First, update default cards with their claimed status
  const defaultCards = snacksContainer.querySelectorAll('.default-snack-card');
  arr.forEach((snack, index) => {
    if (snack.is_default && defaultCards[index]) {
      const card = defaultCards[index];
      const checkbox = card.querySelector('.snack-checkbox');
      const nameInput = card.querySelector('.snack-name');
      const saveButton = card.querySelector('button[onclick*="claimSnack"]');
      const title = card.querySelector('.snack-title');
      
      // Update title (only for teachers in edit mode)
      if (title && snack.item) {
        title.textContent = snack.item;
      }
      
      // Update claimed status
      if (checkbox) {
        checkbox.checked = snack.checked || false;
      }
      if (nameInput) {
        nameInput.value = snack.claimed_by || '';
        nameInput.disabled = !snack.checked;
      }
      if (saveButton) {
        saveButton.disabled = !snack.checked;
      }
      
      // Update visual styling
      if (snack.claimed_by && snack.checked) {
        card.classList.add('snack-claimed');
        card.style.backgroundColor = 'rgba(224, 177, 74, 0.1)';
      } else {
        card.classList.remove('snack-claimed');
        card.style.backgroundColor = 'white';
      }
    }
  });
  
  // Then, add user-added cards
  arr.forEach((snack, index) => {
    if (!snack.is_default) {
      const emoji = snack.emoji || 'üçé';
      const item = snack.item || '';
      const claimed = snack.claimed_by || '';
      const checked = snack.checked || false;
      const div = document.createElement('div');
      div.className = 'p-4 rounded-xl bg-white user-added-snack-card';
      div.setAttribute('data-default-snack', 'false');
      div.style.border = '1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%)';
      const tabIndexBase = (index * 3) + 13; // Start after default cards
      div.innerHTML = `
        <div class="flex items-center gap-3 mb-3">
          <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="${tabIndexBase}" ${checked ? 'checked' : ''}>
          <span class="text-xl" contenteditable="true" style="cursor: text;">${emoji}</span>
          <span class="font-medium snack-title" contenteditable="true" style="cursor: text;">${item}</span>
        </div>
        <div class="flex items-center gap-2">
          <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" value="${claimed}" ${checked ? '' : 'disabled'} tabindex="${tabIndexBase + 1}">
          <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" ${checked ? '' : 'disabled'} tabindex="${tabIndexBase + 2}">Save</button>
          <button class="text-gray-400 hover:text-red-500" onclick="this.closest('.p-4').remove()">‚úñ</button>
        </div>
      `;
      snacksContainer.appendChild(div);
      
      // Add claimed styling if needed
      if (claimed && checked) {
        div.classList.add('snack-claimed');
        div.style.backgroundColor = 'rgba(224, 177, 74, 0.1)';
      }
    }
  });
}
function updateSnackMessage(snack_message) {
  const messageEl = document.getElementById('snackMessage');
  if (messageEl && snack_message) {
    messageEl.value = snack_message;
  }
}
function updateScholarInfo(scholar_name, scholar_blurb) {
  const nameEl = document.querySelector('[data-page-panel="scholar"] h3[data-edit="teacher"]');
  const descEl = document.querySelector('[data-page-panel="scholar"] p[data-edit="teacher"]');
  if (nameEl && scholar_name) nameEl.textContent = scholar_name;
  if (descEl && scholar_blurb) descEl.textContent = scholar_blurb;
}
function updateSkillsSection(skills_text, sounds_json) {
  const descEl = document.querySelector('[data-page-panel="skills"] p[data-edit="teacher"]');
  const vocabUl = document.querySelector('[data-page-panel="skills"] ul[data-edit="teacher"]');
  if (descEl && skills_text) descEl.textContent = skills_text;
  if (vocabUl && sounds_json) {
    const arr = parseArray(sounds_json);
    vocabUl.innerHTML = '';
    arr.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      vocabUl.appendChild(li);
    });
  }
}
function updateListeningSection(listening_text, ask_json) {
  const descEl = document.querySelector('[data-page-panel="listening"] p[data-edit="teacher"]');
  const ul = document.querySelector('[data-page-panel="listening"] ul[data-edit="teacher"]');
  if (descEl && listening_text) descEl.textContent = listening_text;
  if (ul && ask_json) {
    const arr = parseArray(ask_json);
    ul.innerHTML = '';
    arr.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      ul.appendChild(li);
    });
  }
}
function updateMathSection(math_text, math_vocab_json) {
  const descEl = document.querySelector('[data-page-panel="math"] p[data-edit="teacher"]');
  const ul = document.querySelector('[data-page-panel="math"] ul[data-edit="teacher"]');
  if (descEl && math_text) descEl.textContent = math_text;
  if (ul && math_vocab_json) {
    const arr = parseArray(math_vocab_json);
    ul.innerHTML = '';
    arr.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      ul.appendChild(li);
    });
  }
}
function updateExtrasSection(extras_json) {
  const extrasContainer = document.getElementById('extrasGrid');
  if (!extrasContainer) return;
  const arr = parseArray(extras_json);
  extrasContainer.innerHTML = '';
  arr.forEach(extra => {
    const emoji = extra.emoji || '‚ú®';
    const title = extra.title || '';
    const body_html = extra.body_html || '';
    const div = document.createElement('div');
    div.className = 'text-center p-8 rounded-2xl';
    div.style.background = 'color-mix(in oklab, var(--md-white) 70%, var(--md-mustard) 30%)';
    div.style.border = '1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%)';
    div.innerHTML = `
      <div class="text-6xl mb-4 emoji-edit" contenteditable="true" style="cursor: text;">${emoji}</div>
      <h3 class="font-semibold mb-2" contenteditable="true" style="cursor: text;">${title}</h3>
      <p class="text-sm" contenteditable="true" style="cursor: text;">${body_html}</p>
      <button class="mt-2 text-red-500 hover:text-red-700 text-xs" onclick="this.closest('.text-center').remove();" style="display: none;">Remove Card</button>
    `;
    extrasContainer.appendChild(div);
  });
}
function updateAboutMeSection(data) {
  if (!data) return;
  
  // Update favorite fields by ID
  const favoriteColorEl = document.getElementById('favoriteColorText');
  if (favoriteColorEl && data.favorite_color) favoriteColorEl.textContent = data.favorite_color;
  
  const favoriteSnackEl = document.getElementById('favoriteSnackText');
  if (favoriteSnackEl && data.favorite_snack) favoriteSnackEl.textContent = data.favorite_snack;
  
  const favoriteDrinkEl = document.getElementById('favoriteDrinkText');
  if (favoriteDrinkEl && data.favorite_drink) favoriteDrinkEl.textContent = data.favorite_drink;
  
  const favoriteShowEl = document.getElementById('favoriteShowText');
  if (favoriteShowEl && data.favorite_show) favoriteShowEl.textContent = data.favorite_show;
  
  // Update about me description
  const aboutDescEl = document.getElementById('aboutMeDescText');
  if (aboutDescEl && data.about_me_html) {
    aboutDescEl.innerHTML = data.about_me_html;
  }
  
  // Update fun facts list
  const factsUl = document.getElementById('funFactsList');
  if (factsUl && data.fun_facts_html) {
    if (Array.isArray(data.fun_facts_html)) {
      factsUl.innerHTML = '';
      data.fun_facts_html.forEach(fact => {
        const li = document.createElement('li');
        li.textContent = fact;
        factsUl.appendChild(li);
      });
    } else {
      factsUl.innerHTML = data.fun_facts_html;
    }
  }
  
  // Update profile photos
  const scholarProfileEl = document.querySelector('[onclick*="scholar"]');
  if (scholarProfileEl && data.scholar_profile_url) {
    scholarProfileEl.innerHTML = `<img src="${data.scholar_profile_url}" alt="Scholar Profile" style="width:100%; height:100%; object-fit:cover;">`;
    scholarProfileEl.setAttribute('data-profile-url', data.scholar_profile_url);
  }
  
  const aboutMeProfileEl = document.querySelector('[onclick*="aboutme"]');
  if (aboutMeProfileEl && data.about_me_profile_url) {
    aboutMeProfileEl.innerHTML = `<img src="${data.about_me_profile_url}" alt="About Me Profile" style="width:100%; height:100%; object-fit:cover;">`;
    aboutMeProfileEl.setAttribute('data-profile-url', data.about_me_profile_url);
  }
}
function populateDataFromSheet(data) {
  // Always populate with either real data or fallback content
  if (!data) {
    console.log('Using fallback content due to missing data');
    data = getDefaultFallbackData();
  }
  
  updateWeekText(data.week);
  updateRecapText(data.recap);
  updateEventsList(data.dates_json);
  updateLookingAhead(data.looking_ahead);
  updateSnacksGrid(data.snacks_json);
  updateSnackMessage(data.snack_message);
  updateScholarInfo(data.scholar_name, data.scholar_blurb);
  updateSkillsSection(data.skills_text, data.sounds_json);
  updateListeningSection(data.listening_text, data.ask_json);
  updateMathSection(data.math_text, data.math_vocab_json);
  updateExtrasSection(data.extras_json);
  updateAboutMeSection(data);
  
  // Load photo cards
  updatePhotoCards(data.photo_urls_json);
  
  // Load gallery photos
  updateGalleryPhotos(data.gallery_urls_json);
  
  // Load transportation data
  updateTransportationFields(data);
  
  // Load birthday data
  updateBirthdayFields(data);
  
  // Load website URLs
  updateWebsiteCards(data.websites_json);
  
  if (data.calendar_url) {
    const cal = document.getElementById('schoolCalendarLink');
    if (cal) cal.href = data.calendar_url;
  }
}

// Function to update photo cards with saved URLs
function updatePhotoCards(photoUrlsJson) {
  if (!photoUrlsJson) return;
  
  let photoUrls = [];
  try {
    photoUrls = JSON.parse(photoUrlsJson);
  } catch (e) {
    console.error('Failed to parse photo URLs:', e);
    return;
  }
  
  const photoCards = document.querySelectorAll('.photo-card');
  photoCards.forEach((card, index) => {
    const url = photoUrls[index];
    if (url) {
      card.setAttribute('data-photo-url', url);
      updatePhotoCardDisplay(card, url);
    }
  });
}

// Function to update gallery photos with saved URLs
function updateGalleryPhotos(galleryUrlsJson) {
  if (!galleryUrlsJson) return;
  
  let galleryUrls = {};
  try {
    galleryUrls = JSON.parse(galleryUrlsJson);
  } catch (e) {
    console.error('Failed to parse gallery URLs:', e);
    return;
  }
  
  ['art', 'stem', 'gym', 'music'].forEach(type => {
    const galleryData = galleryUrls[type];
    if (galleryData) {
      const galleryEl = document.querySelector(`[data-gallery-type="${type}"]`);
      if (galleryEl) {
        // Support both old format (single URL) and new format (array of URLs)
        let urls = [];
        if (typeof galleryData === 'string') {
          // Old format - single URL
          urls = [galleryData];
        } else if (Array.isArray(galleryData)) {
          // New format - array of URLs
          urls = galleryData;
        }
        
        if (urls.length > 0) {
          galleryEl.setAttribute('data-gallery-urls', JSON.stringify(urls));
          galleryEl.setAttribute('data-current-index', '0');
          updateGalleryDisplay(galleryEl, urls[0]);
        }
      }
    }
  });
}

// Function to update transportation fields with saved data
function updateTransportationFields(data) {
  if (!data) return;
  
  const busRidersEl = document.getElementById('busRidersTextarea');
  if (busRidersEl && data.bus_riders) {
    busRidersEl.value = data.bus_riders;
  }
  
  const carRidersEl = document.getElementById('carRidersTextarea');
  if (carRidersEl && data.car_riders) {
    carRidersEl.value = data.car_riders;
  }
  
  const porchPickupEl = document.getElementById('porchPickupTextarea');
  if (porchPickupEl && data.porch_pickup) {
    porchPickupEl.value = data.porch_pickup;
  }
}

// Function to save individual transportation fields
async function saveTransportationField(fieldType) {
  const buttonMap = {
    'busRiders': 'saveBusRidersBtn',
    'carRiders': 'saveCarRidersBtn', 
    'porchPickup': 'savePorchPickupBtn'
  };
  
  const textareaMap = {
    'busRiders': 'busRidersTextarea',
    'carRiders': 'carRidersTextarea',
    'porchPickup': 'porchPickupTextarea'
  };
  
  const dataMap = {
    'busRiders': 'bus_riders',
    'carRiders': 'car_riders',
    'porchPickup': 'porch_pickup'
  };
  
  const saveBtn = document.getElementById(buttonMap[fieldType]);
  const textarea = document.getElementById(textareaMap[fieldType]);
  
  if (!saveBtn || !textarea) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    await ensureSignedIn();
    
    // Show saving state
    saveBtn.textContent = '‚è≥ Saving...';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {};
    data[dataMap[fieldType]] = textarea.value || '';
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = '‚úÖ Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save transportation field:', error);
    saveBtn.textContent = '‚ùå Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to update birthday fields with saved data
function updateBirthdayFields(data) {
  if (!data) return;
  
  // Update class roster
  const classRosterEl = document.getElementById('classRosterTextarea');
  if (classRosterEl && data.class_roster) {
    classRosterEl.value = data.class_roster;
  }
  
  // Update monthly birthdays
  const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                  'july', 'august', 'september', 'october', 'november', 'december'];
  months.forEach(month => {
    const monthEl = document.getElementById(`${month}BirthdaysTextarea`);
    if (monthEl && data[`${month}_birthdays`]) {
      monthEl.value = data[`${month}_birthdays`];
    }
  });
}

// Function to update website cards with saved URLs
function updateWebsiteCards(websitesJson) {
  if (!websitesJson) return;
  
  let websites = [];
  try {
    websites = JSON.parse(websitesJson);
  } catch (e) {
    console.error('Failed to parse websites JSON:', e);
    return;
  }
  
  const websiteCards = document.querySelectorAll('.website-card');
  websiteCards.forEach((card, index) => {
    const website = websites[index];
    if (website && website.url) {
      const urlInput = card.querySelector('.website-url-input');
      const linkEl = card.querySelector('.website-link');
      const titleEl = card.querySelector('.website-title');
      
      if (urlInput) urlInput.value = website.url;
      if (linkEl) linkEl.href = website.url;
      if (titleEl && website.title) titleEl.textContent = website.title;
    }
  });
}

// Function to save individual birthday fields
async function saveBirthdayField(fieldType) {
  const saveBtn = document.getElementById('saveClassRosterBtn');
  const textarea = document.getElementById('classRosterTextarea');
  
  if (!saveBtn || !textarea) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    await ensureSignedIn();
    
    // Show saving state
    saveBtn.textContent = '‚è≥ Saving...';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {};
    data.class_roster = textarea.value || '';
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = '‚úÖ Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save birthday field:', error);
    saveBtn.textContent = '‚ùå Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to save all birthday fields at once
async function saveAllBirthdays() {
  const saveBtn = document.getElementById('saveAllBirthdaysBtn');
  
  if (!saveBtn) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    await ensureSignedIn();
    
    // Show saving state
    saveBtn.textContent = '‚è≥ Saving...';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {};
    
    // Collect all monthly birthday data
    const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                    'july', 'august', 'september', 'october', 'november', 'december'];
    months.forEach(month => {
      const monthEl = document.getElementById(`${month}BirthdaysTextarea`);
      if (monthEl) {
        data[`${month}_birthdays`] = monthEl.value || '';
      }
    });
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = '‚úÖ Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save birthday fields:', error);
    saveBtn.textContent = '‚ùå Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to save individual About Me fields
async function saveAboutMeField(fieldType) {
  const fieldMap = {
    'aboutMeDesc': {
      button: 'saveAboutMeDescBtn',
      element: 'aboutMeDescText',
      dataField: 'about_me_html',
      getContent: (el) => el.innerHTML || ''
    },
    'funFacts': {
      button: 'saveFunFactsBtn', 
      element: 'funFactsList',
      dataField: 'fun_facts_html',
      getContent: (el) => {
        const listItems = Array.from(el.querySelectorAll('li')).map(li => li.textContent || '');
        return listItems;
      }
    },
    'favoriteColor': {
      button: 'saveFavoriteColorBtn',
      element: 'favoriteColorText', 
      dataField: 'favorite_color',
      getContent: (el) => el.textContent || ''
    },
    'favoriteSnack': {
      button: 'saveFavoriteSnackBtn',
      element: 'favoriteSnackText',
      dataField: 'favorite_snack', 
      getContent: (el) => el.textContent || ''
    },
    'favoriteDrink': {
      button: 'saveFavoriteDrinkBtn',
      element: 'favoriteDrinkText',
      dataField: 'favorite_drink',
      getContent: (el) => el.textContent || ''
    },
    'favoriteShow': {
      button: 'saveFavoriteShowBtn',
      element: 'favoriteShowText',
      dataField: 'favorite_show',
      getContent: (el) => el.textContent || ''
    }
  };
  
  const field = fieldMap[fieldType];
  if (!field) return;
  
  const saveBtn = document.getElementById(field.button);
  const element = document.getElementById(field.element);
  
  if (!saveBtn || !element) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    await ensureSignedIn();
    
    // Show saving state
    saveBtn.textContent = '‚è≥';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {};
    data[field.dataField] = field.getContent(element);
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = '‚úÖ';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save About Me field:', error);
    saveBtn.textContent = '‚ùå';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to save all extras cards
async function saveExtrasCards() {
  const saveBtn = document.getElementById('saveExtrasBtn');
  
  if (!saveBtn) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    await ensureSignedIn();
    
    // Show saving state
    saveBtn.textContent = '‚è≥ Saving...';
    saveBtn.disabled = true;
    
    // Collect extras data
    const extrasGrid = document.getElementById('extrasGrid');
    const extras = [];
    
    if (extrasGrid) {
      extrasGrid.querySelectorAll('.text-center').forEach(card => {
        const emojiEl = card.querySelector('.emoji-edit');
        const titleEl = card.querySelector('h3');
        const bodyEl = card.querySelector('p');
        
        if (titleEl && bodyEl) {
          extras.push({
            emoji: emojiEl ? emojiEl.textContent || '‚ú®' : '‚ú®',
            title: titleEl.textContent || '',
            body_html: bodyEl.textContent || ''
          });
        }
      });
    }
    
    // Prepare data for saving
    const data = {
      extras_json: JSON.stringify(extras)
    };
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = '‚úÖ Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save extras cards:', error);
    saveBtn.textContent = '‚ùå Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to save website URLs
async function saveWebsiteUrls() {
  const saveBtn = document.getElementById('saveWebsitesBtn');
  
  if (!saveBtn) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    await ensureSignedIn();
    
    // Show saving state
    saveBtn.textContent = '‚è≥ Saving...';
    saveBtn.disabled = true;
    
    // Collect website data
    const websiteCards = document.querySelectorAll('.website-card');
    const websites = [];
    
    websiteCards.forEach(card => {
      const titleEl = card.querySelector('.website-title');
      const urlInput = card.querySelector('.website-url-input');
      const linkEl = card.querySelector('.website-link');
      
      if (titleEl && urlInput) {
        websites.push({
          title: titleEl.textContent || '',
          url: urlInput.value || linkEl?.href || ''
        });
      }
    });
    
    // Prepare data for saving
    const data = {
      websites_json: JSON.stringify(websites)
    };
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = '‚úÖ Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save website URLs:', error);
    saveBtn.textContent = '‚ùå Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Error display functions
function showDataLoadError(message) {
  // Only show error banner to users in edit mode (teachers/admins)
  // Regular visitors (parents/students) should not see Firebase connection issues
  if (!document.body.classList.contains('editing')) {
    console.log(`Data load notice (hidden from visitors): ${message}`);
    return;
  }
  
  // Create or update error banner for teachers/admins only
  let errorBanner = document.getElementById('dataLoadError');
  if (!errorBanner) {
    errorBanner = document.createElement('div');
    errorBanner.id = 'dataLoadError';
    errorBanner.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #f56565;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 1000;
      font-weight: bold;
    `;
    document.body.insertBefore(errorBanner, document.body.firstChild);
  }
  errorBanner.textContent = `‚ö†Ô∏è ${message}`;
  errorBanner.style.display = 'block';
}

function hideDataLoadError() {
  const errorBanner = document.getElementById('dataLoadError');
  if (errorBanner) {
    errorBanner.style.display = 'none';
  }
}

// Default fallback data when Firestore is unavailable
function getDefaultFallbackData() {
  return {
    week: "Week of September 1‚Äì5",
    recap: "This week we explored magical stories and practiced our sight words. The students loved reading about brave characters and sharing their favorite parts! We also worked on counting by 5s and 10s using fun games and manipulatives. Our art projects focused on fall colors and textures - the students created beautiful leaf collages and practiced writing descriptive words.",
    dates_json: JSON.stringify([
      { icon: "üéÉ", text: "Halloween Party - October 31st at 2pm" },
      { icon: "ü¶É", text: "Thanksgiving Break - November 23-27" }
    ]),
    looking_ahead: [
      "Field trip permission slips due",
      "Parent-teacher conferences", 
      "Winter concert practice begins"
    ],
    snacks_json: JSON.stringify([
      { emoji: "ü•Ø", item: "Breakfast Bars", claimed_by: "", checked: false, is_default: true },
      { emoji: "üç¨", item: "Gummies", claimed_by: "", checked: false, is_default: true },
      { emoji: "üçö", item: "Rice Krispy Treats", claimed_by: "", checked: false, is_default: true },
      { emoji: "üßÉ", item: "Juice", claimed_by: "", checked: false, is_default: true }
    ]),
    snack_message: "Snacks help keep our energy up during learning time and teach us about sharing and community!",
    scholar_name: "Scholar of the Week",
    scholar_blurb: "Our scholar will be announced soon!",
    skills_text: "This week we focused on phonics and reading skills.",
    sounds_json: JSON.stringify(["ch", "sh", "th", "wh"]),
    listening_text: "We practiced active listening and following directions.",
    ask_json: JSON.stringify(["What is the main idea?", "How do you know?", "What evidence supports this?"]),
    math_text: "We explored numbers and counting patterns.",
    math_vocab_json: JSON.stringify(["add", "subtract", "count", "pattern"]),
    extras_json: JSON.stringify([]),
    about_me_html: "Welcome to our classroom!",
    fun_facts_html: ["I love teaching first grade!", "Reading is my favorite subject", "I enjoy outdoor activities"],
    photo_urls_json: JSON.stringify([]),
    gallery_urls_json: JSON.stringify({}),
    calendar_url: "#"
  };
}

async function fetchFirestoreData() {
  try {
    // Check if Firebase is available
    if (typeof db === 'undefined') {
      console.error('Firebase not available - checking localStorage fallback');
      // Check if we have saved snack data in localStorage
      const savedSnacksData = localStorage.getItem('classData_snacks_json');
      if (savedSnacksData) {
        const fallbackData = getDefaultFallbackData();
        fallbackData.snacks_json = savedSnacksData;
        console.log('Using localStorage fallback data for snacks');
        showDataLoadError('Firebase connection not available - using saved local data');
        return fallbackData;
      } else {
        showDataLoadError('Firebase connection not available');
        return null;
      }
    }
    
    const doc = await db.collection('classData').doc('current').get();
    if (doc.exists) {
      hideDataLoadError(); // Hide any previous error messages
      return doc.data();
    } else {
      console.log('No document found, using defaults');
      showDataLoadError('No saved data found - showing default content');
      return null;
    }
  } catch (e) {
    console.error('Failed to fetch Firestore data:', e);
    showDataLoadError('Unable to load data from server - showing default content');
    return null;
  }
}
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(async () => {
    try {
      const data = await fetchFirestoreData();
      populateDataFromSheet(data);
    } catch (error) {
      console.error('Error during initial data load:', error);
      showDataLoadError('Failed to load content - showing default content');
      populateDataFromSheet(null); // This will trigger fallback data
    }
  }, 350);
});
setInterval(async () => {
  try {
    const data = await fetchFirestoreData();
    populateDataFromSheet(data);
  } catch (error) {
    console.error('Error during periodic data refresh:', error);
    // Don't show error for periodic refreshes, just log it
  }
}, 300000);

// New JavaScript functions for enhanced functionality

// Profile photo upload functionality
function editProfilePhoto(el, section) {
  // Only allow editing in edit mode with PIN
  if (!document.body.classList.contains('editing')) {
    return;
  }
  
  // Create file input
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.style.display = 'none';
  
  fileInput.onchange = async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      // Show loading state
      el.innerHTML = '‚è≥';
      el.style.pointerEvents = 'none';
      
      // Generate unique filename
      const timestamp = Date.now();
      const fileName = `profile_${section}_${timestamp}_${file.name}`;
      
      // Upload to Firebase Storage
      const storageRef = storage.ref(`profiles/${fileName}`);
      const uploadTask = await storageRef.put(file);
      const downloadURL = await uploadTask.ref.getDownloadURL();
      
      // Update the display
      el.innerHTML = `<img src="${downloadURL}" alt="Profile" style="width:100%; height:100%; object-fit:cover;">`;
      el.style.pointerEvents = 'auto';
      
      // Store the photo URL for later collection
      el.setAttribute('data-profile-url', downloadURL);
      
      // Show save button since we have changes
      const saveBtn = document.getElementById('saveChangesBtn');
      if (saveBtn) saveBtn.style.display = 'block';
      
    } catch (error) {
      const errorMessage = window.handleUploadError(error, 'profile photo upload');
      alert(errorMessage);
      // Reset on error
      el.innerHTML = '';
      el.style.pointerEvents = 'auto';
    }
    
    document.body.removeChild(fileInput);
  };
  
  document.body.appendChild(fileInput);
  fileInput.click();
}

// Confetti animation for celebrate button
function triggerConfetti() {
  // Create confetti container
  const confettiContainer = document.createElement('div');
  confettiContainer.style.position = 'fixed';
  confettiContainer.style.top = '0';
  confettiContainer.style.left = '0';
  confettiContainer.style.width = '100%';
  confettiContainer.style.height = '100%';
  confettiContainer.style.pointerEvents = 'none';
  confettiContainer.style.zIndex = '9999';
  
  // Create multiple confetti pieces with more variety and flow
  const colors = ['#E0B14A', '#E9867D', '#F2C9BE', '#7B8E9E', '#F7EFE2'];
  const emojis = ['üéâ', 'üåü', '‚ú®', 'üéä', 'üéà', 'üèÜ', '‚≠ê', 'üí´', 'üéØ'];
  
  // Create more confetti pieces for a fuller effect
  for (let i = 0; i < 80; i++) {
    const confetti = document.createElement('div');
    confetti.style.position = 'absolute';
    confetti.style.fontSize = Math.random() * 10 + 15 + 'px'; // Vary sizes
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.top = '-50px'; // Start above the screen
    
    // Add random horizontal drift for more flowy movement
    const drift = (Math.random() - 0.5) * 200; // -100px to +100px drift
    const fallDuration = Math.random() * 2 + 3; // 3-5 seconds fall time
    const rotationSpeed = Math.random() * 720 + 360; // 360-1080 degrees
    
    confetti.style.animationDuration = fallDuration + 's';
    confetti.style.animationDelay = Math.random() * 1.5 + 's'; // Stagger the start
    confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    
    // Enhanced falling animation with drift and rotation
    confetti.style.animation = `confettiFlowFall ${fallDuration}s ease-in forwards`;
    confetti.style.setProperty('--drift', drift + 'px');
    confetti.style.setProperty('--rotation', rotationSpeed + 'deg');
    
    confettiContainer.appendChild(confetti);
  }
  
  document.body.appendChild(confettiContainer);
  
  // Remove confetti after animation
  setTimeout(() => {
    if (document.body.contains(confettiContainer)) {
      document.body.removeChild(confettiContainer);
    }
  }, 7000);
}

// Website URL update functionality  
function updateWebsiteUrl(input) {
  const websiteCard = input.closest('.website-card');
  const link = websiteCard.querySelector('.website-link');
  if (link && input.value) {
    link.href = input.value;
    
    // Show save button since we have changes
    const saveBtn = document.getElementById('saveChangesBtn');
    if (saveBtn) saveBtn.style.display = 'block';
  }
}

// Add CSS for confetti animation
const style = document.createElement('style');
style.textContent = `
  @keyframes confettiFlowFall {
    0% {
      transform: translateY(-100vh) translateX(0) rotate(0deg);
      opacity: 1;
    }
    25% {
      opacity: 1;
    }
    75% {
      opacity: 0.8;
    }
    100% {
      transform: translateY(100vh) translateX(var(--drift)) rotate(var(--rotation));
      opacity: 0;
    }
  }
  
  @keyframes confettiFall {
    0% {
      transform: translateY(-100vh) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translateY(100vh) rotate(720deg);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);
  </script>
  
  <!-- Image Enlargement Modal -->
  <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;" onclick="closeImageModal()">
    <div style="position: relative; max-width: 90%; max-height: 90%; display: flex; justify-content: center; align-items: center;">
      <img id="modalImage" src="" alt="Enlarged view" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);">
      <button onclick="closeImageModal()" style="position: absolute; top: -40px; right: -40px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;" title="Close">‚úï</button>
    </div>
  </div>
</body>
</html>
