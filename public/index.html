<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hey Hey First Grade! - Mr. Davis's Class</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['"Poppins"','ui-sans-serif','system-ui'],
            body: ['"Inter"','ui-sans-serif','system-ui'],
          },
          colors: {
            brand: {
              mustard:'#E0B14A', slate:'#7B8E9E', coral:'#E9867D',
              blush:'#F2C9BE', cream:'#F7EFE2', pebble:'#E6D5B8',
              ink:'#2B2B2B', white:'#FFFFFF'
            }
          },
          boxShadow:{ soft:'0 10px 30px rgba(43,43,43,0.10)' }
        }
      }
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600;700;800&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBVFcyBYlz3DmCkOervIswwjPf6wwFZlhU",
      authDomain: "first-grade-news-hub.firebaseapp.com",
      projectId: "first-grade-news-hub",
      storageBucket: "first-grade-news-hub.firebasestorage.app",
      messagingSenderId: "472215115326",
      appId: "1:472215115326:web:0d1f2cb7c1d5615676636f",
      measurementId: "G-5SF4RE6KLS"
    };
    // Initialize Firebase with error handling
    let db, auth, storage;
    try {
      firebase.initializeApp(firebaseConfig);
      try { firebase.analytics(); } catch (e) { console.warn('Firebase analytics failed:', e); }
      db = firebase.firestore();
      auth = firebase.auth();
      storage = firebase.storage();
      console.log('Firebase initialized successfully');
    } catch (e) {
      console.error('Firebase initialization failed:', e);
      // Set db to undefined so we can check for it later
      db = undefined;
      auth = undefined;
      storage = undefined;
    }
    
    // Helper function to check authentication before Firestore writes
    async function ensureAuthenticated() {
      if (!auth) {
        throw new Error('Firebase authentication not available');
      }
      if (!auth.currentUser) {
        throw new Error('User not authenticated. Please enter edit mode first.');
      }
      return true;
    }
  </script>
  
  <style>
    :root{
      --md-mustard:#E0B14A; --md-slate:#7B8E9E; --md-coral:#E9867D;
      --md-blush:#F2C9BE; --md-cream:#F7EFE2; --md-pebble:#E6D5B8;
      --md-ink:#2B2B2B; --md-white:#FFFFFF;
      --hdr-bg: var(--md-mustard);
      --card-bg: var(--md-cream);
    }
    
    /* Modern Dark Mode Variables */
    body.dark {
      --md-mustard: #F4D03F; /* Lighter mustard for dark mode */
      --md-slate: #85929E; /* Lighter slate for dark mode */
      --md-coral: #F1948A; /* Lighter coral for dark mode */
      --md-blush: #F8C4B4; /* Lighter blush for dark mode */
      --md-cream: #1A1D23; /* Dark background for cards */
      --md-pebble: #C8B99C; /* Lighter pebble for dark mode */
      --md-ink: #E8E8E8; /* Light text for dark mode */
      --md-white: #2C3E50; /* Dark surface for dark mode */
      --hdr-bg: #2C3E50; /* Dark header background */
      --card-bg: #1A1D23; /* Dark card background */
    }
    .fade-in{opacity:0;transform:translateY(8px);transition:opacity .35s,transform .35s}
    .fade-in.visible{opacity:1;transform:translateY(0)}
    .pagePanel{display:none}
    .pagePanel.active{display:block}
    .edit-only{display:none!important}
    body.editing .edit-only{display:inline-flex!important}
    body.editing [data-edit="teacher"][contenteditable="true"]{outline:2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent);outline-offset:4px;border-radius:.5rem}
    .teacher-only-edit:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
    body.editing .teacher-only-edit:not(:disabled) {
      background-color: white; color: var(--md-ink); cursor: text;
      outline: 2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent); outline-offset: 2px;
    }
    /* Hide Practice Website URL inputs when not in edit mode */
    .website-url-input { display: none; }
    body.editing .website-url-input { display: block; }
    /* Website card drag-and-drop styles */
    .website-card[draggable="true"] {
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .website-card[draggable="true"]:hover {
      transform: scale(1.02);
    }
    /* Hide Calendar URL input when not in edit mode */
    .calendar-url-input { display: none; }
    body.editing .calendar-url-input { display: block; }
    /* Snack message textarea styling */
    #snackMessage:disabled { background-color: transparent; color: var(--md-ink); cursor: default; border: none; }
    body.editing #snackMessage:not(:disabled) {
      background-color: rgba(255,255,255,0.7); cursor: text;
      outline: 2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent); outline-offset: 2px;
    }

    /* Styling for disabled about me, class roster, birthday, and website fields */
    #aboutMeDescText[contenteditable="false"] { background-color: transparent; border: none; cursor: default; }
    body.editing #aboutMeDescText[contenteditable="true"] { 
      outline: 2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent); outline-offset: 2px;
    }
    #classRosterTextarea:disabled, .website-url-input:disabled, textarea[id*="BirthdaysTextarea"]:disabled { 
      background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; border-color: #e5e7eb;
    }
    body.editing #classRosterTextarea:not(:disabled), body.editing .website-url-input:not(:disabled), body.editing textarea[id*="BirthdaysTextarea"]:not(:disabled) {
      background-color: white; color: var(--md-ink); cursor: text;
      outline: 2px dashed color-mix(in oklab,var(--md-slate) 55%,transparent); outline-offset: 2px;
    }
    /* Photo card and gallery cursor only in edit mode */
    .photo-card{cursor: default;}
    body.editing .photo-card{cursor: pointer;}
    .gallery-imgs{cursor: default;}
    body.editing .gallery-imgs{cursor: pointer;}
    body.dark{background: #17212B; color: var(--md-ink);}
    body.dark .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.5)}
    body.dark .bg-white { background: var(--md-white) !important; }
    body.dark .bg-yellow-50 { background: rgba(244, 208, 63, 0.1) !important; }
    body.dark .bg-blue-50 { background: rgba(133, 146, 158, 0.1) !important; }
    body.dark .bg-green-50 { background: rgba(125, 206, 160, 0.1) !important; }
    body.dark .border { border-color: rgba(232, 232, 232, 0.2) !important; }
    body.dark .text-gray-400 { color: #A0A0A0 !important; }
    #pinOverlay { display: none; }
    #pinOverlay.show { display: flex; }
    .pageTab.active, .pageTab.ring-4 { box-shadow: 0 0 0 3px #fff9; }
    .snack-claimed { background: #e0b14a33; }
    .gallery-arrows { position:absolute;top:50%;left:0;width:100%;display:flex;justify-content:space-between;align-items:center;pointer-events:none; }
    .gallery-arrows button { pointer-events:auto;border:none;background:rgba(255,255,255,.75);border-radius:50%;font-size:1.5rem;padding:0.25em 0.6em;cursor:pointer; }
    .gallery-imgs { position:relative;}
    .gallery-imgs img { width:100%; height:100%; object-fit:cover; border-radius:1rem;}
    .filter-btn { background: #e5e7eb; color: #6b7280; }
    
    /* Mobile tab scrolling styles */
    .scrollbar-hide {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
      scroll-behavior: smooth;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;  /* Chrome, Safari and Opera */
    }
    
    /* Mobile tab carousel styles */
    @media (max-width: 768px) {
      .mobile-tab-scroll {
        display: flex;
        flex-wrap: nowrap !important;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        scroll-padding: 1rem;
        -webkit-overflow-scrolling: touch;
        scroll-snap-type: x proximity;
      }
      
      .mobile-tab-scroll > * {
        flex-shrink: 0;
        scroll-snap-align: start;
      }
      
      /* Ensure tabs don't wrap on mobile */
      .mobile-tab-scroll .pageTab,
      .mobile-tab-scroll button,
      .mobile-tab-scroll a {
        white-space: nowrap;
        min-width: max-content;
      }
      
      /* Transportation cards mobile layout */
      .transportation-cards {
        grid-template-columns: repeat(3, minmax(250px, 1fr)) !important;
      }
      
      .transportation-card {
        min-width: 250px;
      }
      
      /* Birthday months mobile layout */
      .birthday-months-mobile {
        grid-template-columns: repeat(12, minmax(200px, 1fr)) !important;
      }
      
      .birthday-month {
        min-width: 200px;
      }
      
      /* Specials cards mobile layout */
      .specials-cards-mobile {
        grid-template-columns: repeat(4, minmax(250px, 1fr)) !important;
      }
      
      .specials-card {
        min-width: 250px;
      }
    }
    
    /* Desktop keeps flex-wrap behavior */
    @media (min-width: 769px) {
      .mobile-tab-scroll {
        flex-wrap: wrap !important;
        overflow-x: visible !important;
      }
    }
    
    /* Mobile vertical accordion tabs - MOBILE ONLY */
    @media (max-width: 768px) {
      #topNav {
        flex-direction: column !important;
        gap: 0.5rem !important;
        flex-wrap: nowrap !important;
        overflow-x: visible !important;
        padding-bottom: 0 !important;
      }
      
      .mobile-accordion-tab {
        width: 100%;
        display: flex;
        flex-direction: column;
      }
      
      .mobile-tab-header {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
      }
      
      .mobile-tab-header button {
        flex: 1;
        justify-content: flex-start;
        pointer-events: none;
      }
      
      .mobile-tab-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background: white;
        border-radius: 0.75rem;
        margin-top: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .mobile-tab-content.active {
        max-height: 2000px;
        transition: max-height 0.5s ease-in;
      }
      
      .mobile-tab-arrow {
        transition: transform 0.3s ease;
        font-size: 0.875rem;
        color: white;
        background: rgba(0,0,0,0.2);
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        margin-right: 0.5rem;
      }
      
      .mobile-tab-arrow.rotated {
        transform: rotate(180deg);
      }
      
      /* Make modal-opening buttons work on mobile */
      .mobile-accordion-tab #aboutMeDavisBtn,
      .mobile-accordion-tab #learningHubBtn,
      .mobile-accordion-tab #familyHubBtn {
        pointer-events: auto !important;
        width: 100%;
      }
      
      /* Make regular page tabs still work but not switch pages on accordion click */
      .mobile-accordion-tab .pageTab {
        width: 100%;
      }
      
      /* Hide Important Dates tab on mobile (it's only for accordion) */
      .mobile-accordion-tab.dates-only {
        display: flex;
      }
    }
    
    /* Desktop behavior - ensure no changes to desktop */
    @media (min-width: 769px) {
      .mobile-accordion-tab {
        display: contents;
      }
      
      .mobile-tab-header {
        display: contents;
      }
      
      .mobile-tab-content {
        display: none !important;
      }
      
      .mobile-tab-arrow {
        display: none !important;
      }
      
      /* Hide Important Dates tab on desktop */
      .mobile-accordion-tab.dates-only {
        display: none !important;
      }
    }
    
    .filter-btn.active { background: var(--md-coral); color: white; }
  </style>
</head>
<body class="bg-[color:var(--md-cream)] text-[color:var(--md-ink)] font-body">
  <!-- HEADER -->
  <header class="relative w-full" style="background: var(--hdr-bg);">
    <!-- Shoutout Button - positioned in top right -->
    <button id="shoutoutBtn" class="absolute top-4 right-4 md:top-6 md:right-6 bg-[color:var(--md-coral)] text-white px-4 py-2 rounded-full font-semibold shadow-lg hover:opacity-90 transition-opacity z-10" style="border-radius: 20px;" data-page="shoutouts">
      ğŸ’¬ Shoutout Your Scholar!
    </button>
    <div class="max-w-6xl mx-auto px-6 py-8 sm:py-10">
      <h1 id="mainHeading" class="text-4xl sm:text-5xl lg:text-6xl font-display font-extrabold text-white"
          data-edit="teacher" contenteditable="false">
        Hey Hey First Grade!
      </h1>
      <p id="weekText" class="mt-2 text-white/95 font-semibold"
         data-edit="teacher" contenteditable="false">Week of September 1â€“5</p>
    </div>
  </header>
  <!-- Tab Separator -->
  <div class="w-full">
    <div class="border-t-4" style="border-color: color-mix(in oklab, var(--md-slate) 70%, var(--md-white) 30%); box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
  </div>
  <main class="max-w-6xl mx-auto px-6 pb-16">
    <!-- Top Navigation Bar -->
    <nav id="topNav" class="mt-6 mb-4 flex flex-wrap items-center gap-3 mobile-tab-scroll scrollbar-hide">
      <!-- Home Tab with Mobile Accordion -->
      <div class="mobile-accordion-tab">
        <div class="mobile-tab-header">
          <button class="pageTab inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                  data-page="home" style="background: var(--md-coral);">
            <span>ğŸ </span><span>Home</span>
          </button>
          <span class="mobile-tab-arrow">â–¼</span>
        </div>
        <div class="mobile-tab-content" id="homeAccordion">
          <div class="p-4">
            <h3 class="font-bold text-lg mb-3" style="color: var(--md-coral);">What We Did This Week</h3>
            <p id="mobileRecapText" class="text-sm leading-relaxed text-gray-700">
              This week we explored magical stories and practiced our sight words. The students loved reading about brave characters and sharing their favorite parts!
            </p>
          </div>
        </div>
      </div>
      
      <!-- Mr. Davis Tab - Opens Modal on Mobile -->
      <div class="mobile-accordion-tab">
        <button id="aboutMeDavisBtn"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                data-page="aboutme" style="background: var(--md-coral);">
          <span>ğŸ‘¨â€ğŸ«</span><span>Mr. Davis</span>
        </button>
      </div>
      
      <!-- Important Dates Tab with Mobile Accordion (Mobile Only) -->
      <div class="mobile-accordion-tab dates-only">
        <div class="mobile-tab-header">
          <button class="pageTab inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                  data-page="home" style="background: var(--md-mustard);">
            <span>ğŸ“…</span><span>Important Dates</span>
          </button>
          <span class="mobile-tab-arrow">â–¼</span>
        </div>
        <div class="mobile-tab-content" id="datesAccordion">
          <div class="p-4" id="mobileDatesList">
            <!-- Dates will be populated here -->
          </div>
        </div>
      </div>
      
      <!-- Scholar Tab -->
      <div class="mobile-accordion-tab">
        <button class="pageTab inline-flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-white"
                data-page="scholar" style="background: var(--md-mustard);">
          <span>â­</span><span>Scholar of the Month</span>
        </button>
      </div>
      
      <!-- Learning Hub Tab - Opens Modal -->
      <div class="mobile-accordion-tab">
        <button id="learningHubBtn"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                style="background: var(--md-slate);">
          <span>ğŸ“š</span><span>Learning Hub</span>
        </button>
      </div>
      
      <!-- Specials Tab -->
      <div class="mobile-accordion-tab">
        <button class="pageTab inline-flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-white"
                data-page="specials" style="background:#f59e0b;">
          <span>ğŸ¨</span><span>Specials</span>
        </button>
      </div>
      
      <!-- Family Hub Tab - Opens Modal -->
      <div class="mobile-accordion-tab">
        <button id="familyHubBtn"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90"
                style="background: var(--md-coral);">
          <span>ğŸ«</span><span>Family Hub</span>
        </button>
      </div>
      
      <!-- Extra News Tab -->
      <div class="mobile-accordion-tab">
        <button class="pageTab inline-flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-white"
                data-page="extras" style="background:#6b7280;">
          <span>ğŸ“°</span><span>Extra News</span>
        </button>
      </div>
    </nav>
    <!-- HOME TAB -->
    <section data-page-panel="home" class="pagePanel fade-in active">
      <!-- What We Did -->
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <h2 class="text-2xl font-display font-bold mb-5 text-center">What We Did This Week</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <!-- 2 small + 1 large photo grid -->
          <div class="col-span-1 flex flex-col gap-4">
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="photo-card rounded-xl aspect-[4/3] bg-[color:var(--md-blush)] flex items-center justify-center text-3xl font-bold relative" onclick="handleHomePhotoClick(this)">+
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteHomePhoto(this)" title="Delete Photo">âœ–</button>
              </div>
              <div class="photo-card rounded-xl aspect-[4/3] bg-[color:var(--md-blush)] flex items-center justify-center text-3xl font-bold relative" onclick="handleHomePhotoClick(this)">+
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteHomePhoto(this)" title="Delete Photo">âœ–</button>
              </div>
            </div>
            <div class="photo-card rounded-xl aspect-[4/3] bg-[color:var(--md-blush)] flex items-center justify-center text-3xl font-bold relative" onclick="handleHomePhotoClick(this)">+
              <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteHomePhoto(this)" title="Delete Photo">âœ–</button>
            </div>
          </div>
          <!-- Editable recap -->
          <div class="md:col-span-2">
            <div class="rounded-xl p-4 sm:p-5 h-full flex items-center" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-blush) 30%); border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
              <p id="recapText" class="leading-relaxed w-full" data-edit="teacher" contenteditable="false">
                This week we explored magical stories and practiced our sight words. The students loved reading about brave characters and sharing their favorite parts! We also worked on counting by 5s and 10s using fun games and manipulatives. Our art projects focused on fall colors and textures - the students created beautiful leaf collages and practiced writing descriptive words.
              </p>
            </div>
          </div>
        </div>
      </div>
      <!-- Important Dates + Looking Ahead -->
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <div class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-display font-bold">Important Dates</h2>
              <button class="edit-only px-4 py-2 rounded-xl text-white font-semibold" style="background: var(--md-coral);" onclick="addEvent()">+ Add Event</button>
            </div>
            <div id="eventsList" class="space-y-4">
              <div class="event-item flex items-center gap-3 p-3 rounded-xl bg-yellow-50 border" style="border-color:var(--md-mustard)">
                <span class="event-emoji text-xl" data-edit="teacher" contenteditable="false">ğŸƒ</span>
                <span class="event-text font-semibold flex-1" data-edit="teacher" contenteditable="false">Halloween Party - October 31st at 2pm</span>
                <button class="edit-only text-red-500 hover:text-red-700" onclick="this.parentNode.remove()">âœ–</button>
              </div>
              <div class="event-item flex items-center gap-3 p-3 rounded-xl bg-blue-50 border" style="border-color:var(--md-slate)">
                <span class="event-emoji text-xl" data-edit="teacher" contenteditable="false">ğŸ¦ƒ</span>
                <span class="event-text font-semibold flex-1" data-edit="teacher" contenteditable="false">Thanksgiving Break - November 23-27</span>
                <button class="edit-only text-red-500 hover:text-red-700" onclick="this.parentNode.remove()">âœ–</button>
              </div>
            </div>
            <div class="p-4 rounded-xl mt-6" style="background: color-mix(in oklab, var(--md-white) 70%, #8b5cf6 30%); border: 1px solid color-mix(in oklab, #8b5cf6 60%, var(--md-white) 40%);">
              <h3 class="font-semibold mb-2">ğŸ“… School Calendar</h3>
              <a id="schoolCalendarLink" href="#" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 underline">View School Calendar</a>
              <p class="text-xs text-gray-600 mt-1">Click to visit the school calendar</p>
              <div class="calendar-url-input">
                <input type="url" id="calendarUrlInput" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg" placeholder="Enter calendar URL (PDF or webpage)" value="#" onchange="updateCalendarUrl(this)">
                <button id="saveCalendarBtn" class="mt-2 px-3 py-1.5 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveCalendarUrl()">ğŸ’¾ Save Calendar URL</button>
              </div>
            </div>
          </div>
          <div>
            <div class="rounded-2xl p-5 h-full" style="background: color-mix(in oklab, var(--md-white) 68%, var(--md-blush) 32%); border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
              <h3 class="font-semibold mb-3">ğŸ”® Looking Ahead</h3>
              <ul class="space-y-2 text-sm" data-edit="teacher" contenteditable="false">
                <li>â€¢ Field trip permission slips due</li>
                <li>â€¢ Parent-teacher conferences</li>
                <li>â€¢ Winter concert practice begins</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- SCHOLAR TAB -->
    <section data-page-panel="scholar" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-10 mb-8" style="background: var(--md-white); border: 1px solid color-mix(in oklab, var(--md-mustard) 50%, var(--md-white) 50%);">
        <div class="grid lg:grid-cols-[auto,1fr] gap-8 items-center">
          <div class="w-40 h-40 sm:w-48 sm:h-48 rounded-full border-4 img-frame photo-card overflow-hidden mx-auto lg:mx-0" 
               style="border-color: var(--md-mustard);" onclick="editProfilePhoto(this, 'scholar')"></div>
          <div class="text-center lg:text-left relative">
            <h2 class="text-2xl font-display font-bold mb-4" style="color: var(--md-mustard);">This Month's Scholar Skill Is</h2>
            <div class="rounded-xl p-4 mb-6" style="background: color-mix(in oklab, var(--md-mustard) 20%, var(--md-white)); border: 2px solid color-mix(in oklab, var(--md-mustard) 50%, var(--md-white));">
              <p class="text-lg font-semibold" data-edit="teacher" contenteditable="false">Kindness and helping others</p>
            </div>
            <h3 class="text-3xl sm:text-4xl font-display font-extrabold mb-4" data-edit="teacher" contenteditable="false">Emma S.</h3>
            <p class="text-lg leading-relaxed mb-6" data-edit="teacher" contenteditable="false">
              Emma has shown incredible kindness this week by helping her classmates and always having a positive attitude. She's been working so hard on her reading and it really shows!
            </p>
            <button id="celebrateBtn" onclick="triggerConfetti()" 
                    class="inline-flex items-center gap-2 px-6 py-3 rounded-xl font-semibold text-white" 
                    style="background: var(--md-coral);">
              <span>ğŸ‰</span><span>Celebrate!</span>
            </button>
          </div>
        </div>
      </div>
    </section>
    <!-- SKILLS TAB -->
    <section data-page-panel="skills" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <h2 class="text-2xl font-display font-bold mb-4" style="color: var(--md-coral);">ğŸ“– Skills Spotlight</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
            <p class="leading-relaxed" data-edit="teacher" contenteditable="false">
              This week we're focusing on building strong reading foundations through sight word recognition and phonics practice. Students are learning to blend sounds together to read new words and are practicing writing complete sentences with proper capitalization and punctuation.
            </p>
          </div>
          <div class="rounded-xl p-4" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-coral) 30%); border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h3 class="font-semibold mb-3">Sounds / Sight Words / Vocab</h3>
            <ul class="text-sm list-disc pl-5" data-edit="teacher" contenteditable="false">
              <li>Short vowel sounds</li>
              <li>Words: the, and, is, to</li>
              <li>Family vocabulary</li>
              <li>Action words</li>
            </ul>
          </div>
        </div>
      </div>
      <!-- Watch Me Box for Skills -->
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-display font-bold" style="color: var(--md-slate);">ğŸ¬ Watch Me</h3>
          <div class="flex gap-2">
            <button id="addSkillsWatchMeBtn" class="edit-only px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral); display: none;" onclick="addWatchMeLink('skills')">+ Add Link</button>
            <button id="saveSkillsWatchMeBtn" class="edit-only px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-slate); display: none;" onclick="saveWatchMeLinks('skills')">ğŸ’¾ Save Links</button>
          </div>
        </div>
        <div id="skillsWatchMeContent" class="space-y-2">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </section>
    <!-- LISTENING & LEARNING TAB -->
    <section data-page-panel="listening" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <h2 class="text-2xl font-display font-bold mb-4" style="color: var(--md-coral);">ğŸ‘‚ Listening & Learning</h2>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
            <p class="leading-relaxed" data-edit="teacher" contenteditable="false">
              We're building strong listening skills through daily read-alouds and interactive discussions. Students practice following multi-step directions and learn to ask thoughtful questions about the stories we read together.
            </p>
          </div>
          <div class="rounded-xl p-4" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-coral) 30%); border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h3 class="font-semibold mb-3">Ask your scholar...</h3>
            <ul class="text-sm list-disc pl-5" data-edit="teacher" contenteditable="false">
              <li>What happened in today's story?</li>
              <li>Who was your favorite character?</li>
              <li>What do you think happens next?</li>
            </ul>
          </div>
        </div>
      </div>
      <!-- Watch Me Box for Listening & Learning -->
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-display font-bold" style="color: var(--md-coral);">ğŸ¬ Watch Me</h3>
          <div class="flex gap-2">
            <button id="addListeningWatchMeBtn" class="edit-only px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral); display: none;" onclick="addWatchMeLink('listening')">+ Add Link</button>
            <button id="saveListeningWatchMeBtn" class="edit-only px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-slate); display: none;" onclick="saveWatchMeLinks('listening')">ğŸ’¾ Save Links</button>
          </div>
        </div>
        <div id="listeningWatchMeContent" class="space-y-2">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </section>
    <!-- MATH TAB -->
    <section data-page-panel="math" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <div class="flex items-center justify-between mb-5">
          <h2 class="text-2xl font-display font-bold" style="color: var(--md-slate);">ğŸ§® Math Adventures</h2>
        </div>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-2">
            <p class="leading-relaxed" data-edit="teacher" contenteditable="false">
              We're exploring number patterns and building addition skills using hands-on manipulatives and fun games. Students are learning to count by 2s, 5s, and 10s while practicing addition facts within 20.
            </p>
          </div>
          <div class="rounded-xl p-4" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-blush) 30%); border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
            <h3 class="font-semibold mb-3">Vocabulary & Strategies</h3>
            <ul class="text-sm list-disc pl-5" data-edit="teacher" contenteditable="false">
              <li>Addition, sum, plus</li>
              <li>Count on strategy</li>
              <li>Number line</li>
              <li>Ten frames</li>
            </ul>
          </div>
        </div>
      </div>
      <!-- Watch Me Box for Math -->
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-display font-bold" style="color: var(--md-slate);">ğŸ¬ Watch Me</h3>
          <div class="flex gap-2">
            <button id="addMathWatchMeBtn" class="edit-only px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral); display: none;" onclick="addWatchMeLink('math')">+ Add Link</button>
            <button id="saveMathWatchMeBtn" class="edit-only px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-slate); display: none;" onclick="saveWatchMeLinks('math')">ğŸ’¾ Save Links</button>
          </div>
        </div>
        <div id="mathWatchMeContent" class="space-y-2">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </section>
    <!-- SNACKS TAB -->
    <section data-page-panel="snacks" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <div class="flex items-center justify-between mb-5">
          <div>
            <h2 class="text-2xl font-display font-bold">ğŸ¥¨ Snack Helpers</h2>
            <p class="text-sm text-[color:var(--md-ink)]/80 mt-1">Check an item and add your name.</p>
          </div>
          <button id="snackAdd" class="px-3 py-2 rounded-lg text-white" style="background: var(--md-coral);" onclick="addSnackItem()">+ Add other snack</button>
        </div>
        <!-- Snack importance message -->
        <div class="mb-4 p-3 rounded-lg" style="background: color-mix(in oklab, var(--md-mustard) 20%, var(--md-white) 80%); border: 1px solid color-mix(in oklab, var(--md-mustard) 40%, var(--md-white) 60%);">
          <div class="flex justify-between items-start mb-2 edit-only" style="display: none;">
            <h4 class="font-semibold text-sm">Snack Message</h4>
            <button id="saveSnackMessageBtn" class="px-3 py-1 rounded-lg text-white text-xs font-semibold" style="background: var(--md-coral);" onclick="saveSnackMessage()">ğŸ’¾ Save</button>
          </div>
          <textarea 
            id="snackMessage" 
            class="w-full text-sm border-0 resize-none" 
            style="background: transparent; outline: none;" 
            placeholder="Click to add a message about why snacks are important..."
            disabled 
            readonly
            rows="4">Snacks help keep our energy up during learning time and teach us about sharing and community!</textarea>
        </div>
        <div id="snacksGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Default snack cards - always visible, names only editable by teacher/admin -->
          <div class="p-4 rounded-xl bg-white default-snack-card" data-default-snack="true" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="1">
              <span class="text-xl">ğŸ¥¯</span>
              <span class="font-medium snack-title" data-edit="teacher" contenteditable="false">Breakfast Bars</span>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="2">
              <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="3">Save</button>
            </div>
          </div>
          <div class="p-4 rounded-xl bg-white default-snack-card" data-default-snack="true" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="4">
              <span class="text-xl">ğŸ¬</span>
              <span class="font-medium snack-title" data-edit="teacher" contenteditable="false">Gummies</span>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="5">
              <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="6">Save</button>
            </div>
          </div>
          <div class="p-4 rounded-xl bg-white default-snack-card" data-default-snack="true" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="7">
              <span class="text-xl">ğŸš</span>
              <span class="font-medium snack-title" data-edit="teacher" contenteditable="false">Rice Krispy Treats</span>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="8">
              <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="9">Save</button>
            </div>
          </div>
          <div class="p-4 rounded-xl bg-white default-snack-card" data-default-snack="true" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
            <div class="flex items-center gap-3 mb-3">
              <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="10">
              <span class="text-xl">ğŸ§ƒ</span>
              <span class="font-medium snack-title" data-edit="teacher" contenteditable="false">Juice</span>
            </div>
            <div class="flex items-center gap-2">
              <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="11">
              <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="12">Save</button>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- EXTRAS TAB -->
    <section data-page-panel="extras" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8" style="background: var(--card-bg);">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-display font-bold" style="color: var(--md-coral);">âœ¨ Classroom Updates</h2>
          <div class="flex gap-2">
            <button id="saveExtrasBtn" class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveExtrasCards()">ğŸ’¾ Save Cards</button>
            <button id="addExtrasCardBtn" class="px-3 py-2 rounded-lg text-white text-sm" style="background: var(--md-slate);" onclick="addExtrasCard()">+ Add Card</button>
          </div>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6" id="extrasGrid">
          <div class="text-center p-8 rounded-2xl" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-mustard) 30%); border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <div class="text-6xl mb-4 emoji-edit" contenteditable="false" style="cursor: default;">ğŸ¯</div>
            <h3 class="font-semibold mb-2" contenteditable="false" style="cursor: default;">Class Goal</h3>
            <p class="text-sm" contenteditable="false" style="cursor: default;">We're working together to read 100 books this month!</p>
            <button class="mt-2 text-red-500 hover:text-red-700 text-xs" onclick="this.closest('.text-center').remove();" style="display: none;">Remove Card</button>
          </div>
          <div class="text-center p-8 rounded-2xl" style="background: color-mix(in oklab, var(--md-white) 70%, var(--md-coral) 30%); border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <div class="text-6xl mb-4 emoji-edit" contenteditable="false" style="cursor: default;">ğŸ“£</div>
            <h3 class="font-semibold mb-2" contenteditable="false" style="cursor: default;">Shout-outs</h3>
            <p class="text-sm" contenteditable="false" style="cursor: default;">Amazing job on our math assessments this week!</p>
            <button class="mt-2 text-red-500 hover:text-red-700 text-xs" onclick="this.closest('.text-center').remove();" style="display: none;">Remove Card</button>
          </div>
        </div>
      </div>
    </section>
    <!-- SHOUTOUT YOUR SCHOLAR TAB -->
    <section data-page-panel="shoutouts" class="pagePanel fade-in">
      <div class="text-center mb-8">
        <!-- Large TV Display (functional TV without decorative emoji) -->
        <div class="mx-auto max-w-5xl">
          <h2 class="text-4xl font-display font-bold mb-8" style="color: var(--md-coral); font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif;">Shoutout TV!</h2>
          
          <!-- Enhanced TV Screen with TV-like appearance -->
          <div class="tv-container mx-auto" style="max-width: 800px; background: linear-gradient(145deg, #2a2a2a, #1a1a1a); border-radius: 40px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1);">
            <div class="bg-black rounded-2xl p-8 mb-4" style="min-height: 350px; display: flex; align-items: center; justify-content: center; border: 12px solid #333; box-shadow: inset 0 0 30px rgba(0,0,0,0.8);">
              <div id="shoutoutTVDisplay" class="text-white text-center" style="font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif; font-size: 2rem; line-height: 1.4; max-width: 90%;">
                Welcome to our amazing first grade classroom! Keep being awesome, scholars!
              </div>
            </div>
            <!-- TV Brand/Controls Area -->
            <div class="text-center" style="color: #666; font-size: 0.8rem; margin-top: 8px;">
              <div style="background: #333; border-radius: 8px; padding: 4px 12px; display: inline-block;">Classroom TV</div>
            </div>
          </div>
          
          <!-- Control Buttons -->
          <div class="flex gap-4 justify-center mb-8">
            <button id="shuffleTVBtn" class="px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90 text-lg" style="background: var(--md-mustard);">
              ğŸ² Shuffle
            </button>
            <button id="createShoutoutBtn" class="px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90 text-lg" style="background: var(--md-coral);">
              âœ¨ Create Shoutout
            </button>
          </div>
          
          <!-- Admin Button (appears in Edit Mode) -->
          <div class="mb-4">
            <button id="createdShoutsBtn" class="edit-only px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-slate);">
              ğŸ“‹ Created Shoutouts
            </button>
          </div>
          

        </div>
      </div>
    </section>
    <!-- SPECIALS TAB -->
    <section data-page-panel="specials" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--card-bg);">
        <h2 class="text-2xl font-display font-bold mb-6" style="color: #f59e0b;">ğŸ¨ Specials Classes</h2>
        
        <!-- Mobile Arrow Indicator -->
        <div class="md:hidden text-center text-sm text-gray-500 mb-4">
          â† Swipe to view all specials â†’
        </div>
        
        <div class="specials-cards-mobile mobile-tab-scroll scrollbar-hide grid md:grid-cols-2 gap-8">
          <!-- Art -->
          <div class="specials-card rounded-2xl overflow-hidden relative" style="background: color-mix(in oklab, var(--md-white) 70%, #ef4444 30%); border: 1px solid color-mix(in oklab, #ef4444 60%, var(--md-white) 40%);">
            <div class="grid grid-cols-2 gap-4 m-4">
              <div class="specials-img-slot aspect-square bg-white rounded-lg flex items-center justify-center relative cursor-pointer" onclick="handleSpecialsImageClick(this, 'art', 0)" data-specials-type="art" data-slot-index="0">
                <img src="" alt="Art" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">
                <span class="text-3xl text-gray-400">+</span>
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteSpecialsImage(this, 'art', 0)" title="Delete Photo">âœ–</button>
              </div>
              <div class="specials-img-slot aspect-square bg-white rounded-lg flex items-center justify-center relative cursor-pointer" onclick="handleSpecialsImageClick(this, 'art', 1)" data-specials-type="art" data-slot-index="1">
                <img src="" alt="Art" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">
                <span class="text-3xl text-gray-400">+</span>
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteSpecialsImage(this, 'art', 1)" title="Delete Photo">âœ–</button>
              </div>
            </div>
            <div class="rounded-lg p-4 m-4 bg-white" style="color: var(--md-ink);">
              <h3 class="font-semibold">ğŸ¨ Art</h3>
              <p class="text-sm" data-edit="teacher" contenteditable="false">Creative masterpieces from art class</p>
            </div>
          </div>
          <!-- STEM -->
          <div class="specials-card rounded-2xl overflow-hidden relative" style="background: color-mix(in oklab, var(--md-white) 70%, #10b981 30%); border: 1px solid color-mix(in oklab, #10b981 60%, var(--md-white) 40%);">
            <div class="grid grid-cols-2 gap-4 m-4">
              <div class="specials-img-slot aspect-square bg-white rounded-lg flex items-center justify-center relative cursor-pointer" onclick="handleSpecialsImageClick(this, 'stem', 0)" data-specials-type="stem" data-slot-index="0">
                <img src="" alt="STEM" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">
                <span class="text-3xl text-gray-400">+</span>
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteSpecialsImage(this, 'stem', 0)" title="Delete Photo">âœ–</button>
              </div>
              <div class="specials-img-slot aspect-square bg-white rounded-lg flex items-center justify-center relative cursor-pointer" onclick="handleSpecialsImageClick(this, 'stem', 1)" data-specials-type="stem" data-slot-index="1">
                <img src="" alt="STEM" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">
                <span class="text-3xl text-gray-400">+</span>
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteSpecialsImage(this, 'stem', 1)" title="Delete Photo">âœ–</button>
              </div>
            </div>
            <div class="rounded-lg p-4 m-4 bg-white" style="color: var(--md-ink);">
              <h3 class="font-semibold">ğŸ”¬ STEM</h3>
              <p class="text-sm" data-edit="teacher" contenteditable="false">Science experiments and discoveries</p>
            </div>
          </div>
          <!-- Gym -->
          <div class="specials-card rounded-2xl overflow-hidden relative" style="background: color-mix(in oklab, var(--md-white) 70%, #3b82f6 30%); border: 1px solid color-mix(in oklab, #3b82f6 60%, var(--md-white) 40%);">
            <div class="grid grid-cols-2 gap-4 m-4">
              <div class="specials-img-slot aspect-square bg-white rounded-lg flex items-center justify-center relative cursor-pointer" onclick="handleSpecialsImageClick(this, 'gym', 0)" data-specials-type="gym" data-slot-index="0">
                <img src="" alt="Gym" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">
                <span class="text-3xl text-gray-400">+</span>
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteSpecialsImage(this, 'gym', 0)" title="Delete Photo">âœ–</button>
              </div>
              <div class="specials-img-slot aspect-square bg-white rounded-lg flex items-center justify-center relative cursor-pointer" onclick="handleSpecialsImageClick(this, 'gym', 1)" data-specials-type="gym" data-slot-index="1">
                <img src="" alt="Gym" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">
                <span class="text-3xl text-gray-400">+</span>
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteSpecialsImage(this, 'gym', 1)" title="Delete Photo">âœ–</button>
              </div>
            </div>
            <div class="rounded-lg p-4 m-4 bg-white" style="color: var(--md-ink);">
              <h3 class="font-semibold">ğŸƒâ€â™‚ï¸ Gym</h3>
              <p class="text-sm" data-edit="teacher" contenteditable="false">Physical activities and games</p>
            </div>
          </div>
          <!-- Music -->
          <div class="specials-card rounded-2xl overflow-hidden relative" style="background: color-mix(in oklab, var(--md-white) 70%, #8b5cf6 30%); border: 1px solid color-mix(in oklab, #8b5cf6 60%, var(--md-white) 40%);">
            <div class="grid grid-cols-2 gap-4 m-4">
              <div class="specials-img-slot aspect-square bg-white rounded-lg flex items-center justify-center relative cursor-pointer" onclick="handleSpecialsImageClick(this, 'music', 0)" data-specials-type="music" data-slot-index="0">
                <img src="" alt="Music" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">
                <span class="text-3xl text-gray-400">+</span>
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteSpecialsImage(this, 'music', 0)" title="Delete Photo">âœ–</button>
              </div>
              <div class="specials-img-slot aspect-square bg-white rounded-lg flex items-center justify-center relative cursor-pointer" onclick="handleSpecialsImageClick(this, 'music', 1)" data-specials-type="music" data-slot-index="1">
                <img src="" alt="Music" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">
                <span class="text-3xl text-gray-400">+</span>
                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteSpecialsImage(this, 'music', 1)" title="Delete Photo">âœ–</button>
              </div>
            </div>
            <div class="rounded-lg p-4 m-4 bg-white" style="color: var(--md-ink);">
              <h3 class="font-semibold">ğŸµ Music</h3>
              <p class="text-sm" data-edit="teacher" contenteditable="false">Songs and musical learning</p>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- PRACTICE WEBSITES TAB -->
    <section data-page-panel="practice" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--md-cream);">
        <div class="flex items-center justify-between mb-5">
          <h2 class="text-2xl font-display font-bold" style="color: var(--md-slate);">ğŸŒ Practice Websites</h2>
          <div class="flex gap-2">
            <button id="saveWebsitesBtn" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-slate);" onclick="saveWebsiteUrls()">ğŸ’¾ Save</button>
          </div>
        </div>
        <div id="websitesGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="website-card text-center p-6 rounded-xl bg-white" draggable="false" data-order="0" data-website-id="website-0" style="border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">ğŸ¯</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">Clever â€“ Learning Portal</h3>
            <a href="https://clever.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-white text-sm" style="background: var(--md-mustard);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://clever.com" onchange="updateWebsiteUrl(this)">
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" draggable="false" data-order="1" data-website-id="website-1" style="border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">ğŸ“±</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">Clever QR Codes</h3>
            <button onclick="openCleverQRPanel()" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-white text-sm" style="background: var(--md-mustard);">View QR Codes</button>
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" draggable="false" data-order="2" data-website-id="website-2" style="border: 1px solid color-mix(in oklab, var(--md-slate) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">ğŸ“±</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">ClassDojo</h3>
            <a href="https://classdojo.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-white text-sm" style="background: var(--md-slate);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://classdojo.com" onchange="updateWebsiteUrl(this)">
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" draggable="false" data-order="3" data-website-id="website-3" style="border: 1px solid color-mix(in oklab, var(--md-slate) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">ğŸ“±</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">ClassDojo QR Codes</h3>
            <button onclick="openClassDojoQRPanel()" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-white text-sm" style="background: var(--md-slate);">View QR Codes</button>
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" draggable="false" data-order="4" data-website-id="website-4" style="border: 1px solid color-mix(in oklab, var(--md-pebble) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">ğŸ”¤</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">Blending Practice</h3>
            <a href="https://starfall.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-sm" style="background: var(--md-pebble); color: var(--md-ink);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://starfall.com" onchange="updateWebsiteUrl(this)">
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" draggable="false" data-order="5" data-website-id="website-5" style="border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">ğŸ“š</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">Skills Practice</h3>
            <a href="https://readingeggs.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold" style="background: var(--md-blush); color: var(--md-ink);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://readingeggs.com" onchange="updateWebsiteUrl(this)">
          </div>
          <div class="website-card text-center p-6 rounded-xl bg-white" draggable="false" data-order="6" data-website-id="website-6" style="border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <div class="text-4xl mb-3" data-edit="teacher" contenteditable="false">ğŸ“˜</div>
            <h3 class="website-title font-semibold mb-2" data-edit="teacher" contenteditable="false">Math Practice</h3>
            <a href="https://mathplayground.com" target="_blank" class="website-link inline-block px-4 py-2 rounded-lg font-semibold text-white text-sm" style="background: var(--md-coral);">Visit Site</a>
            <input type="url" class="mt-2 w-full px-3 py-2 text-sm border rounded-lg website-url-input" placeholder="Enter website URL" value="https://mathplayground.com" onchange="updateWebsiteUrl(this)">
          </div>
        </div>
      </div>
    </section>
    <!-- TRANSPORTATION TAB (always editable) -->
    <section data-page-panel="transportation" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8" style="background: var(--md-cream);">
        <h2 class="text-2xl font-display font-bold mb-6" style="color: #f59e0b;">ğŸšŒ Transportation</h2>
        
        <!-- Admin Instructions Box -->
        <div class="bg-white rounded-xl p-4 mb-6" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
          <div class="flex justify-end items-center mb-3">
            <button id="saveTransportationInstructionsBtn" class="px-3 py-1 rounded-lg text-white text-xs font-semibold" style="background: var(--md-coral);" onclick="saveTransportationField('instructions')">ğŸ’¾ Save</button>
          </div>
          <textarea id="transportationInstructionsTextarea" class="w-full h-16 p-3 text-sm border rounded-lg resize-none" placeholder="Add instructions for parents about transportation procedures...">Please review your child's transportation method and contact the office if changes are needed.</textarea>
        </div>

        <!-- Mobile Arrow Indicator -->
        <div class="md:hidden text-center text-sm text-gray-500 mb-4">
          â† Swipe to view all transportation options â†’
        </div>

        <!-- Transportation Cards Container -->
        <div class="transportation-cards-container">
          <div class="transportation-cards mobile-tab-scroll scrollbar-hide grid md:grid-cols-3 gap-4">
            <!-- Bus Card -->
            <div class="transportation-card bg-white rounded-xl p-6 cursor-pointer hover:shadow-lg transition-shadow" 
                 style="border: 2px solid #fbbf24;" onclick="openTransportationModal('bus')">
              <div class="text-center">
                <div class="text-4xl mb-3">ğŸšŒ</div>
                <h3 class="text-lg font-semibold mb-2" style="color: #fbbf24;">Bus Riders</h3>
                <p class="text-sm text-gray-600">Click to manage bus transportation</p>
              </div>
            </div>

            <!-- Car Card -->
            <div class="transportation-card bg-white rounded-xl p-6 cursor-pointer hover:shadow-lg transition-shadow" 
                 style="border: 2px solid #10b981;" onclick="openTransportationModal('car')">
              <div class="text-center">
                <div class="text-4xl mb-3">ğŸš—</div>
                <h3 class="text-lg font-semibold mb-2" style="color: #10b981;">Car Riders</h3>
                <p class="text-sm text-gray-600">Click to manage car pickup</p>
              </div>
            </div>

            <!-- Porch Card -->
            <div class="transportation-card bg-white rounded-xl p-6 cursor-pointer hover:shadow-lg transition-shadow" 
                 style="border: 2px solid #8b5cf6;" onclick="openTransportationModal('porch')">
              <div class="text-center">
                <div class="text-4xl mb-3">ğŸ </div>
                <h3 class="text-lg font-semibold mb-2" style="color: #8b5cf6;">Porch Pickup</h3>
                <p class="text-sm text-gray-600">Click to manage porch pickup</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Hidden textareas for backward compatibility -->
        <div style="display: none;">
          <textarea id="busRidersTextarea"></textarea>
          <textarea id="carRidersTextarea"></textarea>
          <textarea id="porchPickupTextarea"></textarea>
        </div>
      </div>
    </section>
    <!-- ABOUT ME TAB -->
    <section data-page-panel="aboutme" class="pagePanel fade-in">
      <div class="rounded-2xl shadow-soft p-6 sm:p-10 mb-8" style="background: var(--md-cream);">
        <div class="grid md:grid-cols-[auto,1fr] gap-8 items-center">
          <div class="w-40 h-40 sm:w-48 sm:h-48 rounded-full border-4 img-frame photo-card overflow-hidden mx-auto md:mx-0" 
               style="border-color: var(--md-mustard);" onclick="editProfilePhoto(this, 'aboutme')"></div>
          <div>
            <h2 class="text-2xl font-display font-bold mb-6" style="color: var(--md-coral);">ğŸ‘‹ About Mr. Davis</h2>
            <div class="mb-6">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">About Me</h3>
                <button id="saveAboutMeDescBtn" class="px-3 py-1 rounded-lg text-white text-xs font-semibold" style="background: var(--md-coral);" onclick="saveAboutMeField('aboutMeDesc')">ğŸ’¾ Save</button>
              </div>
              <p id="aboutMeDescText" class="leading-relaxed" contenteditable="false" style="min-height: 60px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;">
                I've been teaching first grade for 8 years and absolutely love working with young learners! I believe every child can succeed with the right support and encouragement.
              </p>
            </div>
            <div class="mb-6">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold">Fun Facts</h3>
                <button id="saveFunFactsBtn" class="px-3 py-1 rounded-lg text-white text-xs font-semibold" style="background: var(--md-coral);" onclick="saveAboutMeField('funFacts')">ğŸ’¾ Save</button>
              </div>
              <ul id="funFactsList" class="list-disc pl-5 space-y-1" contenteditable="false" style="min-height: 80px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;">
                <li>I love reading mystery novels</li>
                <li>I have two cats named Whiskers and Mittens</li>
                <li>I enjoy hiking on weekends</li>
                <li>I can play the guitar</li>
              </ul>
            </div>
          </div>
        </div>
        <!-- Favorites Section moved to bottom -->
        <div class="mt-8">
          <h3 class="font-semibold mb-4 text-center">Personal Favorites</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-xl p-4 text-center">
              <div class="text-2xl mb-2">ğŸ¨</div>
              <h4 class="font-semibold text-sm mb-1">Favorite Color</h4>
              <p id="favoriteColorText" class="text-xs" contenteditable="false" style="min-height: 20px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;">Blue</p>
              <button id="saveFavoriteColorBtn" class="mt-2 px-2 py-1 rounded text-white text-xs" style="background: var(--md-coral);" onclick="saveAboutMeField('favoriteColor')">ğŸ’¾</button>
            </div>
            <div class="bg-white rounded-xl p-4 text-center">
              <div class="text-2xl mb-2">ğŸª</div>
              <h4 class="font-semibold text-sm mb-1">Favorite Snack</h4>
              <p id="favoriteSnackText" class="text-xs" contenteditable="false" style="min-height: 20px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;">Cookies</p>
              <button id="saveFavoriteSnackBtn" class="mt-2 px-2 py-1 rounded text-white text-xs" style="background: var(--md-coral);" onclick="saveAboutMeField('favoriteSnack')">ğŸ’¾</button>
            </div>
            <div class="bg-white rounded-xl p-4 text-center">
              <div class="text-2xl mb-2">ğŸ¥¤</div>
              <h4 class="font-semibold text-sm mb-1">Favorite Drink</h4>
              <p id="favoriteDrinkText" class="text-xs" contenteditable="false" style="min-height: 20px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;">Coffee</p>
              <button id="saveFavoriteDrinkBtn" class="mt-2 px-2 py-1 rounded text-white text-xs" style="background: var(--md-coral);" onclick="saveAboutMeField('favoriteDrink')">ğŸ’¾</button>
            </div>
            <div class="bg-white rounded-xl p-4 text-center">
              <div class="text-2xl mb-2">ğŸ“º</div>
              <h4 class="font-semibold text-sm mb-1">Favorite Show</h4>
              <p id="favoriteShowText" class="text-xs" contenteditable="false" style="min-height: 20px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px;">The Office</p>
              <button id="saveFavoriteShowBtn" class="mt-2 px-2 py-1 rounded text-white text-xs" style="background: var(--md-coral);" onclick="saveAboutMeField('favoriteShow')">ğŸ’¾</button>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- BIRTHDAYS TAB -->
    <section data-page-panel="birthdays" class="pagePanel fade-in">
      <h2 class="text-2xl font-display font-bold mb-6" style="color: var(--md-coral);">ğŸ‚ Birthdays</h2>
      <div id="classRosterSection" class="rounded-2xl shadow-soft p-6 sm:p-8 mb-8 bg-white" style="border: 1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%);">
        <div class="flex justify-between items-center mb-5">
          <h3 class="text-xl font-semibold">ğŸ‘¥ Class Roster</h3>
          <button id="saveClassRosterBtn" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveBirthdayField('classRoster')">ğŸ’¾ Save</button>
        </div>
        <textarea id="classRosterTextarea" class="w-full h-40 p-4 text-sm border rounded-lg resize-none" placeholder="â€¢ Type your student names here...
â€¢ One student per line
â€¢ Use bullet points or dashes">â€¢ Emma S.
â€¢ Jake M.
â€¢ Sarah L.
â€¢ Alex R.
â€¢ Mia K.
â€¢ Noah T.</textarea>
      </div>
      <div class="rounded-2xl shadow-soft p-6 sm:p-8" style="background: var(--md-cream);">
        <div class="flex justify-between items-center mb-5">
          <h3 class="text-xl font-semibold">ğŸ‚ Birthday Calendar</h3>
          <button id="saveAllBirthdaysBtn" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="saveAllBirthdays()">ğŸ’¾ Save All Birthdays</button>
        </div>
        
        <!-- Mobile Arrow Indicator -->
        <div class="md:hidden text-center text-sm text-gray-500 mb-4">
          â† Swipe to view all months â†’
        </div>
        
        <div class="birthday-months-mobile mobile-tab-scroll scrollbar-hide grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">â„ï¸ January</h4>
            <textarea id="januaryBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸ’• February</h4>
            <textarea id="februaryBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸŒ¸ March</h4>
            <textarea id="marchBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-slate) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸŒ· April</h4>
            <textarea id="aprilBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-pebble) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸŒº May</h4>
            <textarea id="mayBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">â˜€ï¸ June</h4>
            <textarea id="juneBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸ–ï¸ July</h4>
            <textarea id="julyBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-blush) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸŒ» August</h4>
            <textarea id="augustBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-slate) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸ September</h4>
            <textarea id="septemberBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays..."></textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-pebble) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸ‚ October</h4>
            <textarea id="octoberBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays...">15th â€“ Emma S.
28th â€“ Jake M.</textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-coral) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸ¦ƒ November</h4>
            <textarea id="novemberBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays...">12th â€“ Sarah L.
25th â€“ Alex R.</textarea>
          </div>
          <div class="birthday-month bg-white rounded-xl p-4" style="border: 1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%);">
            <h4 class="font-semibold mb-3">ğŸ„ December</h4>
            <textarea id="decemberBirthdaysTextarea" class="w-full h-20 p-2 text-sm border rounded resize-none" placeholder="Enter birthdays...">8th â€“ Mia K.
22nd â€“ Noah T.</textarea>
          </div>
        </div>
      </div>
    </section>
  </main>
  <footer class="bg-white border-t border-gray-200 mt-16">
    <div class="max-w-6xl mx-auto px-6 py-8">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-600">Â© 2025 Mr. Davis's First Grade Class</p>
        </div>
        <div class="flex gap-3">
          <button id="saveChangesBtn" class="px-4 py-2 rounded-xl font-semibold text-white shadow-soft" style="background: var(--md-coral); display: none;">
            ğŸ’¾ Save Changes
          </button>
          <button id="toggleHighContrast"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white text-[color:var(--md-ink)] font-semibold hover:opacity-90">
            <span>ğŸŒ“</span><span>Light/Dark</span>
          </button>
          <button id="editModeBtn" class="px-4 py-2 rounded-xl font-semibold text-white shadow-soft" style="background: var(--md-slate);">
            âœï¸ Edit Mode
          </button>
        </div>
      </div>
    </div>
  </footer>
  <div id="pinOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center" style="z-index: 2000;">
    <div class="bg-white rounded-2xl shadow-soft p-8 max-w-md w-full mx-4">
      <h3 class="text-xl font-display font-bold mb-4 text-center">ğŸ”’ Teacher Access</h3>
      <p class="text-center text-gray-600 mb-6">Enter your PIN to edit this page</p>
      <div class="space-y-4">
        <input id="pinInput" type="password" placeholder="Enter PIN" class="w-full px-4 py-3 rounded-xl border text-center text-lg">
        <div class="flex gap-3">
          <button id="pinCancel" class="flex-1 px-4 py-3 rounded-xl border font-semibold">Cancel</button>
          <button id="pinSubmit" class="flex-1 px-4 py-3 rounded-xl font-semibold text-white" style="background: var(--md-slate);">Enter</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Clever QR Codes Panel -->
  <div id="cleverQRPanel" class="fixed inset-0 bg-black/80 flex items-center justify-center" style="z-index: 2000; display: none;">
    <div class="bg-white rounded-2xl shadow-soft p-6 sm:p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-display font-bold" style="color: var(--md-mustard);">ğŸ“± Clever QR Codes</h3>
        <button onclick="closeCleverQRPanel()" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
      </div>
      <div id="cleverQRSearchBar" class="mb-4" style="display: none;">
        <input id="cleverQRSearchInput" type="text" placeholder="Type scholar's full first or last name and press Enter" 
               class="w-full px-4 py-2 text-sm border rounded-lg" 
               onkeypress="if(event.key === 'Enter') searchCleverQR()">
      </div>
      <div id="cleverQRContent" class="space-y-4">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div id="cleverQREditControls" class="mt-6 space-y-3" style="display: none;">
        <div class="flex gap-2">
          <input id="newStudentName" type="text" placeholder="Student name" class="flex-1 px-3 py-2 text-sm border rounded-lg">
          <input id="newStudentQR" type="url" placeholder="QR code URL" class="flex-1 px-3 py-2 text-sm border rounded-lg">
          <button onclick="addCleverQREntry()" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-mustard);">Add</button>
        </div>
        <button id="saveCleverQRBtn" onclick="saveCleverQRData()" class="w-full px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-slate);">ğŸ’¾ Save All Changes</button>
      </div>
    </div>
  </div>
  <div id="classDojoQRPanel" class="fixed inset-0 bg-black/80 flex items-center justify-center" style="z-index: 2000; display: none;">
    <div class="bg-white rounded-2xl shadow-soft p-6 sm:p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-display font-bold" style="color: var(--md-slate);">ğŸ“± ClassDojo QR Codes</h3>
        <button onclick="closeClassDojoQRPanel()" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
      </div>
      <div id="classDojoQRSearchBar" class="mb-4" style="display: none;">
        <input id="classDojoQRSearchInput" type="text" placeholder="Type scholar's full first or last name and press Enter" 
               class="w-full px-4 py-2 text-sm border rounded-lg" 
               onkeypress="if(event.key === 'Enter') searchClassDojoQR()">
      </div>
      <div id="classDojoQRContent" class="space-y-4">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div id="classDojoQREditControls" class="mt-6 space-y-3" style="display: none;">
        <div class="flex gap-2">
          <input id="newClassDojoStudentName" type="text" placeholder="Student name" class="flex-1 px-3 py-2 text-sm border rounded-lg">
          <input id="newClassDojoStudentQR" type="url" placeholder="QR code URL" class="flex-1 px-3 py-2 text-sm border rounded-lg">
          <button onclick="addClassDojoQREntry()" class="px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-slate);">Add</button>
        </div>
        <button id="saveClassDojoQRBtn" onclick="saveClassDojoQRData()" class="w-full px-4 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-slate);">ğŸ’¾ Save All Changes</button>
      </div>
    </div>
  </div>
  <script>
    // Global variables
    let isOwner = false; // Track if current user is the repository owner
    
    // Shoutout system variables
    let allShoutouts = []; // All submitted shoutouts
    let approvedShoutouts = []; // Only approved shoutouts for shuffle
    let currentShoutoutIndex = 0; // For shuffling through approved shoutouts
    let mainTVMessage = 'Welcome to our amazing first grade classroom! Keep being awesome, scholars!'; // Main TV message
    
    // Clever QR Codes data
    let cleverQRData = []; // Array of {name: string, qrUrl: string}
    
    // ClassDojo QR Codes data
    let classDojoQRData = []; // Array of {name: string, qrUrl: string}
    
    // Watch Me data structures for Skills, Listening, and Math tabs
    let watchMeData = {
      skills: [],    // Array of {title: string, url: string}
      listening: [], // Array of {title: string, url: string}
      math: []       // Array of {title: string, url: string}
    };
    
    // Tab navigation
    function showPage(pageId) {
      document.querySelectorAll('.pagePanel').forEach(panel => {
        panel.classList.remove('active','visible');
        if(panel.dataset.pagePanel === pageId){
          panel.classList.add('active');
          setTimeout(()=>panel.classList.add('visible'),10);
        }
      });
      document.querySelectorAll('.pageTab').forEach(btn => {
        btn.classList.remove('active','ring-4','ring-white/40');
        if(btn.dataset.page === pageId){
          btn.classList.add('active','ring-4','ring-white/40');
        }
      });
    }
    document.addEventListener('DOMContentLoaded',function(){
      showPage('home');
      document.querySelectorAll('.pageTab').forEach(btn=>{
        btn.addEventListener('click',function(e){
          e.preventDefault();
          showPage(btn.dataset.page);
        });
      });
      // Edit Mode PIN overlay logic
      const TEACHER_PIN = '2213';
      const OWNER_PIN = '8875'; // Separate PIN for repository owner (davisg230-collab)
      
      // Initialize read-only state on page load
      initializeReadOnlyState();
      
      document.getElementById('editModeBtn').onclick = function() {
        document.getElementById('pinOverlay').classList.add('show');
        document.getElementById('pinInput').focus();
      };
      document.getElementById('pinCancel').onclick = function() {
        document.getElementById('pinOverlay').classList.remove('show');
        document.getElementById('pinInput').value = '';
      };
      document.getElementById('pinSubmit').onclick = async function() {
        var pin = document.getElementById('pinInput').value;
        if(pin === TEACHER_PIN){
          isOwner = false;
          await enterEditMode();
          document.getElementById('pinOverlay').classList.remove('show');
        } else if(pin === OWNER_PIN){
          isOwner = true;
          await enterEditMode();
          document.getElementById('pinOverlay').classList.remove('show');
        } else {
          document.getElementById('pinInput').style.borderColor='#ef4444';
          setTimeout(()=>{document.getElementById('pinInput').style.borderColor='';},900);
        }
      };
      // Light/Dark toggle
      document.getElementById('toggleHighContrast').onclick=function(){
        document.body.classList.toggle('dark');
      };
      
      // Save Changes button
      document.getElementById('saveChangesBtn').onclick = saveChangesToFirestore;
    });
    
    // Track original values for change detection
    let originalValues = {};
    
    function storeOriginalValues() {
      originalValues = {};
      document.querySelectorAll('[data-edit="teacher"]').forEach((el, index) => {
        const key = `element_${index}`;
        if (el.tagName === 'UL') {
          // For lists, store the inner HTML
          originalValues[key] = el.innerHTML;
        } else {
          // For text content
          originalValues[key] = el.textContent || el.innerText || '';
        }
      });
    }
    
    function hasChanges() {
      let hasChanges = false;
      document.querySelectorAll('[data-edit="teacher"]').forEach((el, index) => {
        const key = `element_${index}`;
        const originalValue = originalValues[key] || '';
        let currentValue = '';
        
        if (el.tagName === 'UL') {
          currentValue = el.innerHTML;
        } else {
          currentValue = el.textContent || el.innerText || '';
        }
        
        if (originalValue !== currentValue) {
          hasChanges = true;
        }
      });
      return hasChanges;
    }
    
    
    function initializeReadOnlyState() {
      // Disable About Me section
      const aboutMeDescText = document.getElementById('aboutMeDescText');
      if (aboutMeDescText) aboutMeDescText.contentEditable = false;
      const funFactsList = document.getElementById('funFactsList');
      if (funFactsList) funFactsList.contentEditable = false;
      const favoriteColorText = document.getElementById('favoriteColorText');
      if (favoriteColorText) favoriteColorText.contentEditable = false;
      const favoriteSnackText = document.getElementById('favoriteSnackText');
      if (favoriteSnackText) favoriteSnackText.contentEditable = false;
      const favoriteDrinkText = document.getElementById('favoriteDrinkText');
      if (favoriteDrinkText) favoriteDrinkText.contentEditable = false;
      const favoriteShowText = document.getElementById('favoriteShowText');
      if (favoriteShowText) favoriteShowText.contentEditable = false;
      const aboutMeSaveButtons = ['saveAboutMeDescBtn', 'saveFunFactsBtn', 'saveFavoriteColorBtn', 'saveFavoriteSnackBtn', 'saveFavoriteDrinkBtn', 'saveFavoriteShowBtn'];
      aboutMeSaveButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.style.display = 'none';
      });
      
      // Disable Class Roster section and hide it by default
      const classRosterSection = document.getElementById('classRosterSection');
      const classRosterTextarea = document.getElementById('classRosterTextarea');
      const saveClassRosterBtn = document.getElementById('saveClassRosterBtn');
      
      if (classRosterSection) classRosterSection.style.display = 'none';
      if (classRosterTextarea) { classRosterTextarea.disabled = true; classRosterTextarea.readOnly = true; }
      if (saveClassRosterBtn) saveClassRosterBtn.style.display = 'none';
      
      // Disable Birthday sections
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      months.forEach(month => {
        const monthTextarea = document.getElementById(`${month}BirthdaysTextarea`);
        if (monthTextarea) { monthTextarea.disabled = true; monthTextarea.readOnly = true; }
      });
      const saveAllBirthdaysBtn = document.getElementById('saveAllBirthdaysBtn');
      if (saveAllBirthdaysBtn) saveAllBirthdaysBtn.style.display = 'none';
      
      // Disable Practice Websites section  
      document.querySelectorAll('.website-url-input').forEach(input => {
        input.disabled = true;
        input.readOnly = true;
      });
      const saveWebsitesBtn = document.getElementById('saveWebsitesBtn');
      if (saveWebsitesBtn) saveWebsitesBtn.style.display = 'none';
      const saveWebsiteOrderBtn = document.getElementById('saveWebsiteOrderBtn');
      if (saveWebsiteOrderBtn) saveWebsiteOrderBtn.style.display = 'none';
      
      // Disable drag-and-drop for website cards
      disableWebsiteDragAndDrop();
      
      // Disable Extras section
      const saveExtrasBtn = document.getElementById('saveExtrasBtn');
      if (saveExtrasBtn) saveExtrasBtn.style.display = 'none';
      const addExtrasCardBtn = document.getElementById('addExtrasCardBtn');
      if (addExtrasCardBtn) addExtrasCardBtn.style.display = 'none';
      
      // Disable Extras contenteditable elements and remove buttons
      document.querySelectorAll('#extrasGrid [contenteditable]').forEach(el => {
        el.contentEditable = false;
        el.style.cursor = 'default';
      });
      document.querySelectorAll('#extrasGrid button[onclick*="remove"]').forEach(btn => {
        btn.style.display = 'none';
      });
      
      // Disable Transportation instructions section
      const transportationInstructionsTextarea = document.getElementById('transportationInstructionsTextarea');
      const saveTransportationInstructionsBtn = document.getElementById('saveTransportationInstructionsBtn');
      if (transportationInstructionsTextarea) { 
        transportationInstructionsTextarea.disabled = true; 
        transportationInstructionsTextarea.readOnly = true; 
      }
      if (saveTransportationInstructionsBtn) saveTransportationInstructionsBtn.style.display = 'none';
    }
    
    async function enterEditMode(){
      // Authenticate with Firebase before enabling edit mode
      try {
        if (!auth) {
          console.error('Firebase auth not available');
          alert('Authentication failed. Please refresh the page and try again.');
          return;
        }
        
        // Check if user is signed in with Google
        const isGoogleUser = auth.currentUser && auth.currentUser.providerData.some(
          provider => provider.providerId === 'google.com'
        );
        
        if (!isGoogleUser) {
          // Trigger Google Sign-In
          console.log('Initiating Google Sign-In...');
          const provider = new firebase.auth.GoogleAuthProvider();
          try {
            await auth.signInWithPopup(provider);
            console.log('Google Sign-In successful');
          } catch (error) {
            console.error('Google Sign-In failed:', error);
            alert('Google Sign-In is required to enter edit mode. Please try again.');
            return;
          }
        }
        
        // Validate the user's email
        if (!auth.currentUser || auth.currentUser.email !== 'davisg230@gmail.com') {
          console.error('Unauthorized user:', auth.currentUser?.email);
          alert('Access denied. Only davisg230@gmail.com can edit this page.');
          // Sign out the unauthorized user
          await auth.signOut();
          return;
        }
        
        console.log('Authentication successful for authorized user');
      } catch (error) {
        console.error('Firebase authentication failed:', error);
        alert('Authentication failed: ' + error.message);
        return;
      }
      
      storeOriginalValues();
      document.body.classList.add('editing');
      document.querySelectorAll('[data-edit="teacher"]').forEach(el=>el.contentEditable=true);
      document.querySelectorAll('.teacher-only-edit').forEach(el=>{el.disabled=false;el.readOnly=false;});
      // Enable snack message textarea and show edit controls
      const snackMessage = document.getElementById('snackMessage');
      if (snackMessage) {
        snackMessage.disabled = false;
        snackMessage.readOnly = false;
      }
      // Show edit-only elements
      document.querySelectorAll('.edit-only').forEach(el => {
        el.style.display = 'block';
      });
      
      // Enable About Me section
      const aboutMeDescText = document.getElementById('aboutMeDescText');
      if (aboutMeDescText) aboutMeDescText.contentEditable = true;
      const funFactsList = document.getElementById('funFactsList');
      if (funFactsList) funFactsList.contentEditable = true;
      const favoriteColorText = document.getElementById('favoriteColorText');
      if (favoriteColorText) favoriteColorText.contentEditable = true;
      const favoriteSnackText = document.getElementById('favoriteSnackText');
      if (favoriteSnackText) favoriteSnackText.contentEditable = true;
      const favoriteDrinkText = document.getElementById('favoriteDrinkText');
      if (favoriteDrinkText) favoriteDrinkText.contentEditable = true;
      const favoriteShowText = document.getElementById('favoriteShowText');
      if (favoriteShowText) favoriteShowText.contentEditable = true;
      const aboutMeSaveButtons = ['saveAboutMeDescBtn', 'saveFunFactsBtn', 'saveFavoriteColorBtn', 'saveFavoriteSnackBtn', 'saveFavoriteDrinkBtn', 'saveFavoriteShowBtn'];
      aboutMeSaveButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.style.display = 'inline-block';
      });
      
      // Enable Class Roster section (owner only)
      const classRosterSection = document.getElementById('classRosterSection');
      const classRosterTextarea = document.getElementById('classRosterTextarea');
      const saveClassRosterBtn = document.getElementById('saveClassRosterBtn');
      
      if (isOwner) {
        // Show and enable roster section for owner
        if (classRosterSection) classRosterSection.style.display = 'block';
        if (classRosterTextarea) { classRosterTextarea.disabled = false; classRosterTextarea.readOnly = false; }
        if (saveClassRosterBtn) saveClassRosterBtn.style.display = 'inline-block';
      } else {
        // Hide roster section for non-owners
        if (classRosterSection) classRosterSection.style.display = 'none';
      }
      
      // Enable Birthday sections
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      months.forEach(month => {
        const monthTextarea = document.getElementById(`${month}BirthdaysTextarea`);
        if (monthTextarea) { monthTextarea.disabled = false; monthTextarea.readOnly = false; }
      });
      const saveAllBirthdaysBtn = document.getElementById('saveAllBirthdaysBtn');
      if (saveAllBirthdaysBtn) saveAllBirthdaysBtn.style.display = 'inline-block';
      
      // Enable Practice Websites section  
      document.querySelectorAll('.website-url-input').forEach(input => {
        input.disabled = false;
        input.readOnly = false;
      });
      const saveWebsitesBtn = document.getElementById('saveWebsitesBtn');
      if (saveWebsitesBtn) saveWebsitesBtn.style.display = 'inline-block';
      const saveWebsiteOrderBtn = document.getElementById('saveWebsiteOrderBtn');
      if (saveWebsiteOrderBtn) saveWebsiteOrderBtn.style.display = 'inline-block';
      
      // Enable drag-and-drop for website cards
      setupWebsiteDragAndDrop();
      
      // Enable Extras section
      const saveExtrasBtn = document.getElementById('saveExtrasBtn');
      if (saveExtrasBtn) saveExtrasBtn.style.display = 'inline-block';
      const addExtrasCardBtn = document.getElementById('addExtrasCardBtn');
      if (addExtrasCardBtn) addExtrasCardBtn.style.display = 'inline-block';
      
      // Enable Extras contenteditable elements and remove buttons
      document.querySelectorAll('#extrasGrid [contenteditable]').forEach(el => {
        el.contentEditable = true;
        el.style.cursor = 'text';
      });
      document.querySelectorAll('#extrasGrid button[onclick*="remove"]').forEach(btn => {
        btn.style.display = 'inline-block';
      });
      
      // Enable Transportation instructions section
      const transportationInstructionsTextarea = document.getElementById('transportationInstructionsTextarea');
      const saveTransportationInstructionsBtn = document.getElementById('saveTransportationInstructionsBtn');
      if (transportationInstructionsTextarea) { 
        transportationInstructionsTextarea.disabled = false; 
        transportationInstructionsTextarea.readOnly = false; 
      }
      if (saveTransportationInstructionsBtn) saveTransportationInstructionsBtn.style.display = 'inline-block';

      
      // Update gallery images clickable state (disable when in edit mode)
      document.querySelectorAll('.gallery-imgs img').forEach(img => {
        const galleryContainer = img.closest('.gallery-imgs');
        const galleryType = galleryContainer ? galleryContainer.getAttribute('data-gallery-type') : '';
        makeGalleryImageClickable(img, galleryType);
      });
      
      // Update home page images clickable state (disable when in edit mode)
      document.querySelectorAll('.photo-card img').forEach(img => {
        img.style.cursor = 'default';
        img.onclick = null;
      });
      
      document.getElementById('editModeBtn').textContent = 'ğŸ’¾ Exit Edit Mode';
      document.getElementById('editModeBtn').onclick = exitEditMode;
      
      // Re-render Watch Me boxes for edit mode
      renderWatchMeContent('skills');
      renderWatchMeContent('listening');
      renderWatchMeContent('math');
    }
    function exitEditMode(){
      isOwner = false; // Reset owner status when exiting edit mode
      document.body.classList.remove('editing');
      document.querySelectorAll('[data-edit="teacher"]').forEach(el=>el.contentEditable=false);
      document.querySelectorAll('.teacher-only-edit').forEach(el=>{el.disabled=true;el.readOnly=true;});
      // Disable snack message textarea and hide edit controls
      const snackMessage = document.getElementById('snackMessage');
      if (snackMessage) {
        snackMessage.disabled = true;
        snackMessage.readOnly = true;
      }
      // Hide edit-only elements
      document.querySelectorAll('.edit-only').forEach(el => {
        el.style.display = 'none';
      });
      
      // Disable About Me section
      const aboutMeDescText = document.getElementById('aboutMeDescText');
      if (aboutMeDescText) aboutMeDescText.contentEditable = false;
      const funFactsList = document.getElementById('funFactsList');
      if (funFactsList) funFactsList.contentEditable = false;
      const favoriteColorText = document.getElementById('favoriteColorText');
      if (favoriteColorText) favoriteColorText.contentEditable = false;
      const favoriteSnackText = document.getElementById('favoriteSnackText');
      if (favoriteSnackText) favoriteSnackText.contentEditable = false;
      const favoriteDrinkText = document.getElementById('favoriteDrinkText');
      if (favoriteDrinkText) favoriteDrinkText.contentEditable = false;
      const favoriteShowText = document.getElementById('favoriteShowText');
      if (favoriteShowText) favoriteShowText.contentEditable = false;
      const aboutMeSaveButtons = ['saveAboutMeDescBtn', 'saveFunFactsBtn', 'saveFavoriteColorBtn', 'saveFavoriteSnackBtn', 'saveFavoriteDrinkBtn', 'saveFavoriteShowBtn'];
      aboutMeSaveButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.style.display = 'none';
      });
      
      // Disable Class Roster section and hide it
      const classRosterSection = document.getElementById('classRosterSection');
      const classRosterTextarea = document.getElementById('classRosterTextarea');
      const saveClassRosterBtn = document.getElementById('saveClassRosterBtn');
      
      if (classRosterSection) classRosterSection.style.display = 'none';
      if (classRosterTextarea) { classRosterTextarea.disabled = true; classRosterTextarea.readOnly = true; }
      if (saveClassRosterBtn) saveClassRosterBtn.style.display = 'none';
      
      // Disable Birthday sections
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      months.forEach(month => {
        const monthTextarea = document.getElementById(`${month}BirthdaysTextarea`);
        if (monthTextarea) { monthTextarea.disabled = true; monthTextarea.readOnly = true; }
      });
      const saveAllBirthdaysBtn = document.getElementById('saveAllBirthdaysBtn');
      if (saveAllBirthdaysBtn) saveAllBirthdaysBtn.style.display = 'none';
      
      // Disable Practice Websites section  
      document.querySelectorAll('.website-url-input').forEach(input => {
        input.disabled = true;
        input.readOnly = true;
      });
      const saveWebsitesBtn = document.getElementById('saveWebsitesBtn');
      if (saveWebsitesBtn) saveWebsitesBtn.style.display = 'none';
      const saveWebsiteOrderBtn2 = document.getElementById('saveWebsiteOrderBtn');
      if (saveWebsiteOrderBtn2) saveWebsiteOrderBtn2.style.display = 'none';
      
      // Disable drag-and-drop for website cards
      disableWebsiteDragAndDrop();
      
      // Disable Extras section
      const saveExtrasBtn = document.getElementById('saveExtrasBtn');
      if (saveExtrasBtn) saveExtrasBtn.style.display = 'none';
      const addExtrasCardBtn = document.getElementById('addExtrasCardBtn');
      if (addExtrasCardBtn) addExtrasCardBtn.style.display = 'none';
      
      // Disable Extras contenteditable elements and remove buttons
      document.querySelectorAll('#extrasGrid [contenteditable]').forEach(el => {
        el.contentEditable = false;
        el.style.cursor = 'default';
      });
      document.querySelectorAll('#extrasGrid button[onclick*="remove"]').forEach(btn => {
        btn.style.display = 'none';
      });
      
      // Disable Transportation instructions section
      const transportationInstructionsTextarea = document.getElementById('transportationInstructionsTextarea');
      const saveTransportationInstructionsBtn = document.getElementById('saveTransportationInstructionsBtn');
      if (transportationInstructionsTextarea) { 
        transportationInstructionsTextarea.disabled = true; 
        transportationInstructionsTextarea.readOnly = true; 
      }
      if (saveTransportationInstructionsBtn) saveTransportationInstructionsBtn.style.display = 'none';

      
      // Update gallery images clickable state (enable when not in edit mode)
      document.querySelectorAll('.gallery-imgs img').forEach(img => {
        const galleryContainer = img.closest('.gallery-imgs');
        const galleryType = galleryContainer ? galleryContainer.getAttribute('data-gallery-type') : '';
        makeGalleryImageClickable(img, galleryType);
      });
      
      // Update home page images clickable state (enable when not in edit mode)
      document.querySelectorAll('.photo-card img').forEach(img => {
        if (img.src && img.src !== '') {
          img.style.cursor = 'pointer';
          img.onclick = function(e) {
            e.stopPropagation();
            openImageModal(img.src);
          };
        }
      });
      
      document.getElementById('editModeBtn').textContent = 'âœï¸ Edit Mode';
      document.getElementById('editModeBtn').onclick = function(){
        document.getElementById('pinOverlay').classList.add('show');
        document.getElementById('pinInput').focus();
      };
      
      // Check for changes and show/hide save button
      const saveBtn = document.getElementById('saveChangesBtn');
      if (hasChanges()) {
        saveBtn.style.display = 'block';
      } else {
        saveBtn.style.display = 'none';
      }
      
      // Re-render Watch Me boxes for view mode
      renderWatchMeContent('skills');
      renderWatchMeContent('listening');
      renderWatchMeContent('math');
    }
    function collectEditableFieldData() {
      const data = {};
      
      // Week text
      const weekEl = document.getElementById('weekText');
      if (weekEl) data.week = weekEl.textContent || '';
      
      // Recap text
      const recapEl = document.getElementById('recapText');
      if (recapEl) data.recap = recapEl.textContent || '';
      
      // Events list - collect all event items
      const eventsContainer = document.getElementById('eventsList');
      if (eventsContainer) {
        const events = [];
        eventsContainer.querySelectorAll('.event-item').forEach(item => {
          const emoji = item.querySelector('.event-emoji')?.textContent || '';
          const text = item.querySelector('.event-text')?.textContent || '';
          if (text) {
            events.push({ icon: emoji, text: text });
          }
        });
        data.dates_json = JSON.stringify(events);
      }
      
      // Looking ahead items
      const lookingAheadSection = Array.from(document.querySelectorAll('div.rounded-2xl')).find(div =>
        div.querySelector('h3') && div.querySelector('h3').textContent.includes('Looking Ahead')
      );
      if (lookingAheadSection) {
        const ul = lookingAheadSection.querySelector('ul[data-edit="teacher"]');
        if (ul) {
          const items = Array.from(ul.querySelectorAll('li')).map(li => li.textContent.replace(/^â€¢\s*/, ''));
          data.looking_ahead = items.join('\n');
        }
      }
      
      // Snacks grid - collect snack items with checkbox states
      const snacksGrid = document.getElementById('snacksGrid');
      if (snacksGrid) {
        const snacks = [];
        snacksGrid.querySelectorAll('.p-4').forEach(card => {
          const emoji = card.querySelector('.text-xl')?.textContent || '';
          const item = card.querySelector('.snack-title')?.textContent || '';
          const claimedBy = card.querySelector('.snack-name')?.value || '';
          const checked = card.querySelector('.snack-checkbox')?.checked || false;
          const isDefault = card.getAttribute('data-default-snack') === 'true';
          if (item) {
            snacks.push({ 
              emoji: emoji, 
              item: item, 
              claimed_by: claimedBy, 
              checked: checked,
              is_default: isDefault
            });
          }
        });
        data.snacks_json = JSON.stringify(snacks);
      }
      
      // Snack message
      const snackMessageEl = document.getElementById('snackMessage');
      if (snackMessageEl) data.snack_message = snackMessageEl.value || '';
      
      // Scholar info
      const scholarNameEl = document.querySelector('[data-page-panel="scholar"] h3[data-edit="teacher"]');
      if (scholarNameEl) data.scholar_name = scholarNameEl.textContent || '';
      
      const scholarBlurbEl = document.querySelector('[data-page-panel="scholar"] p[data-edit="teacher"]:not(.text-lg.font-semibold)');
      if (scholarBlurbEl) data.scholar_blurb = scholarBlurbEl.textContent || '';
      
      const scholarSkillEl = document.querySelector('[data-page-panel="scholar"] p.text-lg.font-semibold[data-edit="teacher"]');
      if (scholarSkillEl) data.scholar_skill = scholarSkillEl.textContent || '';
      
      // Skills section
      const skillsDescEl = document.querySelector('[data-page-panel="skills"] p[data-edit="teacher"]');
      if (skillsDescEl) data.skills_text = skillsDescEl.textContent || '';
      
      const skillsUl = document.querySelector('[data-page-panel="skills"] ul[data-edit="teacher"]');
      if (skillsUl) {
        const sounds = Array.from(skillsUl.querySelectorAll('li')).map(li => li.textContent);
        data.sounds_json = JSON.stringify(sounds);
      }
      
      // Listening section
      const listeningDescEl = document.querySelector('[data-page-panel="listening"] p[data-edit="teacher"]');
      if (listeningDescEl) data.listening_text = listeningDescEl.textContent || '';
      
      const listeningUl = document.querySelector('[data-page-panel="listening"] ul[data-edit="teacher"]');
      if (listeningUl) {
        const asks = Array.from(listeningUl.querySelectorAll('li')).map(li => li.textContent);
        data.ask_json = JSON.stringify(asks);
      }
      
      // Math section
      const mathDescEl = document.querySelector('[data-page-panel="math"] p[data-edit="teacher"]');
      if (mathDescEl) data.math_text = mathDescEl.textContent || '';
      
      const mathUl = document.querySelector('[data-page-panel="math"] ul[data-edit="teacher"]');
      if (mathUl) {
        const vocab = Array.from(mathUl.querySelectorAll('li')).map(li => li.textContent);
        data.math_vocab_json = JSON.stringify(vocab);
      }
      
      // Calendar URL - read from input field, fallback to link href
      const calendarInput = document.getElementById('calendarUrlInput');
      const calendarLink = document.getElementById('schoolCalendarLink');
      if (calendarInput && calendarInput.value) {
        data.calendar_url = calendarInput.value;
      } else if (calendarLink) {
        data.calendar_url = calendarLink.href || '';
      }
      
      // Photo cards URLs
      const photoCards = document.querySelectorAll('.photo-card');
      const photoUrls = [];
      photoCards.forEach(card => {
        const url = card.getAttribute('data-photo-url') || '';
        photoUrls.push(url);
      });
      data.photo_urls_json = JSON.stringify(photoUrls);
      
      // Specials images URLs (two images per subject)
      const specialsImages = {};
      ['art', 'stem', 'gym', 'music'].forEach(type => {
        const slot0 = document.querySelector(`[data-specials-type="${type}"][data-slot-index="0"]`);
        const slot1 = document.querySelector(`[data-specials-type="${type}"][data-slot-index="1"]`);
        
        specialsImages[type] = [
          slot0 ? (slot0.getAttribute('data-image-url') || '') : '',
          slot1 ? (slot1.getAttribute('data-image-url') || '') : ''
        ];
      });
      data.gallery_urls_json = JSON.stringify(specialsImages);
      
      // Transportation fields
      const busRidersEl = document.getElementById('busRidersTextarea');
      if (busRidersEl) data.bus_riders = busRidersEl.value || '';
      
      const carRidersEl = document.getElementById('carRidersTextarea');
      if (carRidersEl) data.car_riders = carRidersEl.value || '';
      
      const porchPickupEl = document.getElementById('porchPickupTextarea');
      if (porchPickupEl) data.porch_pickup = porchPickupEl.value || '';
      
      // Birthday fields
      const classRosterEl = document.getElementById('classRosterTextarea');
      if (classRosterEl) data.class_roster = classRosterEl.value || '';
      
      // Monthly birthday fields
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                      'july', 'august', 'september', 'october', 'november', 'december'];
      months.forEach(month => {
        const monthEl = document.getElementById(`${month}BirthdaysTextarea`);
        if (monthEl) data[`${month}_birthdays`] = monthEl.value || '';
      });
      
      // About Me fields
      const aboutMeDescEl = document.getElementById('aboutMeDescText');
      if (aboutMeDescEl) data.about_me_html = aboutMeDescEl.innerHTML || '';
      
      const funFactsEl = document.getElementById('funFactsList');
      if (funFactsEl) {
        // Extract list items from the contenteditable ul
        const listItems = Array.from(funFactsEl.querySelectorAll('li')).map(li => li.textContent || '');
        data.fun_facts_html = listItems;
      }
      
      const favoriteColorEl = document.getElementById('favoriteColorText');
      if (favoriteColorEl) data.favorite_color = favoriteColorEl.textContent || '';
      
      const favoriteSnackEl = document.getElementById('favoriteSnackText');
      if (favoriteSnackEl) data.favorite_snack = favoriteSnackEl.textContent || '';
      
      const favoriteDrinkEl = document.getElementById('favoriteDrinkText');
      if (favoriteDrinkEl) data.favorite_drink = favoriteDrinkEl.textContent || '';
      
      const favoriteShowEl = document.getElementById('favoriteShowText');
      if (favoriteShowEl) data.favorite_show = favoriteShowEl.textContent || '';
      
      // Extras cards
      const extrasGrid = document.getElementById('extrasGrid');
      if (extrasGrid) {
        const extras = [];
        extrasGrid.querySelectorAll('.text-center').forEach(card => {
          const emojiEl = card.querySelector('.emoji-edit, [data-edit="teacher"]');
          const titleEl = card.querySelector('h3');
          const bodyEl = card.querySelector('p');
          
          if (titleEl && bodyEl) {
            extras.push({
              emoji: emojiEl ? emojiEl.textContent || 'âœ¨' : 'âœ¨',
              title: titleEl.textContent || '',
              body_html: bodyEl.textContent || ''
            });
          }
        });
        data.extras_json = JSON.stringify(extras);
      }
      
      // Website URLs
      const websiteCards = document.querySelectorAll('.website-card');
      const websites = [];
      websiteCards.forEach((card, index) => {
        const titleEl = card.querySelector('.website-title');
        const urlInput = card.querySelector('.website-url-input');
        const linkEl = card.querySelector('.website-link');
        const emojiEl = card.querySelector('.text-4xl');
        const websiteId = card.getAttribute('data-website-id');
        
        if (titleEl) {
          websites.push({
            id: websiteId || `website-${index}`,
            order: index,
            title: titleEl.textContent || '',
            url: urlInput?.value || linkEl?.href || '',
            emoji: emojiEl?.textContent || '',
            styles: {
              border: card.style.border || '',
              background: linkEl?.style.background || ''
            }
          });
        }
      });
      data.websites_json = JSON.stringify(websites);
      
      // Profile photos URLs - using more specific selectors
      const scholarProfileEl = document.querySelector('[onclick*="editProfilePhoto"][onclick*="scholar"]');
      if (scholarProfileEl) {
        data.scholar_profile_url = scholarProfileEl.getAttribute('data-profile-url') || '';
      }
      
      const aboutMeProfileEl = document.querySelector('[onclick*="editProfilePhoto"][onclick*="aboutme"]');
      if (aboutMeProfileEl) {
        data.about_me_profile_url = aboutMeProfileEl.getAttribute('data-profile-url') || '';
      }
      
      // Watch Me links
      data.watch_me_json = JSON.stringify(watchMeData);
      
      return data;
    }
    
    async function saveChangesToFirestore() {
      const saveBtn = document.getElementById('saveChangesBtn');
      const originalText = saveBtn.textContent;
      
      try {
        // Check authentication before saving
        await ensureAuthenticated();
        
        // Set saving flag to prevent periodic refresh interference
        isSaving = true;
        
        // Show saving state
        saveBtn.textContent = 'â³ Saving...';
        saveBtn.disabled = true;
        
        // Collect all editable field data
        const data = collectEditableFieldData();
        
        console.log('Saving data to Firestore:', data);
        
        // Save to Firestore
        await db.collection('classData').doc('current').set(data, { merge: true });
        
        console.log('Data saved successfully to Firestore');
        
        // Show success state
        saveBtn.textContent = 'âœ… Saved!';
        
        // Reload data from Firestore after a delay to ensure consistency
        setTimeout(async () => {
          try {
            const updatedData = await fetchFirestoreData();
            populateDataFromSheet(updatedData);
            
            // Hide save button and reset original values
            saveBtn.style.display = 'none';
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            originalValues = {};
          } catch (error) {
            console.error('Failed to reload data after save:', error);
            // Still hide the save button even if reload fails
            saveBtn.style.display = 'none';
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          } finally {
            // Always clear the saving flag
            isSaving = false;
          }
        }, 1000);
        
      } catch (error) {
        console.error('Failed to save changes:', error);
        saveBtn.textContent = 'âŒ Save Failed';
        
        // Show detailed error in UI
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
        errorDiv.innerHTML = `
          <div class="flex">
            <div class="flex-shrink-0">
              <span class="text-red-500">âš ï¸</span>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium">Save Failed</p>
              <p class="text-sm">${error.message || 'Unknown error occurred'}</p>
            </div>
            <div class="ml-auto pl-3">
              <button class="text-red-400 hover:text-red-600" onclick="this.parentElement.parentElement.parentElement.remove()">
                <span class="sr-only">Dismiss</span>
                âœ•
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(errorDiv);
        
        // Auto-remove error after 5 seconds
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
          }
        }, 5000);
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
          isSaving = false;
        }, 2000);
      }
    }
    
    // Home tab: Add event
    function addEvent() {
      // Create event directly editable on the page instead of using prompts
      const div = document.createElement('div');
      div.className = 'event-item flex items-center gap-3 p-3 rounded-xl bg-yellow-50 border';
      div.style.borderColor = 'var(--md-mustard)';
      div.innerHTML = `
        <span class="event-emoji text-xl" data-edit="teacher" contenteditable="true">ğŸ‰</span>
        <span class="event-text font-semibold flex-1" data-edit="teacher" contenteditable="true">Click to edit event</span>
        <button class="edit-only text-red-500 hover:text-red-700" onclick="this.parentNode.remove()">âœ–</button>
      `;
      document.getElementById('eventsList').appendChild(div);
      
      // Auto-focus the text field for immediate editing
      const textSpan = div.querySelector('.event-text');
      textSpan.focus();
      textSpan.select();
    }
    // Home tab: Add snack
    function addSnackItem() {
      // Create new snack card that parents can edit (user-added, not default)
      const newSnack = document.createElement('div');
      newSnack.className = 'p-4 rounded-xl bg-white user-added-snack-card';
      newSnack.setAttribute('data-default-snack', 'false');
      newSnack.style.border = '1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%)';
      
      // Get the highest current tabindex to continue sequence
      const existingCheckboxes = document.querySelectorAll('.snack-checkbox');
      let nextTabIndex = (existingCheckboxes.length * 3) + 1;
      
      newSnack.innerHTML = `
        <div class="flex items-center gap-3 mb-3">
          <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="${nextTabIndex}">
          <span class="text-xl" contenteditable="true" style="cursor: text;">ğŸ</span>
          <span class="font-medium snack-title" contenteditable="true" style="cursor: text;">New snack</span>
        </div>
        <div class="flex items-center gap-2">
          <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" disabled tabindex="${nextTabIndex + 1}">
          <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" disabled tabindex="${nextTabIndex + 2}">Save</button>
          <button class="text-gray-400 hover:text-red-500" onclick="this.closest('.p-4').remove()">âœ–</button>
        </div>
      `;
      document.getElementById('snacksGrid').appendChild(newSnack);
      
      // Focus on the snack name for editing
      const snackNameSpan = newSnack.querySelector('.snack-title');
      snackNameSpan.focus();
      // Select all text for contenteditable elements
      if (window.getSelection && document.createRange) {
        const range = document.createRange();
        range.selectNodeContents(snackNameSpan);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
    
    // Toggle snack input based on checkbox state
    function toggleSnackInput(checkbox) {
      const card = checkbox.closest('.p-4');
      const nameInput = card.querySelector('.snack-name');
      const saveButton = card.querySelector('button[onclick*="claimSnack"]');
      
      if (checkbox.checked) {
        nameInput.disabled = false;
        saveButton.disabled = false;
        nameInput.focus();
        // Add visual feedback that it's now active
        card.style.backgroundColor = 'rgba(224, 177, 74, 0.1)';
      } else {
        nameInput.disabled = true;
        saveButton.disabled = true;
        nameInput.value = '';
        // Remove claimed styling and reset background
        card.classList.remove('snack-claimed');
        card.style.backgroundColor = 'white';
        
        // Save the unclaimed state to the backend
        saveSnackDataToFirestore().catch((error) => {
          console.error('Failed to save unclaim state:', error);
        });
      }
      
      // Only show global save button for teachers/admins in edit mode
      if (document.body.classList.contains('editing')) {
        const saveBtn = document.getElementById('saveChangesBtn');
        if (saveBtn) saveBtn.style.display = 'block';
      }
    }
    // Snack claim
    function claimSnack(btn) {
      const card = btn.closest('.p-4');
      const checkbox = card.querySelector('.snack-checkbox');
      const name = card.querySelector('.snack-name').value.trim();
      
      // Only allow claiming if checkbox is checked and name is provided
      if (checkbox && checkbox.checked && name) {
        card.classList.add('snack-claimed');
        btn.textContent = 'Saving...';
        btn.disabled = true;
        
        // Save to Firestore immediately
        saveSnackDataToFirestore().then(() => {
          btn.textContent = 'Saved!';
          setTimeout(() => {
            btn.textContent = 'Save';
            btn.disabled = false;
          }, 1800);
        }).catch((error) => {
          console.error('Failed to save snack data:', error);
          btn.textContent = 'Save Failed';
          setTimeout(() => {
            btn.textContent = 'Save';
            btn.disabled = false;
          }, 2000);
        });
        
        // Only show global save button for teachers/admins in edit mode
        // Parents get individual card saves only
        if (document.body.classList.contains('editing')) {
          const saveBtn = document.getElementById('saveChangesBtn');
          if (saveBtn) saveBtn.style.display = 'block';
        }
      } else if (!checkbox || !checkbox.checked) {
        alert('Please check the box first to claim this snack.');
      } else if (!name) {
        alert('Please enter your name to claim this snack.');
      }
    }
    
    // Function to save snack message
    async function saveSnackMessage() {
      const snackMessageEl = document.getElementById('snackMessage');
      const saveBtn = document.getElementById('saveSnackMessageBtn');
      
      if (!snackMessageEl || !saveBtn) return;
      
      const originalText = saveBtn.textContent;
      
      try {
        // Check authentication
        await ensureAuthenticated();
        
        // Show saving state
        saveBtn.textContent = 'â³ Saving...';
        saveBtn.disabled = true;
        
        const message = snackMessageEl.value || '';
        
        // Try to save to Firestore first
        if (typeof db !== 'undefined') {
          await db.collection('classData').doc('current').set(
            { snack_message: message }, 
            { merge: true }
          );
        } else {
          // Fallback to localStorage for testing
          localStorage.setItem('classData_snack_message', message);
        }
        
        // Show success state
        saveBtn.textContent = 'âœ… Saved!';
        
        // Reset button after delay
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }, 1500);
        
      } catch (error) {
        console.error('Failed to save snack message:', error);
        saveBtn.textContent = 'âŒ Error';
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }, 2000);
      }
    }
    
    // Function to save snack data to Firestore
    async function saveSnackDataToFirestore() {
      try {
        // Ensure valid authentication for parent snack claims
        if (auth) {
          // Check if user is already authenticated
          if (auth.currentUser) {
            // Check if it's a Google user (from edit mode) or anonymous
            const isGoogleUser = auth.currentUser.providerData.some(
              provider => provider.providerId === 'google.com'
            );
            
            if (isGoogleUser) {
              // Google user exists, verify token is still valid by refreshing it
              try {
                await auth.currentUser.getIdToken(true);
                console.log('Using existing Google authentication for snack claim');
              } catch (error) {
                // Token refresh failed, sign out and use anonymous auth
                console.log('Google auth token expired, switching to anonymous auth');
                await auth.signOut();
                await auth.signInAnonymously();
                console.log('Authentication successful');
              }
            } else {
              // Already have anonymous auth, verify it's still valid
              try {
                await auth.currentUser.getIdToken(true);
                console.log('Using existing anonymous authentication for snack claim');
              } catch (error) {
                // Token refresh failed, re-authenticate
                console.log('Anonymous auth token expired, re-authenticating');
                await auth.signInAnonymously();
                console.log('Authentication successful');
              }
            }
          } else {
            // No user signed in, use anonymous auth
            console.log('Authenticating for snack claim...');
            await auth.signInAnonymously();
            console.log('Authentication successful');
          }
        }
        
        // Collect current snack data
        const snacksGrid = document.getElementById('snacksGrid');
        if (!snacksGrid) return;
        
        const snacks = [];
        snacksGrid.querySelectorAll('.p-4').forEach(card => {
          const emoji = card.querySelector('.text-xl')?.textContent || '';
          const item = card.querySelector('.snack-title')?.textContent || '';
          const claimedBy = card.querySelector('.snack-name')?.value || '';
          const checked = card.querySelector('.snack-checkbox')?.checked || false;
          const isDefault = card.getAttribute('data-default-snack') === 'true';
          if (item) {
            snacks.push({ 
              emoji: emoji, 
              item: item, 
              claimed_by: claimedBy, 
              checked: checked,
              is_default: isDefault
            });
          }
        });
        
        const snacksData = JSON.stringify(snacks);
        
        // Try to save to Firestore first
        if (typeof db !== 'undefined') {
          await db.collection('classData').doc('current').set(
            { snacks_json: snacksData }, 
            { merge: true }
          );
          console.log('Snack data saved to Firestore successfully');
        } else {
          // Fallback to localStorage for testing when Firebase is not available
          localStorage.setItem('classData_snacks_json', snacksData);
          console.log('Snack data saved to localStorage (Firebase not available)');
        }
        
      } catch (error) {
        console.error('Failed to save snack data:', error);
        // Fallback to localStorage on Firestore error
        try {
          const snacksGrid = document.getElementById('snacksGrid');
          if (snacksGrid) {
            const snacks = [];
            snacksGrid.querySelectorAll('.p-4').forEach(card => {
              const emoji = card.querySelector('.text-xl')?.textContent || '';
              const item = card.querySelector('.snack-title')?.textContent || '';
              const claimedBy = card.querySelector('.snack-name')?.value || '';
              const checked = card.querySelector('.snack-checkbox')?.checked || false;
              const isDefault = card.getAttribute('data-default-snack') === 'true';
              if (item) {
                snacks.push({ 
                  emoji: emoji, 
                  item: item, 
                  claimed_by: claimedBy, 
                  checked: checked,
                  is_default: isDefault
                });
              }
            });
            localStorage.setItem('classData_snacks_json', JSON.stringify(snacks));
            console.log('Snack data saved to localStorage as fallback');
          }
        } catch (localError) {
          console.error('Failed to save to localStorage as well:', localError);
          throw error;
        }
      }
    }
    
    // Extras tab: Add card
    function addExtrasCard() {
      // Create card directly editable on the page instead of using prompts
      const newCard = document.createElement('div');
      newCard.className = 'text-center p-8 rounded-2xl';
      newCard.style.background = 'color-mix(in oklab, var(--md-white) 70%, var(--md-mustard) 30%)';
      newCard.style.border = '1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%)';
      newCard.innerHTML = `
        <div class="text-6xl mb-4 emoji-edit" contenteditable="true" style="cursor: text;">âœ¨</div>
        <h3 class="font-semibold mb-2" contenteditable="true" style="cursor: text;">Click to edit title</h3>
        <p class="text-sm" contenteditable="true" style="cursor: text;">Click to edit description</p>
        <button class="mt-2 text-red-500 hover:text-red-700 text-xs" onclick="this.closest('.text-center').remove();" style="display: inline-block;">Remove Card</button>
      `;
      document.getElementById('extrasGrid').appendChild(newCard);
      
      // Auto-focus the title for immediate editing
      const titleEl = newCard.querySelector('h3');
      titleEl.focus();
      // Select all text for immediate editing
      if (window.getSelection && document.createRange) {
        const range = document.createRange();
        range.selectNodeContents(titleEl);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
    // Specials galleries: enhanced functionality
    function prevGalleryImg(btn) {
      const galleryContainer = btn.closest('.gallery-imgs');
      const galleryType = galleryContainer.getAttribute('data-gallery-type');
      
      const urlsStr = galleryContainer.getAttribute('data-gallery-urls');
      if (!urlsStr) return;
      
      try {
        const urls = JSON.parse(urlsStr);
        if (urls.length <= 1) return; // No navigation needed for single image
        
        let currentIndex = parseInt(galleryContainer.getAttribute('data-current-index') || '0');
        currentIndex = (currentIndex - 1 + urls.length) % urls.length;
        
        galleryContainer.setAttribute('data-current-index', currentIndex.toString());
        updateGalleryDisplay(galleryContainer, urls[currentIndex]);
      } catch (e) {
        console.error('Failed to navigate gallery:', e);
      }
    }
    
    function nextGalleryImg(btn) {
      const galleryContainer = btn.closest('.gallery-imgs');
      const galleryType = galleryContainer.getAttribute('data-gallery-type');
      
      const urlsStr = galleryContainer.getAttribute('data-gallery-urls');
      if (!urlsStr) return;
      
      try {
        const urls = JSON.parse(urlsStr);
        if (urls.length <= 1) return; // No navigation needed for single image
        
        let currentIndex = parseInt(galleryContainer.getAttribute('data-current-index') || '0');
        currentIndex = (currentIndex + 1) % urls.length;
        
        galleryContainer.setAttribute('data-current-index', currentIndex.toString());
        updateGalleryDisplay(galleryContainer, urls[currentIndex]);
      } catch (e) {
        console.error('Failed to navigate gallery:', e);
      }
    }
    
    // Delete gallery photo function
    function deleteGalleryPhoto(btn, galleryType) {
      if (!document.body.classList.contains('editing')) {
        return; // Only allow deletion in edit mode
      }
      
      if (confirm('Are you sure you want to delete this photo?')) {
        const galleryContainer = btn.closest('.gallery-imgs');
        const img = galleryContainer.querySelector('img');
        const plusIcon = galleryContainer.querySelector('.text-3xl');
        
        const urlsStr = galleryContainer.getAttribute('data-gallery-urls');
        if (urlsStr) {
          try {
            const urls = JSON.parse(urlsStr);
            const currentIndex = parseInt(galleryContainer.getAttribute('data-current-index') || '0');
            
            if (urls.length > 1) {
              // Remove current image from array
              urls.splice(currentIndex, 1);
              galleryContainer.setAttribute('data-gallery-urls', JSON.stringify(urls));
              
              // Adjust current index if needed
              let newIndex = currentIndex;
              if (newIndex >= urls.length) {
                newIndex = urls.length - 1;
              }
              galleryContainer.setAttribute('data-current-index', newIndex.toString());
              
              // Show the new current image
              updateGalleryDisplay(galleryContainer, urls[newIndex]);
              galleryContainer.setAttribute('data-gallery-url', urls[newIndex]);
            } else {
              // Last image - reset to empty state
              galleryContainer.removeAttribute('data-gallery-urls');
              galleryContainer.removeAttribute('data-current-index');
              galleryContainer.removeAttribute('data-gallery-url');
              
              if (img) {
                img.style.display = 'none';
                img.src = '';
              }
              if (plusIcon) {
                plusIcon.style.display = 'block';
              }
              btn.style.display = 'none';
            }
          } catch (e) {
            console.error('Failed to delete from gallery:', e);
          }
        } else {
          // Fallback to old behavior for single images
          if (img) {
            img.style.display = 'none';
            img.src = '';
          }
          if (plusIcon) {
            plusIcon.style.display = 'block';
          }
          btn.style.display = 'none';
          galleryContainer.removeAttribute('data-gallery-url');
        }
        
        // Show save button since we have changes
        const saveBtn = document.getElementById('saveChangesBtn');
        if (saveBtn) saveBtn.style.display = 'block';
        
        console.log(`Deleted photo from ${galleryType} gallery`);
      }
    }
    
    // Image enlargement modal functions
    function openImageModal(imageUrl) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      
      if (modal && modalImage && imageUrl) {
        modalImage.src = imageUrl;
        modal.style.display = 'flex';
        
        // Prevent body scroll when modal is open
        document.body.style.overflow = 'hidden';
      }
    }
    
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      
      if (modal && modalImage) {
        modal.style.display = 'none';
        modalImage.src = '';
        
        // Restore body scroll
        document.body.style.overflow = '';
      }
    }
    
    // Function to make gallery images clickable for enlargement
    function makeGalleryImageClickable(img, galleryType) {
      // Only make clickable if not in edit mode and not Scholar/About Me pictures
      if (!document.body.classList.contains('editing') && 
          galleryType !== 'scholar' && 
          galleryType !== 'aboutme' && 
          img.src && img.src !== '') {
        img.style.cursor = 'pointer';
        img.onclick = function(e) {
          e.stopPropagation();
          openImageModal(img.src);
        };
      } else {
        img.style.cursor = 'default';
        img.onclick = null;
      }
    }
    
    // Add ESC key support for closing modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeImageModal();
      }
    });
    
    // Enhanced error handling helper function for uploads (global scope)
    window.handleUploadError = window.handleUploadError || function(error, context = 'upload') {
      console.error(`=== ${context.toUpperCase()} FAILED ===`);
      console.error('Error details:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      console.error('Error name:', error.name);
      console.error('Error stack:', error.stack);
      
      // Additional debug information
      console.error('Firebase storage initialized?', typeof storage !== 'undefined');
      console.error('Firebase db initialized?', typeof db !== 'undefined');
      console.error('Storage bucket config:', typeof firebase !== 'undefined' ? firebase.app().options.storageBucket : 'Firebase not available');
      
      let userMessage = `${context.charAt(0).toUpperCase() + context.slice(1)} failed: `;
      
      if (error.code) {
        switch (error.code) {
          case 'storage/unauthorized':
            userMessage += 'Permission denied. Please check Firebase storage rules.';
            break;
          case 'storage/canceled':
            userMessage += 'Upload was canceled.';
            break;
          case 'storage/unknown':
            userMessage += 'Unknown error occurred. Please try again.';
            break;
          case 'storage/invalid-format':
            userMessage += 'Invalid file format.';
            break;
          case 'storage/invalid-argument':
            userMessage += 'Invalid upload parameters.';
            break;
          case 'storage/retry-limit-exceeded':
            userMessage += 'Upload failed after multiple retries. Please check your connection.';
            break;
          case 'storage/retry-limit-exceeded':
            userMessage += 'Upload retry limit exceeded. Please try again later.';
            break;
          case 'storage/quota-exceeded':
            userMessage += 'Storage quota exceeded.';
            break;
          default:
            userMessage += `Firebase error (${error.code}): ${error.message || 'Unknown error'}`;
        }
      } else if (error.message) {
        if (error.message.includes('CORS')) {
          userMessage += 'CORS policy error. Please contact administrator.';
        } else if (error.message.includes('network')) {
          userMessage += 'Network connection error. Please check your internet connection.';
        } else if (error.message.includes('bucket')) {
          userMessage += 'Storage bucket configuration error. Please contact administrator.';
        } else {
          userMessage += error.message;
        }
      } else {
        userMessage += 'Unknown error occurred. Please try again.';
      }
      
      console.error('User message:', userMessage);
      return userMessage;
    };
    
    // Helper function to validate storage URLs
    window.validateStorageUrl = async function(url) {
      if (!url || typeof url !== 'string' || url.trim() === '') {
        return false;
      }
      
      try {
        // Simple check if URL is accessible
        const response = await fetch(url, { method: 'HEAD' });
        return response.ok;
      } catch (error) {
        console.warn('Storage URL validation failed:', url, error);
        return false;
      }
    };
    
    // Helper function to test Firebase Storage connection
    window.testStorageConnection = async function() {
      try {
        if (typeof storage === 'undefined') {
          console.error('Storage not initialized');
          return false;
        }
        
        // Try to create a reference to test connectivity
        const testRef = storage.ref('test-connection');
        console.log('Storage connection test successful, bucket:', storage.app.options.storageBucket);
        return true;
      } catch (error) {
        console.error('Storage connection test failed:', error);
        return false;
      }
    };
    
    // Helper function to validate all image URLs in Firestore data
    window.validateAllImageUrls = async function(data) {
      const results = {
        valid: [],
        invalid: [],
        total: 0
      };
      
      if (!data) return results;
      
      // Check photo URLs
      if (data.photo_urls_json) {
        try {
          const photoUrls = JSON.parse(data.photo_urls_json);
          for (let i = 0; i < photoUrls.length; i++) {
            const url = photoUrls[i];
            if (url && typeof url === 'string' && url.trim() !== '') {
              results.total++;
              const isValid = await window.validateStorageUrl(url);
              if (isValid) {
                results.valid.push({ type: 'photo', index: i, url });
              } else {
                results.invalid.push({ type: 'photo', index: i, url });
              }
            }
          }
        } catch (e) {
          console.error('Failed to parse photo URLs:', e);
        }
      }
      
      // Check gallery URLs
      if (data.gallery_urls_json) {
        try {
          const galleryUrls = JSON.parse(data.gallery_urls_json);
          for (const galleryType of ['art', 'stem', 'gym', 'music']) {
            const galleryData = galleryUrls[galleryType];
            if (galleryData) {
              let urls = [];
              if (typeof galleryData === 'string' && galleryData.trim() !== '') {
                urls = [galleryData];
              } else if (Array.isArray(galleryData)) {
                urls = galleryData.filter(url => url && typeof url === 'string' && url.trim() !== '');
              }
              
              for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                results.total++;
                const isValid = await window.validateStorageUrl(url);
                if (isValid) {
                  results.valid.push({ type: 'gallery', galleryType, index: i, url });
                } else {
                  results.invalid.push({ type: 'gallery', galleryType, index: i, url });
                }
              }
            }
          }
        } catch (e) {
          console.error('Failed to parse gallery URLs:', e);
        }
      }
      
      // Check profile URLs
      if (data.scholar_profile_url) {
        results.total++;
        const isValid = await window.validateStorageUrl(data.scholar_profile_url);
        if (isValid) {
          results.valid.push({ type: 'profile', section: 'scholar', url: data.scholar_profile_url });
        } else {
          results.invalid.push({ type: 'profile', section: 'scholar', url: data.scholar_profile_url });
        }
      }
      
      if (data.about_me_profile_url) {
        results.total++;
        const isValid = await window.validateStorageUrl(data.about_me_profile_url);
        if (isValid) {
          results.valid.push({ type: 'profile', section: 'aboutme', url: data.about_me_profile_url });
        } else {
          results.invalid.push({ type: 'profile', section: 'aboutme', url: data.about_me_profile_url });
        }
      }
      
      console.log(`Image URL validation complete: ${results.valid.length}/${results.total} valid`);
      if (results.invalid.length > 0) {
        console.warn('Invalid URLs found:', results.invalid);
      }
      
      return results;
    };
    
    // Editable photo cards: file upload functionality
    function editPhoto(el) {
      // Only allow editing in edit mode
      if (!document.body.classList.contains('editing')) {
        return;
      }
      
      // Create file input
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      
      fileInput.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('File size too large. Please select an image smaller than 10MB.');
          return;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }
        
        let attempt = 0;
        const maxAttempts = 3;
        
        while (attempt < maxAttempts) {
          try {
            console.log(`Photo card upload attempt ${attempt + 1}`);
            
            // Set uploading flag to prevent periodic refresh interference
            isUploading = true;
            
            // Show uploading state
            el.innerHTML = '<div style="font-size: 12px; text-align: center;">â³<br>Uploading...</div>';
            el.style.pointerEvents = 'none';
            
            // Test storage connection first
            const storageConnected = await window.testStorageConnection();
            if (!storageConnected) {
              throw new Error('Firebase Storage connection failed');
            }
            
            // Generate unique filename
            const timestamp = Date.now();
            const fileName = `photo_${timestamp}_${file.name}`;
            
            console.log(`Uploading to: photos/${fileName}`);
            
            // Upload to Firebase Storage
            const storageRef = storage.ref(`photos/${fileName}`);
            const uploadTask = await storageRef.put(file);
            const downloadURL = await uploadTask.ref.getDownloadURL();
            
            console.log('Photo card upload successful, URL:', downloadURL);
            
            // Validate the generated URL
            const urlValid = await window.validateStorageUrl(downloadURL);
            if (!urlValid) {
              console.warn('Generated URL failed validation, but proceeding anyway');
            }
            
            // Update the photo card display
            updatePhotoCardDisplay(el, downloadURL);
            
            // Store the photo URL in the element for later collection
            el.setAttribute('data-photo-url', downloadURL);
            
            // Show save button since we have changes
            const saveBtn = document.getElementById('saveChangesBtn');
            if (saveBtn) saveBtn.style.display = 'block';
            
            // Clear uploading flag
            isUploading = false;
            
            // Auto-save after successful upload to ensure persistence
            setTimeout(() => {
              if (saveBtn && saveBtn.style.display === 'block' && !isSaving) {
                console.log('Auto-saving after photo card upload');
                saveChangesToFirestore();
              }
            }, 500);
            
            // Success - break out of retry loop
            break;
            
          } catch (error) {
            attempt++;
            console.error(`Photo card upload attempt ${attempt} failed:`, error);
            
            if (attempt >= maxAttempts) {
              // Clear uploading flag on final failure
              isUploading = false;
              
              const errorMessage = window.handleUploadError(error, 'photo upload');
              
              // Show user-friendly error in UI
              const errorDiv = document.createElement('div');
              errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
              errorDiv.innerHTML = `
                <div class="flex">
                  <div class="flex-shrink-0">
                    <span class="text-red-500">âš ï¸</span>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm font-medium">Photo Upload Failed</p>
                    <p class="text-sm">${errorMessage}</p>
                  </div>
                  <div class="ml-auto pl-3">
                    <button class="text-red-400 hover:text-red-600" onclick="this.parentElement.parentElement.parentElement.remove()">
                      <span class="sr-only">Dismiss</span>
                      âœ•
                    </button>
                  </div>
                </div>
              `;
              document.body.appendChild(errorDiv);
              
              // Auto-remove error after 5 seconds
              setTimeout(() => {
                if (errorDiv.parentNode) {
                  errorDiv.parentNode.removeChild(errorDiv);
                }
              }, 5000);
              
              // Reset to placeholder state on error
              resetPhotoCardToPlaceholder(el);
            } else {
              // Wait before retry
              await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
          }
        }
        
        el.style.pointerEvents = 'auto';
        document.body.removeChild(fileInput);
      };
      
      document.body.appendChild(fileInput);
      fileInput.click();
    }
    
    // Helper function to update photo card display
    function updatePhotoCardDisplay(element, imageUrl) {
      // Validate imageUrl
      if (!imageUrl || typeof imageUrl !== 'string' || imageUrl.trim() === '') {
        console.warn('Invalid image URL provided to updatePhotoCardDisplay:', imageUrl);
        resetPhotoCardToPlaceholder(element);
        return;
      }

      // Create image element with error handling
      const img = document.createElement('img');
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      img.style.borderRadius = 'inherit';
      img.alt = ''; // Remove alt text to prevent showing text on broken images
      
      // Handle successful image load
      img.onload = function() {
        element.innerHTML = '';
        element.appendChild(img);
        
        // Add delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only';
        deleteBtn.style.display = 'none';
        deleteBtn.onclick = function(event) {
          event.stopPropagation();
          deleteHomePhoto(this);
        };
        deleteBtn.title = 'Delete Photo';
        deleteBtn.textContent = 'âœ–';
        element.appendChild(deleteBtn);
      };
      
      // Handle image load error
      img.onerror = function() {
        console.error('Failed to load image:', imageUrl);
        resetPhotoCardToPlaceholder(element);
      };
      
      img.src = imageUrl;
    }

    // Helper function to reset photo card to placeholder state
    function resetPhotoCardToPlaceholder(element) {
      element.innerHTML = '+';
      element.style.display = 'flex';
      element.style.alignItems = 'center';
      element.style.justifyContent = 'center';
      element.style.fontSize = '3rem';
      element.style.fontWeight = 'bold';
      element.removeAttribute('data-photo-url');
    }
    
    // Handle clicks on home page photo cards - either edit or view in modal
    function handleHomePhotoClick(element) {
      // Check if we're in edit mode
      if (document.body.classList.contains('editing')) {
        // In edit mode, allow editing
        editPhoto(element);
      } else {
        // Not in edit mode, check if there's an image to display in modal
        const img = element.querySelector('img');
        if (img && img.src && img.src !== '') {
          openImageModal(img.src);
        }
      }
    }
    
    // Delete home page photo function
    function deleteHomePhoto(btn) {
      if (!document.body.classList.contains('editing')) {
        return; // Only allow deletion in edit mode
      }
      
      if (confirm('Are you sure you want to delete this photo?')) {
        const photoCard = btn.closest('.photo-card');
        
        // Reset to empty state
        photoCard.innerHTML = '+<button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteHomePhoto(this)" title="Delete Photo">âœ–</button>';
        photoCard.removeAttribute('data-photo-url');
        
        // Show save button since we have changes
        const saveBtn = document.getElementById('saveChangesBtn');
        if (saveBtn) saveBtn.style.display = 'block';
        
        console.log('Deleted photo from home page');
      }
    }
    
    // Gallery photo upload functionality
    function editGalleryPhoto(el, galleryType) {
      // Only allow editing in edit mode
      if (!document.body.classList.contains('editing')) {
        return;
      }
      
      // Create file input
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      
      fileInput.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('File size too large. Please select an image smaller than 10MB.');
          return;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }
        
        let attempt = 0;
        const maxAttempts = 3;
        const originalContent = el.innerHTML;
        
        while (attempt < maxAttempts) {
          try {
            console.log(`Gallery photo upload attempt ${attempt + 1} for type: ${galleryType}`);
            
            // Set uploading flag to prevent periodic refresh interference
            isUploading = true;
            
            // Show uploading state
            el.innerHTML = '<span class="text-sm text-gray-600">â³<br>Uploading...</span>';
            el.style.pointerEvents = 'none';
            
            // Test storage connection first
            const storageConnected = await window.testStorageConnection();
            if (!storageConnected) {
              throw new Error('Firebase Storage connection failed');
            }
            
            // Generate unique filename
            const timestamp = Date.now();
            const fileName = `gallery_${galleryType}_${timestamp}_${file.name}`;
            
            console.log(`Uploading to: galleries/${fileName}`);
            
            // Upload to Firebase Storage
            const storageRef = storage.ref(`galleries/${fileName}`);
            const uploadTask = await storageRef.put(file);
            const downloadURL = await uploadTask.ref.getDownloadURL();
            
            console.log('Gallery photo upload successful, URL:', downloadURL);
            
            // Validate the generated URL
            const urlValid = await window.validateStorageUrl(downloadURL);
            if (!urlValid) {
              console.warn('Generated URL failed validation, but proceeding anyway');
            }
            
            // Update the gallery display
            updateGalleryDisplay(el, downloadURL);
            
            // Add the photo URL to the array for later collection
            const urlsStr = el.getAttribute('data-gallery-urls');
            let urls = [];
            if (urlsStr) {
              try {
                urls = JSON.parse(urlsStr);
              } catch (e) {
                urls = [];
              }
            }
            urls.push(downloadURL);
            
            el.setAttribute('data-gallery-urls', JSON.stringify(urls));
            el.setAttribute('data-current-index', (urls.length - 1).toString());
            
            // Keep legacy attribute for backward compatibility
            el.setAttribute('data-gallery-url', downloadURL);
            
            // Show save button since we have changes
            const saveBtn = document.getElementById('saveChangesBtn');
            if (saveBtn) saveBtn.style.display = 'block';
            
            // Clear uploading flag
            isUploading = false;
            
            // Auto-save after successful upload to ensure persistence
            setTimeout(() => {
              if (saveBtn && saveBtn.style.display === 'block' && !isSaving) {
                console.log('Auto-saving after gallery photo upload');
                saveChangesToFirestore();
              }
            }, 500);
            
            // Success - break out of retry loop
            break;
            
          } catch (error) {
            attempt++;
            console.error(`Gallery photo upload attempt ${attempt} failed:`, error);
            
            if (attempt >= maxAttempts) {
              // Clear uploading flag on final failure
              isUploading = false;
              
              const errorMessage = window.handleUploadError(error, 'gallery photo upload');
              
              // Show user-friendly error in UI
              const errorDiv = document.createElement('div');
              errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
              errorDiv.innerHTML = `
                <div class="flex">
                  <div class="flex-shrink-0">
                    <span class="text-red-500">âš ï¸</span>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm font-medium">Gallery Upload Failed</p>
                    <p class="text-sm">${errorMessage}</p>
                  </div>
                  <div class="ml-auto pl-3">
                    <button class="text-red-400 hover:text-red-600" onclick="this.parentElement.parentElement.parentElement.remove()">
                      <span class="sr-only">Dismiss</span>
                      âœ•
                    </button>
                  </div>
                </div>
              `;
              document.body.appendChild(errorDiv);
              
              // Auto-remove error after 5 seconds
              setTimeout(() => {
                if (errorDiv.parentNode) {
                  errorDiv.parentNode.removeChild(errorDiv);
                }
              }, 5000);
              
              // Reset to placeholder state on error
              resetGalleryToPlaceholder(el);
            } else {
              // Wait before retry
              await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
          }
        }
        
        el.style.pointerEvents = 'auto';
        document.body.removeChild(fileInput);
      };
      
      document.body.appendChild(fileInput);
      fileInput.click();
    }
    
    // Helper function to update gallery display
    function updateGalleryDisplay(element, imageUrl) {
      const img = element.querySelector('img');
      const plusSpan = element.querySelector('span:not(.gallery-arrows)');
      
      // Validate imageUrl
      if (!imageUrl || typeof imageUrl !== 'string' || imageUrl.trim() === '') {
        console.warn('Invalid image URL provided to updateGalleryDisplay:', imageUrl);
        resetGalleryToPlaceholder(element);
        return;
      }
      
      if (img && plusSpan) {
        // Handle successful image load
        img.onload = function() {
          img.style.display = 'block';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          plusSpan.style.display = 'none';
          
          // Make image clickable for enlargement
          const galleryType = element.getAttribute('data-gallery-type');
          makeGalleryImageClickable(img, galleryType);
          
          // Update arrow visibility and gallery counter
          updateGalleryArrowsAndCounter(element);
        };
        
        // Handle image load error
        img.onerror = function() {
          console.error('Failed to load gallery image:', imageUrl);
          resetGalleryToPlaceholder(element);
        };
        
        img.alt = ''; // Remove alt text to prevent showing text on broken images
        img.src = imageUrl;
      } else {
        console.error('Gallery display elements not found');
        resetGalleryToPlaceholder(element);
      }
    }

    // Helper function to update gallery arrows visibility and image counter
    function updateGalleryArrowsAndCounter(element) {
      const arrowsContainer = element.querySelector('.gallery-arrows');
      const urlsStr = element.getAttribute('data-gallery-urls');
      
      if (!arrowsContainer) return;
      
      let urls = [];
      if (urlsStr) {
        try {
          urls = JSON.parse(urlsStr);
        } catch (e) {
          urls = [];
        }
      }
      
      // Show/hide arrows based on number of images
      if (urls.length > 1) {
        arrowsContainer.style.display = 'flex';
        
        // Add or update image counter
        let counter = element.querySelector('.gallery-counter');
        if (!counter) {
          counter = document.createElement('div');
          counter.className = 'gallery-counter';
          counter.style.cssText = 'position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.7);color:white;padding:4px 8px;border-radius:12px;font-size:0.75rem;pointer-events:none;';
          element.appendChild(counter);
        }
        
        const currentIndex = parseInt(element.getAttribute('data-current-index') || '0');
        counter.textContent = `${currentIndex + 1} of ${urls.length}`;
        counter.style.display = 'block';
      } else {
        arrowsContainer.style.display = 'none';
        
        // Hide counter if it exists
        const counter = element.querySelector('.gallery-counter');
        if (counter) {
          counter.style.display = 'none';
        }
      }
    }

    // Helper function to reset gallery to placeholder state
    function resetGalleryToPlaceholder(element) {
      const img = element.querySelector('img');
      const plusSpan = element.querySelector('span:not(.gallery-arrows)');
      
      if (img) {
        img.style.display = 'none';
        img.src = '';
        img.onload = null;
        img.onerror = null;
      }
      if (plusSpan) {
        plusSpan.style.display = 'block';
        plusSpan.textContent = '+';
        plusSpan.className = 'text-3xl text-gray-400';
      }
      
      // Clear gallery data attributes
      element.removeAttribute('data-gallery-url');
      element.removeAttribute('data-gallery-urls');
      element.removeAttribute('data-current-index');
      
      // Hide navigation arrows, delete button, and counter
      const deleteBtn = element.querySelector('.edit-only');
      if (deleteBtn) deleteBtn.style.display = 'none';
      
      const arrowsContainer = element.querySelector('.gallery-arrows');
      if (arrowsContainer) arrowsContainer.style.display = 'none';
      
      const counter = element.querySelector('.gallery-counter');
      if (counter) counter.style.display = 'none';
    }
    
    // NEW FUNCTIONS FOR SPECIALS TAB TWO-IMAGE LAYOUT
    
    // Handle click on specials image slot (upload in edit mode, enlarge in view mode)
    function handleSpecialsImageClick(slot, specialsType, slotIndex) {
      if (document.body.classList.contains('editing')) {
        // Edit mode - upload or replace image
        uploadSpecialsImage(slot, specialsType, slotIndex);
      } else {
        // View mode - enlarge image if it exists
        const img = slot.querySelector('img');
        if (img && img.style.display !== 'none' && img.src) {
          openImageModal(img.src);
        }
      }
    }
    
    // Upload or replace image in a specials slot
    function uploadSpecialsImage(slot, specialsType, slotIndex) {
      // Create file input
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      
      fileInput.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('File size too large. Please select an image smaller than 10MB.');
          return;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }
        
        let attempt = 0;
        const maxAttempts = 3;
        const originalContent = slot.innerHTML;
        
        while (attempt < maxAttempts) {
          try {
            console.log(`Specials image upload attempt ${attempt + 1} for ${specialsType} slot ${slotIndex}`);
            
            // Set uploading flag to prevent periodic refresh interference
            isUploading = true;
            
            // Show uploading state
            slot.innerHTML = '<span class="text-sm text-gray-600">â³<br>Uploading...</span>';
            slot.style.pointerEvents = 'none';
            
            // Test storage connection first
            const storageConnected = await window.testStorageConnection();
            if (!storageConnected) {
              throw new Error('Firebase Storage connection failed');
            }
            
            // Generate unique filename
            const timestamp = Date.now();
            const fileName = `specials_${specialsType}_slot${slotIndex}_${timestamp}_${file.name}`;
            
            console.log(`Uploading to: galleries/${fileName}`);
            
            // Upload to Firebase Storage
            const storageRef = storage.ref(`galleries/${fileName}`);
            const uploadTask = await storageRef.put(file);
            const downloadURL = await uploadTask.ref.getDownloadURL();
            
            console.log('Specials image upload successful, URL:', downloadURL);
            
            // Validate the generated URL
            const urlValid = await window.validateStorageUrl(downloadURL);
            if (!urlValid) {
              console.warn('Generated URL failed validation, but proceeding anyway');
            }
            
            // Restore DOM structure before updating display
            restoreSpecialsSlotStructure(slot);
            
            // Store the URL in the slot's data attribute
            slot.setAttribute('data-image-url', downloadURL);
            
            // Update the slot display
            updateSpecialsSlotDisplay(slot, downloadURL);
            
            // Show save button since we have changes
            const saveBtn = document.getElementById('saveChangesBtn');
            if (saveBtn) saveBtn.style.display = 'block';
            
            // Clear uploading flag
            isUploading = false;
            
            // Auto-save after successful upload to ensure persistence
            setTimeout(() => {
              if (saveBtn && saveBtn.style.display === 'block' && !isSaving) {
                console.log('Auto-saving after specials image upload');
                saveChangesToFirestore();
              }
            }, 500);
            
            // Success - break out of retry loop
            break;
            
          } catch (error) {
            attempt++;
            console.error(`Specials image upload attempt ${attempt} failed:`, error);
            
            if (attempt >= maxAttempts) {
              // Clear uploading flag on final failure
              isUploading = false;
              
              const errorMessage = window.handleUploadError(error, 'specials image upload');
              
              // Show user-friendly error in UI
              const errorDiv = document.createElement('div');
              errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
              errorDiv.innerHTML = `
                <div class="flex">
                  <div class="flex-shrink-0">
                    <span class="text-red-500">âš ï¸</span>
                  </div>
                  <div class="ml-3">
                    <p class="text-sm font-medium">Upload Failed</p>
                    <p class="text-sm">${errorMessage}</p>
                  </div>
                  <div class="ml-auto pl-3">
                    <button class="text-red-400 hover:text-red-600" onclick="this.parentElement.parentElement.parentElement.remove()">
                      <span class="sr-only">Dismiss</span>
                      âœ•
                    </button>
                  </div>
                </div>
              `;
              document.body.appendChild(errorDiv);
              
              // Auto-remove error after 5 seconds
              setTimeout(() => {
                if (errorDiv.parentNode) {
                  errorDiv.parentNode.removeChild(errorDiv);
                }
              }, 5000);
              
              // Restore structure and reset to placeholder state on error
              restoreSpecialsSlotStructure(slot);
              resetSpecialsSlotToPlaceholder(slot);
            } else {
              // Wait before retry
              await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
          }
        }
        
        slot.style.pointerEvents = 'auto';
        document.body.removeChild(fileInput);
      };
      
      document.body.appendChild(fileInput);
      fileInput.click();
    }
    
    // Update specials slot display with image
    function updateSpecialsSlotDisplay(slot, imageUrl) {
      const img = slot.querySelector('img');
      const plusSpan = slot.querySelector('span:not(.edit-only)');
      const deleteBtn = slot.querySelector('.edit-only');
      
      // Validate imageUrl
      if (!imageUrl || typeof imageUrl !== 'string' || imageUrl.trim() === '') {
        console.warn('Invalid image URL provided to updateSpecialsSlotDisplay:', imageUrl);
        resetSpecialsSlotToPlaceholder(slot);
        return;
      }
      
      if (img && plusSpan) {
        // Handle successful image load
        img.onload = function() {
          img.style.display = 'block';
          if (plusSpan) plusSpan.style.display = 'none';
          
          // Show delete button in edit mode
          if (deleteBtn && document.body.classList.contains('editing')) {
            deleteBtn.style.display = 'block';
          }
          
          // Make image clickable for enlargement in view mode
          if (!document.body.classList.contains('editing')) {
            img.style.cursor = 'pointer';
            img.onclick = function(e) {
              e.stopPropagation();
              openImageModal(img.src);
            };
          } else {
            img.style.cursor = 'default';
            img.onclick = null;
          }
        };
        
        // Handle image load error
        img.onerror = function() {
          console.error('Failed to load specials image:', imageUrl);
          resetSpecialsSlotToPlaceholder(slot);
        };
        
        img.alt = '';
        img.src = imageUrl;
      } else {
        console.error('Specials slot display elements not found');
        resetSpecialsSlotToPlaceholder(slot);
      }
    }
    
    // Reset specials slot to placeholder state
    function resetSpecialsSlotToPlaceholder(slot) {
      const img = slot.querySelector('img');
      const plusSpan = slot.querySelector('span:not(.edit-only)');
      const deleteBtn = slot.querySelector('.edit-only');
      
      if (img) {
        img.style.display = 'none';
        img.src = '';
        img.onload = null;
        img.onerror = null;
        img.onclick = null;
      }
      if (plusSpan) {
        plusSpan.style.display = 'block';
        plusSpan.textContent = '+';
      }
      if (deleteBtn) {
        deleteBtn.style.display = 'none';
      }
      
      // Clear data attribute
      slot.removeAttribute('data-image-url');
    }
    
    // Restore specials slot DOM structure (img, span, delete button)
    function restoreSpecialsSlotStructure(slot) {
      // Check if structure already exists
      let img = slot.querySelector('img');
      let plusSpan = slot.querySelector('span:not(.edit-only)');
      let deleteBtn = slot.querySelector('.edit-only');
      
      // If any element is missing, rebuild the entire structure
      if (!img || !plusSpan || !deleteBtn) {
        // Get the slot attributes before rebuilding
        const specialsType = slot.getAttribute('data-specials-type') || '';
        const slotIndex = slot.getAttribute('data-slot-index') || '0';
        const imageUrl = slot.getAttribute('data-image-url') || '';
        
        // Rebuild structure matching the original HTML
        slot.innerHTML = `
          <img src="" alt="${specialsType}" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:0.5rem;">
          <span class="text-3xl text-gray-400">+</span>
          <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs edit-only" style="display: none;" onclick="event.stopPropagation(); deleteSpecialsImage(this, '${specialsType}', ${slotIndex})" title="Delete Photo">âœ–</button>
        `;
        
        // Restore the data attribute if it existed
        if (imageUrl) {
          slot.setAttribute('data-image-url', imageUrl);
        }
      }
    }
    
    // Delete image from specials slot
    function deleteSpecialsImage(btn, specialsType, slotIndex) {
      if (!document.body.classList.contains('editing')) {
        return; // Only allow deletion in edit mode
      }
      
      if (confirm('Are you sure you want to delete this photo?')) {
        const slot = btn.closest('.specials-img-slot');
        resetSpecialsSlotToPlaceholder(slot);
        
        // Show save button since we have changes
        const saveBtn = document.getElementById('saveChangesBtn');
        if (saveBtn) saveBtn.style.display = 'block';
        
        console.log(`Deleted photo from ${specialsType} slot ${slotIndex}`);
      }
    }
    
    // END NEW FUNCTIONS FOR SPECIALS TAB
    
    // Helper function to reset profile to placeholder state (similar to gallery reset)
    function resetProfileToPlaceholder(element) {
      const img = element.querySelector('img');
      
      if (img) {
        img.remove();
      }
      
      // Reset to placeholder state with proper styling
      element.innerHTML = '<span class="text-3xl text-gray-400">+</span>';
      
      // Clear profile data attributes
      element.removeAttribute('data-profile-url');
      
      console.log('Reset profile to placeholder state');
    }
    
    // Function to update profile photos with proper error handling and reset
    async function updateProfilePhoto(section, imageUrl) {
      const profileEl = document.querySelector(`[onclick*="${section}"]`);
      
      if (!profileEl) {
        console.warn(`Profile element not found for section: ${section}`);
        return;
      }
      
      if (imageUrl && imageUrl.trim() !== '') {
        // Validate URL before setting
        try {
          const isValid = await window.validateStorageUrl(imageUrl);
          if (isValid) {
            // Create image with error handling
            const img = document.createElement('img');
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.alt = `${section} Profile`;
            
            img.onload = function() {
              profileEl.innerHTML = '';
              profileEl.appendChild(img);
              profileEl.setAttribute('data-profile-url', imageUrl);
              console.log(`Profile image loaded successfully for ${section}`);
            };
            
            img.onerror = function() {
              console.warn(`Failed to load profile image for ${section}, resetting to placeholder`);
              resetProfileToPlaceholder(profileEl);
            };
            
            img.src = imageUrl;
          } else {
            console.warn(`Invalid profile URL for ${section}, resetting to placeholder`);
            resetProfileToPlaceholder(profileEl);
          }
        } catch (error) {
          console.error(`Error validating profile URL for ${section}:`, error);
          resetProfileToPlaceholder(profileEl);
        }
      } else {
        // No URL provided, reset to placeholder
        resetProfileToPlaceholder(profileEl);
      }
    }
    
    // School calendar link update
    function updateCalendarUrl(input) {
      const link = document.getElementById('schoolCalendarLink');
      if (link && input.value) {
        link.href = input.value;
        
        // Show save button since we have changes
        const saveBtn = document.getElementById('saveChangesBtn');
        if (saveBtn) saveBtn.style.display = 'block';
      }
    }
    
    // Save calendar URL to Firestore
    async function saveCalendarUrl() {
      const saveBtn = document.getElementById('saveCalendarBtn');
      const calendarInput = document.getElementById('calendarUrlInput');
      
      if (!saveBtn || !calendarInput) return;
      
      const originalText = saveBtn.textContent;
      
      try {
        // Check authentication
        await ensureAuthenticated();
        
        // Validate URL
        const url = calendarInput.value.trim();
        if (!url || url === '#') {
          alert('Please enter a valid calendar URL');
          return;
        }
        
        // Show saving state
        saveBtn.textContent = 'â³ Saving...';
        saveBtn.disabled = true;
        
        // Update the link href immediately
        const link = document.getElementById('schoolCalendarLink');
        if (link) {
          link.href = url;
        }
        
        // Prepare data for saving
        const data = {
          calendar_url: url
        };
        
        // Save to Firestore
        await db.collection('classData').doc('current').set(data, { merge: true });
        
        console.log('Calendar URL saved successfully:', url);
        
        // Show success state
        saveBtn.textContent = 'âœ… Saved!';
        
        // Reset button after 1 second
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }, 1000);
        
      } catch (error) {
        console.error('Failed to save calendar URL:', error);
        saveBtn.textContent = 'âŒ Save Failed';
        
        // Show error alert
        alert('Failed to save calendar URL: ' + (error.message || 'Unknown error'));
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }, 2000);
      }
    }
  </script>

  <!-- Firebase Firestore Integration Script -->
  <script>
// Utility: Parse JSON fields from string or array
function parseArray(val) {
  if (!val) return [];
  if (Array.isArray(val)) return val;
  try { return JSON.parse(val); } catch { return []; }
}

// --- Section Updaters (these match your new sheet keys) ---
function updateWeekText(week) {
  const el = document.getElementById('weekText');
  if (el && week) el.textContent = week;
}
function updateRecapText(recap) {
  const el = document.getElementById('recapText');
  if (el && recap) el.textContent = recap;
}
function updateEventsList(dates_json) {
  const eventsContainer = document.getElementById('eventsList');
  if (!eventsContainer) return;
  const arr = parseArray(dates_json);
  eventsContainer.innerHTML = '';
  arr.forEach(ev => {
    const icon = ev.icon || 'ğŸ“Œ';
    const text = ev.text || '';
    const div = document.createElement('div');
    div.className = 'event-item flex items-center gap-3 p-3 rounded-xl bg-yellow-50 border';
    div.style.borderColor = 'var(--md-mustard)';
    div.innerHTML = `
      <span class="event-emoji text-xl" data-edit="teacher" contenteditable="false">${icon}</span>
      <span class="event-text font-semibold flex-1" data-edit="teacher" contenteditable="false">${text}</span>
      <button class="edit-only text-red-500 hover:text-red-700" onclick="this.parentNode.remove()">âœ–</button>
    `;
    eventsContainer.appendChild(div);
  });
}
function updateLookingAhead(lookingAhead) {
  const section = Array.from(document.querySelectorAll('div.rounded-2xl')).find(div =>
    div.querySelector('h3') && div.querySelector('h3').textContent.includes('Looking Ahead')
  );
  if (!section) return;
  const ul = section.querySelector('ul[data-edit="teacher"]');
  if (!ul) return;
  let arr = [];
  if (Array.isArray(lookingAhead)) arr = lookingAhead;
  else if (typeof lookingAhead === 'string') arr = lookingAhead.split(/\r?\n/).filter(x=>x.trim());
  ul.innerHTML = '';
  arr.forEach(item => {
    const li = document.createElement('li');
    li.textContent = 'â€¢ ' + item;
    ul.appendChild(li);
  });
}
function updateSnacksGrid(snacks_json) {
  const snacksContainer = document.getElementById('snacksGrid');
  if (!snacksContainer) return;
  
  // Don't clear the container, as we want to preserve the default cards
  // Instead, only remove user-added cards and update existing ones
  const userAddedCards = snacksContainer.querySelectorAll('.user-added-snack-card');
  userAddedCards.forEach(card => card.remove());
  
  const arr = parseArray(snacks_json);
  
  // First, update default cards with their claimed status
  const defaultCards = snacksContainer.querySelectorAll('.default-snack-card');
  arr.forEach((snack, index) => {
    if (snack.is_default && defaultCards[index]) {
      const card = defaultCards[index];
      const checkbox = card.querySelector('.snack-checkbox');
      const nameInput = card.querySelector('.snack-name');
      const saveButton = card.querySelector('button[onclick*="claimSnack"]');
      const title = card.querySelector('.snack-title');
      
      // Update title (only for teachers in edit mode)
      if (title && snack.item) {
        title.textContent = snack.item;
      }
      
      // Update claimed status
      if (checkbox) {
        checkbox.checked = snack.checked || false;
      }
      if (nameInput) {
        nameInput.value = snack.claimed_by || '';
        nameInput.disabled = !snack.checked;
      }
      if (saveButton) {
        saveButton.disabled = !snack.checked;
      }
      
      // Update visual styling
      if (snack.claimed_by && snack.checked) {
        card.classList.add('snack-claimed');
        card.style.backgroundColor = 'rgba(224, 177, 74, 0.1)';
      } else {
        card.classList.remove('snack-claimed');
        card.style.backgroundColor = 'white';
      }
    }
  });
  
  // Then, add user-added cards
  arr.forEach((snack, index) => {
    if (!snack.is_default) {
      const emoji = snack.emoji || 'ğŸ';
      const item = snack.item || '';
      const claimed = snack.claimed_by || '';
      const checked = snack.checked || false;
      const div = document.createElement('div');
      div.className = 'p-4 rounded-xl bg-white user-added-snack-card';
      div.setAttribute('data-default-snack', 'false');
      div.style.border = '1px solid color-mix(in oklab, var(--md-slate) 35%, var(--md-white) 65%)';
      const tabIndexBase = (index * 3) + 13; // Start after default cards
      div.innerHTML = `
        <div class="flex items-center gap-3 mb-3">
          <input type="checkbox" class="snack-checkbox" onchange="toggleSnackInput(this)" tabindex="${tabIndexBase}" ${checked ? 'checked' : ''}>
          <span class="text-xl" contenteditable="true" style="cursor: text;">${emoji}</span>
          <span class="font-medium snack-title" contenteditable="true" style="cursor: text;">${item}</span>
        </div>
        <div class="flex items-center gap-2">
          <input type="text" placeholder="Your name" class="flex-1 px-3 py-2 rounded-lg text-sm snack-name" style="background: var(--md-cream);" value="${claimed}" ${checked ? '' : 'disabled'} tabindex="${tabIndexBase + 1}">
          <button class="px-3 py-2 rounded-lg text-white text-sm font-semibold" style="background: var(--md-coral);" onclick="claimSnack(this)" ${checked ? '' : 'disabled'} tabindex="${tabIndexBase + 2}">Save</button>
          <button class="text-gray-400 hover:text-red-500" onclick="this.closest('.p-4').remove()">âœ–</button>
        </div>
      `;
      snacksContainer.appendChild(div);
      
      // Add claimed styling if needed
      if (claimed && checked) {
        div.classList.add('snack-claimed');
        div.style.backgroundColor = 'rgba(224, 177, 74, 0.1)';
      }
    }
  });
}
function updateSnackMessage(snack_message) {
  const messageEl = document.getElementById('snackMessage');
  if (messageEl && snack_message) {
    messageEl.value = snack_message;
  }
}
function updateScholarInfo(scholar_name, scholar_blurb, scholar_skill) {
  const nameEl = document.querySelector('[data-page-panel="scholar"] h3[data-edit="teacher"]');
  const descEl = document.querySelector('[data-page-panel="scholar"] p[data-edit="teacher"]:not(.text-lg.font-semibold)');
  const skillEl = document.querySelector('[data-page-panel="scholar"] p.text-lg.font-semibold[data-edit="teacher"]');
  if (nameEl && scholar_name) nameEl.textContent = scholar_name;
  if (descEl && scholar_blurb) descEl.textContent = scholar_blurb;
  if (skillEl && scholar_skill) skillEl.textContent = scholar_skill;
}
function updateSkillsSection(skills_text, sounds_json) {
  const descEl = document.querySelector('[data-page-panel="skills"] p[data-edit="teacher"]');
  const vocabUl = document.querySelector('[data-page-panel="skills"] ul[data-edit="teacher"]');
  if (descEl && skills_text) descEl.textContent = skills_text;
  if (vocabUl && sounds_json) {
    const arr = parseArray(sounds_json);
    vocabUl.innerHTML = '';
    arr.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      vocabUl.appendChild(li);
    });
  }
}
function updateListeningSection(listening_text, ask_json) {
  const descEl = document.querySelector('[data-page-panel="listening"] p[data-edit="teacher"]');
  const ul = document.querySelector('[data-page-panel="listening"] ul[data-edit="teacher"]');
  if (descEl && listening_text) descEl.textContent = listening_text;
  if (ul && ask_json) {
    const arr = parseArray(ask_json);
    ul.innerHTML = '';
    arr.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      ul.appendChild(li);
    });
  }
}
function updateMathSection(math_text, math_vocab_json) {
  const descEl = document.querySelector('[data-page-panel="math"] p[data-edit="teacher"]');
  const ul = document.querySelector('[data-page-panel="math"] ul[data-edit="teacher"]');
  if (descEl && math_text) descEl.textContent = math_text;
  if (ul && math_vocab_json) {
    const arr = parseArray(math_vocab_json);
    ul.innerHTML = '';
    arr.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      ul.appendChild(li);
    });
  }
}
function updateExtrasSection(extras_json) {
  const extrasContainer = document.getElementById('extrasGrid');
  if (!extrasContainer) return;
  const arr = parseArray(extras_json);
  extrasContainer.innerHTML = '';
  arr.forEach(extra => {
    const emoji = extra.emoji || 'âœ¨';
    const title = extra.title || '';
    const body_html = extra.body_html || '';
    const div = document.createElement('div');
    div.className = 'text-center p-8 rounded-2xl';
    div.style.background = 'color-mix(in oklab, var(--md-white) 70%, var(--md-mustard) 30%)';
    div.style.border = '1px solid color-mix(in oklab, var(--md-mustard) 60%, var(--md-white) 40%)';
    div.innerHTML = `
      <div class="text-6xl mb-4 emoji-edit" contenteditable="true" style="cursor: text;">${emoji}</div>
      <h3 class="font-semibold mb-2" contenteditable="true" style="cursor: text;">${title}</h3>
      <p class="text-sm" contenteditable="true" style="cursor: text;">${body_html}</p>
      <button class="mt-2 text-red-500 hover:text-red-700 text-xs" onclick="this.closest('.text-center').remove();" style="display: none;">Remove Card</button>
    `;
    extrasContainer.appendChild(div);
  });
}
function updateAboutMeSection(data) {
  if (!data) return;
  
  // Update favorite fields by ID
  const favoriteColorEl = document.getElementById('favoriteColorText');
  if (favoriteColorEl && data.favorite_color) favoriteColorEl.textContent = data.favorite_color;
  
  const favoriteSnackEl = document.getElementById('favoriteSnackText');
  if (favoriteSnackEl && data.favorite_snack) favoriteSnackEl.textContent = data.favorite_snack;
  
  const favoriteDrinkEl = document.getElementById('favoriteDrinkText');
  if (favoriteDrinkEl && data.favorite_drink) favoriteDrinkEl.textContent = data.favorite_drink;
  
  const favoriteShowEl = document.getElementById('favoriteShowText');
  if (favoriteShowEl && data.favorite_show) favoriteShowEl.textContent = data.favorite_show;
  
  // Update about me description
  const aboutDescEl = document.getElementById('aboutMeDescText');
  if (aboutDescEl && data.about_me_html) {
    aboutDescEl.innerHTML = data.about_me_html;
  }
  
  // Update fun facts list
  const factsUl = document.getElementById('funFactsList');
  if (factsUl && data.fun_facts_html) {
    if (Array.isArray(data.fun_facts_html)) {
      factsUl.innerHTML = '';
      data.fun_facts_html.forEach(fact => {
        const li = document.createElement('li');
        li.textContent = fact;
        factsUl.appendChild(li);
      });
    } else {
      factsUl.innerHTML = data.fun_facts_html;
    }
  }
  
  // Update profile photos with proper reset handling
  updateProfilePhoto('scholar', data.scholar_profile_url);
  updateProfilePhoto('aboutme', data.about_me_profile_url);
}
function populateDataFromSheet(data) {
  // Always populate with either real data or fallback content
  if (!data) {
    console.log('Using fallback content due to missing data');
    data = getDefaultFallbackData();
  }
  
  updateWeekText(data.week);
  updateRecapText(data.recap);
  updateEventsList(data.dates_json);
  updateLookingAhead(data.looking_ahead);
  updateSnacksGrid(data.snacks_json);
  updateSnackMessage(data.snack_message);
  updateScholarInfo(data.scholar_name, data.scholar_blurb, data.scholar_skill);
  updateSkillsSection(data.skills_text, data.sounds_json);
  updateListeningSection(data.listening_text, data.ask_json);
  updateMathSection(data.math_text, data.math_vocab_json);
  updateExtrasSection(data.extras_json);
  updateAboutMeSection(data);
  
  // Load photo cards
  updatePhotoCards(data.photo_urls_json);
  
  // Load gallery photos
  updateGalleryPhotos(data.gallery_urls_json);
  
  // Load transportation data
  updateTransportationFields(data);

  
  // Load birthday data
  updateBirthdayFields(data);
  
  // Load website URLs
  updateWebsiteCards(data.websites_json);
  
  // Load Clever QR data
  updateCleverQRData(data.clever_qr_json);
  
  // Load ClassDojo QR data
  updateClassDojoQRData(data.classdojo_qr_json);
  
  // Load Watch Me data
  updateWatchMeData(data.watch_me_json);
  
  if (data.calendar_url) {
    const cal = document.getElementById('schoolCalendarLink');
    if (cal) cal.href = data.calendar_url;
    const calInput = document.getElementById('calendarUrlInput');
    if (calInput) calInput.value = data.calendar_url;
  }
}

// Function to update photo cards with saved URLs
async function updatePhotoCards(photoUrlsJson) {
  if (!photoUrlsJson) return;
  
  let photoUrls = [];
  try {
    photoUrls = JSON.parse(photoUrlsJson);
  } catch (e) {
    console.error('Failed to parse photo URLs:', e);
    return;
  }
  
  const photoCards = document.querySelectorAll('.photo-card');
  photoCards.forEach(async (card, index) => {
    const url = photoUrls[index];
    if (url && typeof url === 'string' && url.trim() !== '') {
      // Validate URL before using it
      const urlValid = await window.validateStorageUrl(url);
      if (urlValid) {
        card.setAttribute('data-photo-url', url);
        updatePhotoCardDisplay(card, url);
      } else {
        console.warn(`Invalid photo URL at index ${index}:`, url);
        // Reset to placeholder if URL is invalid
        resetPhotoCardToPlaceholder(card);
      }
    } else {
      // Reset to placeholder if URL is invalid
      resetPhotoCardToPlaceholder(card);
    }
  });
}

// Function to update gallery photos with saved URLs
async function updateGalleryPhotos(galleryUrlsJson) {
  if (!galleryUrlsJson) return;
  
  let galleryUrls = {};
  try {
    galleryUrls = JSON.parse(galleryUrlsJson);
  } catch (e) {
    console.error('Failed to parse gallery URLs:', e);
    return;
  }
  
  // New format: each subject has an array with exactly 2 slots
  for (const type of ['art', 'stem', 'gym', 'music']) {
    const galleryData = galleryUrls[type];
    
    // Get both slots for this subject
    const slot0 = document.querySelector(`[data-specials-type="${type}"][data-slot-index="0"]`);
    const slot1 = document.querySelector(`[data-specials-type="${type}"][data-slot-index="1"]`);
    
    if (!slot0 || !slot1) continue;
    
    if (galleryData) {
      // Support both old format (array of URLs) and new format (array with 2 slots)
      let urls = [];
      if (typeof galleryData === 'string' && galleryData.trim() !== '') {
        // Old format - single URL string, put in first slot
        urls = [galleryData, ''];
      } else if (Array.isArray(galleryData)) {
        // New format - array with up to 2 URLs
        urls = galleryData.slice(0, 2); // Only take first 2
        // Ensure we have exactly 2 slots (pad with empty strings if needed)
        while (urls.length < 2) {
          urls.push('');
        }
      } else {
        urls = ['', ''];
      }
      
      // Update slot 0
      if (urls[0] && urls[0].trim() !== '') {
        // Validate URL before using it
        const urlValid0 = await window.validateStorageUrl(urls[0]);
        if (urlValid0) {
          // Restore DOM structure before updating display
          restoreSpecialsSlotStructure(slot0);
          slot0.setAttribute('data-image-url', urls[0]);
          updateSpecialsSlotDisplay(slot0, urls[0]);
        } else {
          console.warn(`Invalid specials image URL for ${type} slot 0:`, urls[0]);
          restoreSpecialsSlotStructure(slot0);
          resetSpecialsSlotToPlaceholder(slot0);
        }
      } else {
        restoreSpecialsSlotStructure(slot0);
        resetSpecialsSlotToPlaceholder(slot0);
      }
      
      // Update slot 1
      if (urls[1] && urls[1].trim() !== '') {
        // Validate URL before using it
        const urlValid1 = await window.validateStorageUrl(urls[1]);
        if (urlValid1) {
          // Restore DOM structure before updating display
          restoreSpecialsSlotStructure(slot1);
          slot1.setAttribute('data-image-url', urls[1]);
          updateSpecialsSlotDisplay(slot1, urls[1]);
        } else {
          console.warn(`Invalid specials image URL for ${type} slot 1:`, urls[1]);
          restoreSpecialsSlotStructure(slot1);
          resetSpecialsSlotToPlaceholder(slot1);
        }
      } else {
        restoreSpecialsSlotStructure(slot1);
        resetSpecialsSlotToPlaceholder(slot1);
      }
    } else {
      // No gallery data, reset both slots to placeholder
      restoreSpecialsSlotStructure(slot0);
      resetSpecialsSlotToPlaceholder(slot0);
      restoreSpecialsSlotStructure(slot1);
      resetSpecialsSlotToPlaceholder(slot1);
    }
  }
}

// Function to update transportation fields with saved data
function updateTransportationFields(data) {
  if (!data) return;
  
  const busRidersEl = document.getElementById('busRidersTextarea');
  if (busRidersEl && data.bus_riders) {
    busRidersEl.value = data.bus_riders;
  }
  
  const carRidersEl = document.getElementById('carRidersTextarea');
  if (carRidersEl && data.car_riders) {
    carRidersEl.value = data.car_riders;
  }
  
  const porchPickupEl = document.getElementById('porchPickupTextarea');
  if (porchPickupEl && data.porch_pickup) {
    porchPickupEl.value = data.porch_pickup;
  }
  
  const instructionsEl = document.getElementById('transportationInstructionsTextarea');
  if (instructionsEl && data.transportation_instructions) {
    instructionsEl.value = data.transportation_instructions;
  }
}

// Function to save individual transportation fields
async function saveTransportationField(fieldType) {
  const buttonMap = {
    'busRiders': 'saveBusRidersBtn',
    'carRiders': 'saveCarRidersBtn', 
    'porchPickup': 'savePorchPickupBtn',
    'instructions': 'saveTransportationInstructionsBtn'
  };
  
  const textareaMap = {
    'busRiders': 'busRidersTextarea',
    'carRiders': 'carRidersTextarea',
    'porchPickup': 'porchPickupTextarea',
    'instructions': 'transportationInstructionsTextarea'
  };
  
  const dataMap = {
    'busRiders': 'bus_riders',
    'carRiders': 'car_riders',
    'porchPickup': 'porch_pickup',
    'instructions': 'transportation_instructions'
  };
  
  const saveBtn = document.getElementById(buttonMap[fieldType]);
  const textarea = document.getElementById(textareaMap[fieldType]);
  
  // Textarea is required, but save button is optional (for modal saves)
  if (!textarea) return;
  
  const originalText = saveBtn ? saveBtn.textContent : '';
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Check if Firebase is available
    if (typeof db === 'undefined') {
      console.error('Firebase not available - cannot save transportation data');
      if (saveBtn) {
        saveBtn.textContent = 'âŒ No Connection';
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }, 3000);
      }
      return;
    }
    
    // Show saving state (only if button exists)
    if (saveBtn) {
      saveBtn.textContent = 'â³ Saving...';
      saveBtn.disabled = true;
    }
    
    // Prepare data for saving
    const data = {};
    data[dataMap[fieldType]] = textarea.value || '';
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state (only if button exists)
    if (saveBtn) {
      saveBtn.textContent = 'âœ… Saved!';
      
      // Reset button after 1 second
      setTimeout(() => {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }, 1000);
    }
    
  } catch (error) {
    console.error('Failed to save transportation field:', error);
    if (saveBtn) {
      saveBtn.textContent = 'âŒ Save Failed';
      setTimeout(() => {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }, 2000);
    }
  }
}

// Function to save shoutout instructions

// Function to update birthday fields with saved data
function updateBirthdayFields(data) {
  if (!data) return;
  
  // Update class roster
  const classRosterEl = document.getElementById('classRosterTextarea');
  if (classRosterEl && data.class_roster) {
    classRosterEl.value = data.class_roster;
  }
  
  // Update monthly birthdays
  const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                  'july', 'august', 'september', 'october', 'november', 'december'];
  months.forEach(month => {
    const monthEl = document.getElementById(`${month}BirthdaysTextarea`);
    if (monthEl && data[`${month}_birthdays`]) {
      monthEl.value = data[`${month}_birthdays`];
    }
  });
}

// Transportation Modal Functions
let currentTransportationType = null;

function openTransportationModal(type) {
  const modal = document.getElementById('transportationModal');
  const icon = document.getElementById('transportationModalIcon');
  const title = document.getElementById('transportationModalTitle');
  const textarea = document.getElementById('transportationModalTextarea');
  
  // Store current type
  currentTransportationType = type;
  
  // Configure modal based on transportation type
  const config = {
    bus: {
      icon: 'ğŸšŒ',
      title: 'Bus Riders',
      color: '#fbbf24',
      placeholder: 'Student name and bus number\nExample:\nâ€¢ Emma S. - Bus #15\nâ€¢ Jake M. - Bus #23',
      dataField: 'busRiders'
    },
    car: {
      icon: 'ğŸš—',
      title: 'Car Riders',
      color: '#10b981',
      placeholder: 'Student name and pickup details\nExample:\nâ€¢ Sarah L. - Mom pickup\nâ€¢ Alex R. - Dad pickup',
      dataField: 'carRiders'
    },
    porch: {
      icon: 'ğŸ ',
      title: 'Porch Pickup',
      color: '#8b5cf6',
      placeholder: 'Student name and porch pickup notes\nExample:\nâ€¢ Mia K. - Front porch\nâ€¢ Noah T. - Side entrance',
      dataField: 'porchPickup'
    }
  };
  
  const typeConfig = config[type];
  if (typeConfig) {
    icon.textContent = typeConfig.icon;
    title.textContent = typeConfig.title;
    title.style.color = typeConfig.color;
    textarea.placeholder = typeConfig.placeholder;
    modal.style.setProperty('--modal-border-color', typeConfig.color);
    modal.style.setProperty('--modal-title-color', typeConfig.color);
    
    // Load existing data
    const existingTextarea = document.getElementById(`${typeConfig.dataField}Textarea`);
    if (existingTextarea) {
      textarea.value = existingTextarea.value;
    }
  }
  
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    textarea.focus();
  }
}

function closeTransportationModal() {
  const modal = document.getElementById('transportationModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
    currentTransportationType = null;
  }
}

function saveTransportationFromModal() {
  if (!currentTransportationType) return;
  
  const textarea = document.getElementById('transportationModalTextarea');
  const config = {
    bus: { field: 'busRiders', textareaId: 'busRidersTextarea' },
    car: { field: 'carRiders', textareaId: 'carRidersTextarea' },
    porch: { field: 'porchPickup', textareaId: 'porchPickupTextarea' }
  };
  
  const typeConfig = config[currentTransportationType];
  if (typeConfig && textarea) {
    // Update the hidden textarea (if it exists)
    const hiddenTextarea = document.getElementById(typeConfig.textareaId);
    if (hiddenTextarea) {
      hiddenTextarea.value = textarea.value;
    }
    
    // Save using existing function
    saveTransportationField(typeConfig.field);
    
    // Close modal
    closeTransportationModal();
  }
}

// Contact Me Modal Functions
function openContactModal() {
  const modal = document.getElementById('contactModal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeContactModal() {
  const modal = document.getElementById('contactModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// Learning Hub Modal Functions
function openLearningHubModal() {
  const modal = document.getElementById('learningHubModal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeLearningHubModal() {
  const modal = document.getElementById('learningHubModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// Family Hub Modal Functions
function openFamilyHubModal() {
  const modal = document.getElementById('familyHubModal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeFamilyHubModal() {
  const modal = document.getElementById('familyHubModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// About Mr. Davis Modal Functions
function openAboutMeDavisModal() {
  const modal = document.getElementById('aboutMeDavisModal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeAboutMeDavisModal() {
  const modal = document.getElementById('aboutMeDavisModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// Shoutout Modal Functions
function openShoutoutModal() {
  const modal = document.getElementById('shoutoutModal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeShoutoutModal() {
  const modal = document.getElementById('shoutoutModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// Shoutout PIN Modal Functions
function openShoutoutPinModal() {
  const modal = document.getElementById('shoutoutPinModal');
  if (modal) {
    modal.style.display = 'flex';
    document.getElementById('shoutoutPinInput').focus();
    document.body.style.overflow = 'hidden';
  }
}

function closeShoutoutPinModal() {
  const modal = document.getElementById('shoutoutPinModal');
  if (modal) {
    modal.style.display = 'none';
    document.getElementById('shoutoutPinInput').value = '';
    document.body.style.overflow = '';
  }
}

// Shoutout messages array
const shoutoutMessages = [
  "for showing amazing focus and trying your best all week!",
  "for being such a kind and respectful friend in class!",
  "for staying positive and finishing your work in a snap!",
  "for helping your classmates and spreading kindness!",
  "for showing grit and never giving up, even when it's hard!",
  "for being a great listener during lessons and discussions!",
  "for giving 100% effort during math time â€” great perseverance!",
  "for your creativity and excitement during writing time!",
  "for your great attitude and leadership in group work!",
  "for always having a smile and lifting up our class!",
  "for showing focus and determination in your learning!",
  "for working hard and being a role model for others!",
  "for showing respect and responsibility every single day!",
  "for asking thoughtful questions and being curious about learning!",
  "for making our classroom a fun and caring place to be!",
  "for your exceptional work ethic and dedication to learning!",
  "for demonstrating outstanding character and kindness this week!",
  "for your willingness to help others and be a team player!",
  "for showing incredible growth in reading and math!",
  "for being brave and trying new things even when they're challenging!",
  "for your positive energy that brightens everyone's day!",
  "for following directions the first time and being so responsible!",
  "for your creative thinking and unique ideas in class!",
  "for being a problem-solver and thinking things through!",
  "for making good choices and showing self-control!",
  "for your enthusiasm and love for learning new things!",
  "for being a compassionate friend who cares about others!",
  "for showing patience and persistence in your work!",
  "for your excellent behavior and setting a great example!",
  "for making everyone feel included and welcome in our class!"
];

// Scholar names for random generation
const scholarNames = [
  "Emmalina", "Makaylah", "Rudy", "Mila", "Oliver", "Elon", "Javier", 
  "Andrei", "Ayda", "Dominic", "Ezra", "Zenaida", "Bryley", "Aliyah", "Aren"
];

let currentShoutoutPinTarget = null;

// Shoutout functionality
function shuffleShoutout() {
  const display = document.getElementById('shoutoutDisplay');
  if (display) {
    const randomMessage = shoutoutMessages[Math.floor(Math.random() * shoutoutMessages.length)];
    display.textContent = randomMessage;
  }
}

function editShoutout() {
  const display = document.getElementById('shoutoutDisplay');
  if (display) {
    const textarea = document.createElement('textarea');
    textarea.value = display.textContent;
    textarea.className = 'w-full h-32 p-3 rounded-lg border text-center resize-none';
    textarea.style.fontFamily = '"Comic Sans MS", "Comic Neue", cursive, sans-serif';
    textarea.style.fontSize = '1.2rem';
    textarea.placeholder = "We're cheering for you and all your hard work.";
    
    display.innerHTML = '';
    display.appendChild(textarea);
    
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Save';
    saveBtn.className = 'mt-3 px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90';
    saveBtn.style.background = 'var(--md-coral)';
    saveBtn.onclick = function() {
      const newText = textarea.value.trim() || "We're cheering for you and all your hard work.";
      display.innerHTML = newText;
    };
    
    display.appendChild(saveBtn);
    textarea.focus();
  }
}

// NEW SHOUTOUT PAGE FUNCTIONS

// Create Shoutout Modal Functions
function openCreateShoutoutModal() {
  const modal = document.getElementById('createShoutoutModal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    // Clear form
    document.getElementById('scholarNameInput').value = '';
    document.getElementById('fromInput').value = '';
    document.getElementById('messageInput').value = '';
  }
}

function closeCreateShoutoutModal() {
  const modal = document.getElementById('createShoutoutModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

// Generate random shoutout
function generateShoutout() {
  // Randomly select a scholar name
  const randomScholar = scholarNames[Math.floor(Math.random() * scholarNames.length)];
  
  // Randomly select a message
  const randomMessage = shoutoutMessages[Math.floor(Math.random() * shoutoutMessages.length)];
  
  // Fill the form fields
  document.getElementById('scholarNameInput').value = randomScholar;
  document.getElementById('messageInput').value = randomMessage;
  document.getElementById('fromInput').value = 'Mr. Davis';
}

// Submit new shoutout
async function submitShoutout() {
  const scholarName = document.getElementById('scholarNameInput').value.trim();
  const from = document.getElementById('fromInput').value.trim();
  const message = document.getElementById('messageInput').value.trim();
  
  if (!scholarName || !from || !message) {
    alert('Please fill in all fields!');
    return;
  }
  
  const shoutout = {
    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    scholarName,
    from,
    message,
    approved: false,
    timestamp: new Date().toISOString()
  };
  
  // Add to local array
  allShoutouts.push(shoutout);
  
  // Save to Firebase using arrayUnion to append safely without overwriting
  // Use requireAuth=false for parent submissions (they use anonymous auth)
  const saveSuccess = await saveShoutoutsToFirebase(false, false, shoutout);
  
  closeCreateShoutoutModal();
  
  // Show success or failure message
  const display = document.getElementById('shoutoutTVDisplay');
  if (display) {
    if (saveSuccess) {
      display.innerHTML = `
        <div style="color: var(--md-coral);">
          âœ¨ Shoutout submitted! âœ¨<br>
          <span style="font-size: 1.2rem;">Thank you for spreading kindness!</span><br>
          <span style="font-size: 1rem; opacity: 0.8;">Your message will appear after approval.</span>
        </div>
      `;
    } else {
      display.innerHTML = `
        <div style="color: var(--md-coral);">
          âš ï¸ Shoutout created locally âš ï¸<br>
          <span style="font-size: 1.2rem;">But there was a save error.</span><br>
          <span style="font-size: 1rem; opacity: 0.8;">Please contact support if this persists.</span>
        </div>
      `;
    }
  }
}

// Shuffle through approved shoutouts on TV
function shuffleShoutoutTV() {
  if (approvedShoutouts.length === 0) {
    const display = document.getElementById('shoutoutTVDisplay');
    if (display) {
      // Show main message when no approved shoutouts
      display.innerHTML = `<div style="color: var(--md-white);">${mainTVMessage}</div>`;
    }
    return;
  }
  
  currentShoutoutIndex = (currentShoutoutIndex + 1) % approvedShoutouts.length;
  const shoutout = approvedShoutouts[currentShoutoutIndex];
  
  const display = document.getElementById('shoutoutTVDisplay');
  if (display && shoutout) {
    display.innerHTML = `
      <div>
        <div style="color: var(--md-mustard); font-size: 1.2rem; margin-bottom: 0.5rem;">${shoutout.scholarName}</div>
        <div style="margin-bottom: 1rem;">${shoutout.message}</div>
        <div style="color: var(--md-coral); font-size: 1rem;">â€” ${shoutout.from}</div>
      </div>
    `;
  }
}

// Admin Shoutouts Management
function openAdminShoutsModal() {
  // Check if Edit Mode is active (body has 'editing' class)
  if (!document.body.classList.contains('editing')) {
    alert('Please enter Edit Mode first to access shoutout management.');
    return;
  }
  
  const modal = document.getElementById('adminShoutsModal');
  if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Always reload fresh data from Firebase when opening admin modal
    loadShoutoutsFromFirebase().then(() => {
      refreshAdminShoutouts();
    });
    
    // Load and populate the main message
    loadMainMessage();
  }
}

function closeAdminShoutsModal() {
  const modal = document.getElementById('adminShoutsModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }
}

function filterShoutouts(filter) {
  // Update filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).classList.add('active');
  
  refreshAdminShoutouts(filter);
}

function refreshAdminShoutouts(filter = 'all') {
  const container = document.getElementById('adminShoutsContainer');
  if (!container) return;
  
  let shoutsToShow = allShoutouts;
  if (filter === 'pending') {
    shoutsToShow = allShoutouts.filter(s => !s.approved && !s.archived);
  } else if (filter === 'approved') {
    shoutsToShow = allShoutouts.filter(s => s.approved && !s.archived);
  } else if (filter === 'archived') {
    shoutsToShow = allShoutouts.filter(s => s.archived);
  } else if (filter === 'all') {
    shoutsToShow = allShoutouts.filter(s => !s.archived);
  }
  
  if (shoutsToShow.length === 0) {
    container.innerHTML = '<div class="text-center text-gray-500 py-8">No shoutouts found.</div>';
    return;
  }
  
  container.innerHTML = shoutsToShow.map(shoutout => `
    <div class="bg-white rounded-lg p-4 border ${shoutout.archived ? 'border-gray-300 bg-gray-50' : shoutout.approved ? 'border-green-200 bg-green-50' : 'border-yellow-200 bg-yellow-50'}">
      <div class="flex justify-between items-start mb-2">
        <div>
          <strong style="color: var(--md-slate);">${shoutout.scholarName}</strong>
          <span class="text-sm text-gray-500"> from ${shoutout.from}</span>
        </div>
        <div class="flex gap-1">
          ${!shoutout.approved && !shoutout.archived ? `<button onclick="approveShoutout('${shoutout.id}')" class="px-2 py-1 bg-green-500 text-white rounded text-xs">Approve</button>` : ''}
          ${!shoutout.archived ? `<button onclick="archiveShoutout('${shoutout.id}')" class="px-2 py-1 bg-gray-500 text-white rounded text-xs">Archive</button>` : ''}
          ${shoutout.archived ? `<button onclick="unarchiveShoutout('${shoutout.id}')" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">Unarchive</button>` : ''}
          <button onclick="editShoutoutAdmin('${shoutout.id}')" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">Edit</button>
          <button onclick="deleteShoutout('${shoutout.id}')" class="px-2 py-1 bg-red-500 text-white rounded text-xs">Delete</button>
        </div>
      </div>
      <div class="text-sm mb-2" style="font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif;">${shoutout.message}</div>
      <div class="text-xs text-gray-400">${new Date(shoutout.timestamp).toLocaleDateString()}</div>
    </div>
  `).join('');
}

async function approveShoutout(id) {
  const shoutout = allShoutouts.find(s => s.id === id);
  if (shoutout) {
    shoutout.approved = true;
    const saveSuccess = await saveShoutoutsToFirebase();
    if (!saveSuccess) {
      // Revert the change if save failed
      shoutout.approved = false;
    }
    updateApprovedShoutouts();
    refreshAdminShoutouts();
  }
}

async function archiveShoutout(id) {
  const shoutout = allShoutouts.find(s => s.id === id);
  if (shoutout) {
    shoutout.archived = true;
    const saveSuccess = await saveShoutoutsToFirebase();
    if (!saveSuccess) {
      // Revert the change if save failed
      delete shoutout.archived;
    }
    updateApprovedShoutouts();
    refreshAdminShoutouts();
  }
}

async function unarchiveShoutout(id) {
  const shoutout = allShoutouts.find(s => s.id === id);
  if (shoutout) {
    shoutout.archived = false;
    const saveSuccess = await saveShoutoutsToFirebase();
    if (!saveSuccess) {
      // Revert the change if save failed
      shoutout.archived = true;
    }
    updateApprovedShoutouts();
    refreshAdminShoutouts();
  }
}

async function deleteShoutout(id) {
  if (confirm('Delete this shoutout?')) {
    const originalShoutouts = [...allShoutouts]; // Keep backup
    allShoutouts = allShoutouts.filter(s => s.id !== id);
    const saveSuccess = await saveShoutoutsToFirebase();
    if (!saveSuccess) {
      // Restore original data if save failed
      allShoutouts = originalShoutouts;
    }
    updateApprovedShoutouts();
    refreshAdminShoutouts();
  }
}

function editShoutoutAdmin(id) {
  const shoutout = allShoutouts.find(s => s.id === id);
  if (!shoutout) return;
  
  const originalMessage = shoutout.message;
  const newMessage = prompt('Edit message:', shoutout.message);
  if (newMessage !== null && newMessage.trim()) {
    shoutout.message = newMessage.trim();
    saveShoutoutsToFirebase().then(saveSuccess => {
      if (!saveSuccess) {
        // Revert the change if save failed
        shoutout.message = originalMessage;
      }
      refreshAdminShoutouts();
    });
  }
}

// Data persistence functions
async function saveShoutoutsToFirebase(showErrorPopup = true, requireAuth = true, newShoutout = null) {
  if (!db) {
    if (showErrorPopup) {
      showShoutoutError('Not connected to Firebase. Your shoutout was not saved.');
    }
    return false;
  }
  
  try {
    // Check authentication before saving
    if (requireAuth) {
      await ensureAuthenticated();
    } else {
      // For public submissions (parents), ensure valid authentication
      if (auth) {
        // Check if user is already authenticated
        if (auth.currentUser) {
          // Check if it's a Google user (from edit mode) or anonymous
          const isGoogleUser = auth.currentUser.providerData.some(
            provider => provider.providerId === 'google.com'
          );
          
          if (isGoogleUser) {
            // Google user exists, verify token is still valid by refreshing it
            try {
              await auth.currentUser.getIdToken(true);
              console.log('Using existing Google authentication for shoutout submission');
            } catch (error) {
              // Token refresh failed, sign out and use anonymous auth
              console.log('Google auth token expired, switching to anonymous auth');
              await auth.signOut();
              await auth.signInAnonymously();
              console.log('Anonymous authentication successful');
            }
          } else {
            // Already have anonymous auth, verify it's still valid
            try {
              await auth.currentUser.getIdToken(true);
              console.log('Using existing anonymous authentication for shoutout submission');
            } catch (error) {
              // Token refresh failed, re-authenticate
              console.log('Anonymous auth token expired, re-authenticating');
              await auth.signInAnonymously();
              console.log('Anonymous authentication successful');
            }
          }
        } else {
          // No user signed in, use anonymous auth
          console.log('Authenticating for shoutout submission...');
          await auth.signInAnonymously();
          console.log('Anonymous authentication successful');
        }
      }
    }
    
    // If a new shoutout is provided, use arrayUnion to append safely
    // This prevents overwriting existing shoutouts when parents submit
    if (newShoutout) {
      await db.collection('shoutouts').doc('data').set({
        shoutouts: firebase.firestore.FieldValue.arrayUnion(newShoutout),
        lastUpdated: new Date().toISOString()
      }, { merge: true });
      console.log('Shoutout appended to Firebase using arrayUnion');
    } else {
      // For admin operations (approve/delete/edit), replace entire array
      await db.collection('shoutouts').doc('data').set({
        shoutouts: allShoutouts,
        lastUpdated: new Date().toISOString()
      });
      console.log('Shoutouts saved to Firebase');
    }
    return true;
  } catch (error) {
    console.error('Failed to save shoutouts:', error);
    if (showErrorPopup) {
      showShoutoutError('Failed to save shoutout. Please try again or contact support.');
    }
    return false;
  }
}

async function loadShoutoutsFromFirebase() {
  if (!db) {
    showShoutoutError('Not connected to Firebase. Cannot load latest shoutouts.');
    return false;
  }
  
  try {
    const doc = await db.collection('shoutouts').doc('data').get();
    if (doc.exists) {
      const data = doc.data();
      allShoutouts = data.shoutouts || [];
      updateApprovedShoutouts();
      console.log('Shoutouts loaded from Firebase:', allShoutouts.length);
      return true;
    } else {
      // No data exists yet - this is normal for a new app
      allShoutouts = [];
      updateApprovedShoutouts();
      console.log('No shoutouts data found in Firebase - starting fresh');
      return true;
    }
  } catch (error) {
    console.error('Failed to load shoutouts:', error);
    showShoutoutError('Failed to load latest shoutouts. You may be seeing outdated data.');
    return false;
  }
}

function updateApprovedShoutouts() {
  approvedShoutouts = allShoutouts.filter(s => s.approved && !s.archived);
  
  // Don't automatically shuffle when shoutouts are updated
  // Let the user manually shuffle to see shoutouts
  // The TV will show the main message by default
}

// Function to show user-friendly error messages for shoutout operations
function showShoutoutError(message) {
  // Remove any existing error messages
  const existingError = document.getElementById('shoutoutError');
  if (existingError) {
    existingError.remove();
  }
  
  // Create error notification
  const errorDiv = document.createElement('div');
  errorDiv.id = 'shoutoutError';
  errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50 max-w-sm';
  errorDiv.innerHTML = `
    <div class="flex">
      <div class="flex-shrink-0">
        <span class="text-red-500">âš ï¸</span>
      </div>
      <div class="ml-3">
        <p class="text-sm font-medium">Shoutout Error</p>
        <p class="text-sm">${message}</p>
      </div>
      <div class="ml-auto pl-3">
        <button class="text-red-400 hover:text-red-600" onclick="this.parentElement.parentElement.parentElement.remove()">
          <span class="sr-only">Dismiss</span>
          âœ•
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(errorDiv);
  
  // Auto-remove error after 8 seconds
  setTimeout(() => {
    if (errorDiv.parentNode) {
      errorDiv.remove();
    }
  }, 8000);
}

// Main TV Message Functions
async function saveMainMessage() {
  const textarea = document.getElementById('mainMessageTextarea');
  const saveBtn = document.getElementById('saveMainMessageBtn');
  
  if (!textarea || !saveBtn) return;
  
  const newMessage = textarea.value.trim();
  if (!newMessage) {
    alert('Please enter a message for the TV display.');
    return;
  }
  
  const originalText = saveBtn.textContent;
  saveBtn.textContent = 'â³ Saving...';
  saveBtn.disabled = true;
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Update the local variable
    mainTVMessage = newMessage;
    
    // Save to Firestore
    if (db) {
      await db.collection('classData').doc('current').set({
        mainTVMessage: newMessage
      }, { merge: true });
      console.log('Main TV message saved to Firestore');
    } else {
      // Fallback to localStorage for testing
      localStorage.setItem('mainTVMessage', newMessage);
    }
    
    // Update the TV display if it's currently showing the main message
    updateTVDisplay();
    
    // Show success state
    saveBtn.textContent = 'âœ… Saved!';
    
    // Reset button after delay
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1500);
    
  } catch (error) {
    console.error('Failed to save main TV message:', error);
    saveBtn.textContent = 'âŒ Error';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

async function loadMainMessage() {
  try {
    if (db) {
      const doc = await db.collection('classData').doc('current').get();
      if (doc.exists) {
        const data = doc.data();
        if (data.mainTVMessage) {
          mainTVMessage = data.mainTVMessage;
        }
      }
    } else {
      // Fallback to localStorage for testing
      const saved = localStorage.getItem('mainTVMessage');
      if (saved) {
        mainTVMessage = saved;
      }
    }
    
    // Update textarea in admin modal if it exists
    const textarea = document.getElementById('mainMessageTextarea');
    if (textarea) {
      textarea.value = mainTVMessage;
    }
    
    console.log('Main TV message loaded:', mainTVMessage);
  } catch (error) {
    console.error('Failed to load main TV message:', error);
  }
}

function updateTVDisplay() {
  const display = document.getElementById('shoutoutTVDisplay');
  if (!display) return;
  
  // Show main message by default
  display.innerHTML = `<div style="color: var(--md-white);">${mainTVMessage}</div>`;
}

// Function to update website cards with saved URLs and order
function updateWebsiteCards(websitesJson) {
  if (!websitesJson) return;
  
  let websites = [];
  try {
    websites = JSON.parse(websitesJson);
  } catch (e) {
    console.error('Failed to parse websites JSON:', e);
    return;
  }
  
  // Check if order information is present
  const hasOrder = websites.length > 0 && websites[0].hasOwnProperty('order');
  
  if (hasOrder) {
    // Sort websites by order
    websites.sort((a, b) => (a.order || 0) - (b.order || 0));
    
    // Rebuild the grid with saved order
    const grid = document.getElementById('websitesGrid');
    if (!grid) return;
    
    const websiteCards = [...grid.querySelectorAll('.website-card')];
    
    // Create a map of IDs to cards for matching
    const cardMap = new Map();
    websiteCards.forEach(card => {
      const websiteId = card.getAttribute('data-website-id');
      if (websiteId) {
        cardMap.set(websiteId, card);
      }
    });
    
    // Reorder cards based on saved order
    websites.forEach((website, index) => {
      const card = cardMap.get(website.id);
      if (card) {
        grid.appendChild(card);
        card.setAttribute('data-order', index);
        
        // Update URL, title, and emoji
        const urlInput = card.querySelector('.website-url-input');
        const linkEl = card.querySelector('.website-link');
        const titleEl = card.querySelector('.website-title');
        const emojiEl = card.querySelector('.text-4xl');
        
        if (urlInput && website.url) urlInput.value = website.url;
        if (linkEl && website.url) linkEl.href = website.url;
        if (titleEl && website.title) titleEl.textContent = website.title;
        if (emojiEl && website.emoji) emojiEl.textContent = website.emoji;
      }
    });
  } else {
    // Legacy format: just update URLs without reordering
    const websiteCards = document.querySelectorAll('.website-card');
    websiteCards.forEach((card, index) => {
      const website = websites[index];
      if (website && website.url) {
        const urlInput = card.querySelector('.website-url-input');
        const linkEl = card.querySelector('.website-link');
        const titleEl = card.querySelector('.website-title');
        const emojiEl = card.querySelector('.text-4xl');
        
        if (urlInput) urlInput.value = website.url;
        if (linkEl) linkEl.href = website.url;
        if (titleEl && website.title) titleEl.textContent = website.title;
        if (emojiEl && website.emoji) emojiEl.textContent = website.emoji;
      }
    });
  }
}

// Function to save individual birthday fields
async function saveBirthdayField(fieldType) {
  const saveBtn = document.getElementById('saveClassRosterBtn');
  const textarea = document.getElementById('classRosterTextarea');
  
  if (!saveBtn || !textarea) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Show saving state
    saveBtn.textContent = 'â³ Saving...';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {};
    data.class_roster = textarea.value || '';
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = 'âœ… Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save birthday field:', error);
    saveBtn.textContent = 'âŒ Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to save all birthday fields at once
async function saveAllBirthdays() {
  const saveBtn = document.getElementById('saveAllBirthdaysBtn');
  
  if (!saveBtn) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Show saving state
    saveBtn.textContent = 'â³ Saving...';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {};
    
    // Collect all monthly birthday data
    const months = ['january', 'february', 'march', 'april', 'may', 'june', 
                    'july', 'august', 'september', 'october', 'november', 'december'];
    months.forEach(month => {
      const monthEl = document.getElementById(`${month}BirthdaysTextarea`);
      if (monthEl) {
        data[`${month}_birthdays`] = monthEl.value || '';
      }
    });
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = 'âœ… Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save birthday fields:', error);
    saveBtn.textContent = 'âŒ Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to save individual About Me fields
async function saveAboutMeField(fieldType) {
  const fieldMap = {
    'aboutMeDesc': {
      button: 'saveAboutMeDescBtn',
      element: 'aboutMeDescText',
      dataField: 'about_me_html',
      getContent: (el) => el.innerHTML || ''
    },
    'funFacts': {
      button: 'saveFunFactsBtn', 
      element: 'funFactsList',
      dataField: 'fun_facts_html',
      getContent: (el) => {
        const listItems = Array.from(el.querySelectorAll('li')).map(li => li.textContent || '');
        return listItems;
      }
    },
    'favoriteColor': {
      button: 'saveFavoriteColorBtn',
      element: 'favoriteColorText', 
      dataField: 'favorite_color',
      getContent: (el) => el.textContent || ''
    },
    'favoriteSnack': {
      button: 'saveFavoriteSnackBtn',
      element: 'favoriteSnackText',
      dataField: 'favorite_snack', 
      getContent: (el) => el.textContent || ''
    },
    'favoriteDrink': {
      button: 'saveFavoriteDrinkBtn',
      element: 'favoriteDrinkText',
      dataField: 'favorite_drink',
      getContent: (el) => el.textContent || ''
    },
    'favoriteShow': {
      button: 'saveFavoriteShowBtn',
      element: 'favoriteShowText',
      dataField: 'favorite_show',
      getContent: (el) => el.textContent || ''
    }
  };
  
  const field = fieldMap[fieldType];
  if (!field) return;
  
  const saveBtn = document.getElementById(field.button);
  const element = document.getElementById(field.element);
  
  if (!saveBtn || !element) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Show saving state
    saveBtn.textContent = 'â³';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {};
    data[field.dataField] = field.getContent(element);
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = 'âœ…';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save About Me field:', error);
    saveBtn.textContent = 'âŒ';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to save all extras cards
async function saveExtrasCards() {
  const saveBtn = document.getElementById('saveExtrasBtn');
  
  if (!saveBtn) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Show saving state
    saveBtn.textContent = 'â³ Saving...';
    saveBtn.disabled = true;
    
    // Collect extras data
    const extrasGrid = document.getElementById('extrasGrid');
    const extras = [];
    
    if (extrasGrid) {
      extrasGrid.querySelectorAll('.text-center').forEach(card => {
        const emojiEl = card.querySelector('.emoji-edit');
        const titleEl = card.querySelector('h3');
        const bodyEl = card.querySelector('p');
        
        if (titleEl && bodyEl) {
          extras.push({
            emoji: emojiEl ? emojiEl.textContent || 'âœ¨' : 'âœ¨',
            title: titleEl.textContent || '',
            body_html: bodyEl.textContent || ''
          });
        }
      });
    }
    
    // Prepare data for saving
    const data = {
      extras_json: JSON.stringify(extras)
    };
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = 'âœ… Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save extras cards:', error);
    saveBtn.textContent = 'âŒ Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to save website URLs
async function saveWebsiteUrls() {
  const saveBtn = document.getElementById('saveWebsitesBtn');
  
  if (!saveBtn) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Show saving state
    saveBtn.textContent = 'â³ Saving...';
    saveBtn.disabled = true;
    
    // Collect website data including order, emojis, and titles
    const websiteCards = document.querySelectorAll('.website-card');
    const websites = [];
    
    websiteCards.forEach((card, index) => {
      const titleEl = card.querySelector('.website-title');
      const urlInput = card.querySelector('.website-url-input');
      const linkEl = card.querySelector('.website-link');
      const emojiEl = card.querySelector('.text-4xl');
      const websiteId = card.getAttribute('data-website-id');
      
      if (titleEl) {
        websites.push({
          id: websiteId || `website-${index}`,
          order: index,
          title: titleEl.textContent || '',
          url: urlInput?.value || linkEl?.href || '',
          emoji: emojiEl?.textContent || '',
          styles: {
            border: card.style.border || '',
            background: linkEl?.style.background || ''
          }
        });
      }
    });
    
    // Prepare data for saving
    const data = {
      websites_json: JSON.stringify(websites)
    };
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = 'âœ… Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save website URLs:', error);
    saveBtn.textContent = 'âŒ Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Function to save website order
async function saveWebsiteOrder() {
  const saveBtn = document.getElementById('saveWebsiteOrderBtn');
  
  if (!saveBtn) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Show saving state
    saveBtn.textContent = 'â³ Saving...';
    saveBtn.disabled = true;
    
    // Collect website data with order
    const websiteCards = document.querySelectorAll('.website-card');
    const websites = [];
    
    websiteCards.forEach((card, index) => {
      const titleEl = card.querySelector('.website-title');
      const urlInput = card.querySelector('.website-url-input');
      const linkEl = card.querySelector('.website-link');
      const emojiEl = card.querySelector('.text-4xl');
      const websiteId = card.getAttribute('data-website-id');
      
      if (titleEl) {
        websites.push({
          id: websiteId || `website-${index}`,
          order: index,
          title: titleEl.textContent || '',
          url: urlInput?.value || linkEl?.href || '',
          emoji: emojiEl?.textContent || '',
          styles: {
            border: card.style.border || '',
            background: linkEl?.style.background || ''
          }
        });
      }
    });
    
    // Prepare data for saving
    const data = {
      websites_json: JSON.stringify(websites)
    };
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = 'âœ… Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save website order:', error);
    saveBtn.textContent = 'âŒ Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

// Drag and drop functionality for website cards
let draggedCard = null;

function setupWebsiteDragAndDrop() {
  const websiteCards = document.querySelectorAll('.website-card');
  
  websiteCards.forEach(card => {
    card.setAttribute('draggable', 'true');
    card.style.cursor = 'move';
    
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragover', handleDragOver);
    card.addEventListener('drop', handleDrop);
    card.addEventListener('dragend', handleDragEnd);
    card.addEventListener('dragleave', handleDragLeave);
  });
}

function disableWebsiteDragAndDrop() {
  const websiteCards = document.querySelectorAll('.website-card');
  
  websiteCards.forEach(card => {
    card.setAttribute('draggable', 'false');
    card.style.cursor = 'default';
    
    card.removeEventListener('dragstart', handleDragStart);
    card.removeEventListener('dragover', handleDragOver);
    card.removeEventListener('drop', handleDrop);
    card.removeEventListener('dragend', handleDragEnd);
    card.removeEventListener('dragleave', handleDragLeave);
  });
}

function handleDragStart(e) {
  draggedCard = this;
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  
  if (this !== draggedCard) {
    this.style.borderTop = '3px solid var(--md-coral)';
  }
  
  return false;
}

function handleDragLeave(e) {
  this.style.borderTop = '';
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  
  if (draggedCard !== this) {
    const grid = document.getElementById('websitesGrid');
    const allCards = [...grid.querySelectorAll('.website-card')];
    const draggedIndex = allCards.indexOf(draggedCard);
    const targetIndex = allCards.indexOf(this);
    
    if (draggedIndex < targetIndex) {
      this.parentNode.insertBefore(draggedCard, this.nextSibling);
    } else {
      this.parentNode.insertBefore(draggedCard, this);
    }
    
    // Update data-order attributes
    const cards = grid.querySelectorAll('.website-card');
    cards.forEach((card, index) => {
      card.setAttribute('data-order', index);
    });
  }
  
  this.style.borderTop = '';
  return false;
}

function handleDragEnd(e) {
  this.style.opacity = '1';
  
  const allCards = document.querySelectorAll('.website-card');
  allCards.forEach(card => {
    card.style.borderTop = '';
  });
}

// Clever QR Codes functions
function openCleverQRPanel() {
  const panel = document.getElementById('cleverQRPanel');
  if (panel) {
    panel.style.display = 'flex';
    renderCleverQRContent();
  }
}

function closeCleverQRPanel() {
  const panel = document.getElementById('cleverQRPanel');
  const searchInput = document.getElementById('cleverQRSearchInput');
  if (panel) {
    panel.style.display = 'none';
  }
  // Clear search input when closing
  if (searchInput) {
    searchInput.value = '';
  }
}

function renderCleverQRContent() {
  const content = document.getElementById('cleverQRContent');
  const editControls = document.getElementById('cleverQREditControls');
  const searchBar = document.getElementById('cleverQRSearchBar');
  const isEditMode = document.body.classList.contains('editing');
  
  if (!content) return;
  
  // Show/hide edit controls based on edit mode
  if (editControls) {
    editControls.style.display = isEditMode ? 'block' : 'none';
  }
  
  // Show/hide search bar based on edit mode
  if (searchBar) {
    searchBar.style.display = isEditMode ? 'none' : 'block';
  }
  
  if (cleverQRData.length === 0) {
    content.innerHTML = '<p class="text-center text-gray-500 py-8">No QR codes added yet.</p>';
    return;
  }
  
  if (isEditMode) {
    // Edit mode: show all entries with inputs and delete button
    const html = cleverQRData.map((item, index) => {
      return `
        <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
          <input type="text" value="${escapeHtml(item.name)}" 
                 class="flex-1 px-3 py-2 text-sm border rounded-lg clever-qr-name" 
                 data-index="${index}" 
                 onchange="updateCleverQREntry(${index})">
          <input type="url" value="${escapeHtml(item.qrUrl)}" 
                 class="flex-1 px-3 py-2 text-sm border rounded-lg clever-qr-url" 
                 data-index="${index}" 
                 placeholder="QR code URL"
                 onchange="updateCleverQREntry(${index})">
          <button onclick="deleteCleverQREntry(${index})" 
                  class="px-3 py-2 rounded-lg text-white text-sm font-semibold" 
                  style="background: var(--md-coral);">Delete</button>
        </div>
      `;
    }).join('');
    
    content.innerHTML = html;
  } else {
    // View mode: show prompt to search
    content.innerHTML = '<p class="text-center text-gray-500 py-8">Type a scholar\'s full first or last name and press Enter to view their QR code.</p>';
  }
}

function searchCleverQR() {
  const searchInput = document.getElementById('cleverQRSearchInput');
  const content = document.getElementById('cleverQRContent');
  
  if (!searchInput || !content) return;
  
  const searchTerm = searchInput.value.trim().toLowerCase();
  
  if (!searchTerm) {
    content.innerHTML = '<p class="text-center text-gray-500 py-8">Type a scholar\'s full first or last name and press Enter to view their QR code.</p>';
    return;
  }
  
  // Find exact matches (full first name or full last name)
  const matches = cleverQRData.filter(item => {
    const fullName = item.name.toLowerCase();
    const nameParts = fullName.split(/\s+/); // Split by whitespace
    
    // Check if search term exactly matches any name part (first, middle, or last name)
    return nameParts.some(part => part === searchTerm);
  });
  
  if (matches.length === 0) {
    content.innerHTML = '<p class="text-center text-gray-500 py-8">No matching scholars found. Please try again with the full first or last name.</p>';
  } else {
    const html = matches.map(item => {
      return `
        <div class="p-3 bg-gray-50 rounded-lg">
          <a href="${escapeHtml(item.qrUrl)}" 
             target="_blank" 
             class="text-lg font-semibold hover:underline" 
             style="color: var(--md-mustard);">
            ${escapeHtml(item.name)}
          </a>
        </div>
      `;
    }).join('');
    
    content.innerHTML = html;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function addCleverQREntry() {
  const nameInput = document.getElementById('newStudentName');
  const qrInput = document.getElementById('newStudentQR');
  
  if (!nameInput || !qrInput) return;
  
  const name = nameInput.value.trim();
  const qrUrl = qrInput.value.trim();
  
  if (!name || !qrUrl) {
    alert('Please enter both student name and QR code URL');
    return;
  }
  
  cleverQRData.push({ name, qrUrl });
  
  // Clear inputs
  nameInput.value = '';
  qrInput.value = '';
  
  // Re-render
  renderCleverQRContent();
}

function updateCleverQREntry(index) {
  const nameInput = document.querySelector(`.clever-qr-name[data-index="${index}"]`);
  const urlInput = document.querySelector(`.clever-qr-url[data-index="${index}"]`);
  
  if (nameInput && urlInput && cleverQRData[index]) {
    cleverQRData[index].name = nameInput.value.trim();
    cleverQRData[index].qrUrl = urlInput.value.trim();
  }
}

function deleteCleverQREntry(index) {
  if (confirm('Are you sure you want to delete this entry?')) {
    cleverQRData.splice(index, 1);
    renderCleverQRContent();
  }
}

async function saveCleverQRData() {
  const saveBtn = document.getElementById('saveCleverQRBtn');
  
  if (!saveBtn) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Show saving state
    saveBtn.textContent = 'â³ Saving...';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {
      clever_qr_json: JSON.stringify(cleverQRData)
    };
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = 'âœ… Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save Clever QR data:', error);
    saveBtn.textContent = 'âŒ Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

function updateCleverQRData(cleverQRJson) {
  if (!cleverQRJson) return;
  
  try {
    cleverQRData = JSON.parse(cleverQRJson);
  } catch (e) {
    console.error('Failed to parse Clever QR JSON:', e);
    cleverQRData = [];
  }
}

// ClassDojo QR Codes functions
function openClassDojoQRPanel() {
  const panel = document.getElementById('classDojoQRPanel');
  if (panel) {
    panel.style.display = 'flex';
    renderClassDojoQRContent();
  }
}

function closeClassDojoQRPanel() {
  const panel = document.getElementById('classDojoQRPanel');
  const searchInput = document.getElementById('classDojoQRSearchInput');
  if (panel) {
    panel.style.display = 'none';
  }
  // Clear search input when closing
  if (searchInput) {
    searchInput.value = '';
  }
}

function renderClassDojoQRContent() {
  const content = document.getElementById('classDojoQRContent');
  const editControls = document.getElementById('classDojoQREditControls');
  const searchBar = document.getElementById('classDojoQRSearchBar');
  const isEditMode = document.body.classList.contains('editing');
  
  if (!content) return;
  
  // Show/hide edit controls based on edit mode
  if (editControls) {
    editControls.style.display = isEditMode ? 'block' : 'none';
  }
  
  // Show/hide search bar based on edit mode
  if (searchBar) {
    searchBar.style.display = isEditMode ? 'none' : 'block';
  }
  
  if (classDojoQRData.length === 0) {
    content.innerHTML = '<p class="text-center text-gray-500 py-8">No QR codes added yet.</p>';
    return;
  }
  
  if (isEditMode) {
    // Edit mode: show all entries with inputs and delete button
    const html = classDojoQRData.map((item, index) => {
      return `
        <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
          <input type="text" value="${escapeHtml(item.name)}" 
                 class="flex-1 px-3 py-2 text-sm border rounded-lg classdojo-qr-name" 
                 data-index="${index}" 
                 onchange="updateClassDojoQREntry(${index})">
          <input type="url" value="${escapeHtml(item.qrUrl)}" 
                 class="flex-1 px-3 py-2 text-sm border rounded-lg classdojo-qr-url" 
                 data-index="${index}" 
                 placeholder="QR code URL"
                 onchange="updateClassDojoQREntry(${index})">
          <button onclick="deleteClassDojoQREntry(${index})" 
                  class="px-3 py-2 rounded-lg text-white text-sm font-semibold" 
                  style="background: var(--md-coral);">Delete</button>
        </div>
      `;
    }).join('');
    
    content.innerHTML = html;
  } else {
    // View mode: show prompt to search
    content.innerHTML = '<p class="text-center text-gray-500 py-8">Type a scholar\'s full first or last name and press Enter to view their QR code.</p>';
  }
}

function searchClassDojoQR() {
  const searchInput = document.getElementById('classDojoQRSearchInput');
  const content = document.getElementById('classDojoQRContent');
  
  if (!searchInput || !content) return;
  
  const searchTerm = searchInput.value.trim().toLowerCase();
  
  if (!searchTerm) {
    content.innerHTML = '<p class="text-center text-gray-500 py-8">Type a scholar\'s full first or last name and press Enter to view their QR code.</p>';
    return;
  }
  
  // Find exact matches (full first name or full last name)
  const matches = classDojoQRData.filter(item => {
    const fullName = item.name.toLowerCase();
    const nameParts = fullName.split(/\s+/); // Split by whitespace
    
    // Check if search term exactly matches any name part (first, middle, or last name)
    return nameParts.some(part => part === searchTerm);
  });
  
  if (matches.length === 0) {
    content.innerHTML = '<p class="text-center text-gray-500 py-8">No matching scholars found. Please try again with the full first or last name.</p>';
  } else {
    const html = matches.map(item => {
      return `
        <div class="p-3 bg-gray-50 rounded-lg">
          <a href="${escapeHtml(item.qrUrl)}" 
             target="_blank" 
             class="text-lg font-semibold hover:underline" 
             style="color: var(--md-slate);">
            ${escapeHtml(item.name)}
          </a>
        </div>
      `;
    }).join('');
    
    content.innerHTML = html;
  }
}

function addClassDojoQREntry() {
  const nameInput = document.getElementById('newClassDojoStudentName');
  const qrInput = document.getElementById('newClassDojoStudentQR');
  
  if (!nameInput || !qrInput) return;
  
  const name = nameInput.value.trim();
  const qrUrl = qrInput.value.trim();
  
  if (!name || !qrUrl) {
    alert('Please enter both student name and QR code URL');
    return;
  }
  
  classDojoQRData.push({ name, qrUrl });
  
  // Clear inputs
  nameInput.value = '';
  qrInput.value = '';
  
  // Re-render
  renderClassDojoQRContent();
}

function updateClassDojoQREntry(index) {
  const nameInput = document.querySelector(`.classdojo-qr-name[data-index="${index}"]`);
  const urlInput = document.querySelector(`.classdojo-qr-url[data-index="${index}"]`);
  
  if (nameInput && urlInput && classDojoQRData[index]) {
    classDojoQRData[index].name = nameInput.value.trim();
    classDojoQRData[index].qrUrl = urlInput.value.trim();
  }
}

function deleteClassDojoQREntry(index) {
  if (confirm('Are you sure you want to delete this entry?')) {
    classDojoQRData.splice(index, 1);
    renderClassDojoQRContent();
  }
}

async function saveClassDojoQRData() {
  const saveBtn = document.getElementById('saveClassDojoQRBtn');
  
  if (!saveBtn) return;
  
  const originalText = saveBtn.textContent;
  
  try {
    // Check authentication
    await ensureAuthenticated();
    
    // Show saving state
    saveBtn.textContent = 'â³ Saving...';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {
      classdojo_qr_json: JSON.stringify(classDojoQRData)
    };
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    // Show success state
    saveBtn.textContent = 'âœ… Saved!';
    
    // Reset button after 1 second
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 1000);
    
  } catch (error) {
    console.error('Failed to save ClassDojo QR data:', error);
    saveBtn.textContent = 'âŒ Save Failed';
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
  }
}

function updateClassDojoQRData(classDojoQRJson) {
  if (!classDojoQRJson) return;
  
  try {
    classDojoQRData = JSON.parse(classDojoQRJson);
  } catch (e) {
    console.error('Failed to parse ClassDojo QR JSON:', e);
    classDojoQRData = [];
  }
}

// Watch Me functionality
function renderWatchMeContent(tab) {
  const content = document.getElementById(`${tab}WatchMeContent`);
  const isEditMode = document.body.classList.contains('editing');
  
  if (!content) return;
  
  const links = watchMeData[tab] || [];
  
  if (links.length === 0) {
    content.innerHTML = '<p class="text-center text-gray-500 py-4 text-sm">No links added yet.</p>';
    return;
  }
  
  // Render the list
  const html = links.map((item, index) => {
    if (isEditMode) {
      // Edit mode: show inputs and delete button with drag handle
      return `
        <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg watch-me-item" 
             draggable="true" 
             data-tab="${tab}"
             data-index="${index}"
             style="cursor: move;">
          <span class="drag-handle text-gray-400 text-xl" style="cursor: grab; user-select: none;">â‹®â‹®</span>
          <input type="text" value="${escapeHtml(item.title)}" 
                 class="flex-1 px-3 py-2 text-sm border rounded-lg watch-me-title" 
                 data-tab="${tab}"
                 data-index="${index}" 
                 placeholder="Link title"
                 onchange="updateWatchMeEntry('${tab}', ${index})">
          <input type="url" value="${escapeHtml(item.url)}" 
                 class="flex-1 px-3 py-2 text-sm border rounded-lg watch-me-url" 
                 data-tab="${tab}"
                 data-index="${index}" 
                 placeholder="URL"
                 onchange="updateWatchMeEntry('${tab}', ${index})">
          <button onclick="deleteWatchMeEntry('${tab}', ${index})" 
                  class="px-3 py-2 rounded-lg text-white text-sm font-semibold" 
                  style="background: var(--md-coral);">Delete</button>
        </div>
      `;
    } else {
      // View mode: show clickable links (skip empty entries)
      if (!item.title || !item.url) return '';
      return `
        <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <a href="${escapeHtml(item.url)}" 
             target="_blank" 
             class="text-base font-medium hover:underline flex items-center gap-2" 
             style="color: var(--md-slate);">
            <span>ğŸ”—</span>
            <span>${escapeHtml(item.title)}</span>
          </a>
        </div>
      `;
    }
  }).join('');
  
  content.innerHTML = html;
  
  // Add drag and drop event listeners in edit mode
  if (isEditMode) {
    setupWatchMeDragAndDrop(tab);
  }
}

// Setup drag and drop for Watch Me items
function setupWatchMeDragAndDrop(tab) {
  const items = document.querySelectorAll(`.watch-me-item[data-tab="${tab}"]`);
  let draggedElement = null;
  let draggedIndex = null;
  
  items.forEach(item => {
    // Dragstart event
    item.addEventListener('dragstart', function(e) {
      draggedElement = this;
      draggedIndex = parseInt(this.getAttribute('data-index'));
      this.style.opacity = '0.4';
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    });
    
    // Dragend event
    item.addEventListener('dragend', function(e) {
      this.style.opacity = '1';
      // Remove all drag-over styling
      items.forEach(item => {
        item.style.borderTop = '';
        item.style.borderBottom = '';
      });
    });
    
    // Dragover event
    item.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      if (this === draggedElement) return;
      
      // Visual feedback: show where item will be dropped
      const rect = this.getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      
      // Remove previous styling
      items.forEach(item => {
        item.style.borderTop = '';
        item.style.borderBottom = '';
      });
      
      if (e.clientY < midpoint) {
        this.style.borderTop = '3px solid var(--md-coral)';
      } else {
        this.style.borderBottom = '3px solid var(--md-coral)';
      }
    });
    
    // Drop event
    item.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      if (this === draggedElement) return;
      
      const dropIndex = parseInt(this.getAttribute('data-index'));
      const rect = this.getBoundingClientRect();
      const midpoint = rect.top + rect.height / 2;
      
      // Determine if we're dropping above or below
      let targetIndex = dropIndex;
      if (e.clientY >= midpoint) {
        targetIndex = dropIndex + 1;
      }
      
      // Adjust target index if dragging down
      if (draggedIndex < targetIndex) {
        targetIndex--;
      }
      
      // Reorder the array
      const movedItem = watchMeData[tab].splice(draggedIndex, 1)[0];
      watchMeData[tab].splice(targetIndex, 0, movedItem);
      
      // Re-render
      renderWatchMeContent(tab);
    });
  });
}

function addWatchMeLink(tab) {
  // Add empty entry directly to the list for inline editing
  watchMeData[tab].push({ title: '', url: '' });
  
  // Re-render
  renderWatchMeContent(tab);
  
  // Focus on the title input of the newly added item
  setTimeout(() => {
    const newIndex = watchMeData[tab].length - 1;
    const titleInput = document.querySelector(`.watch-me-title[data-tab="${tab}"][data-index="${newIndex}"]`);
    if (titleInput) {
      titleInput.focus();
    }
  }, 50);
}

function updateWatchMeEntry(tab, index) {
  const titleInput = document.querySelector(`.watch-me-title[data-tab="${tab}"][data-index="${index}"]`);
  const urlInput = document.querySelector(`.watch-me-url[data-tab="${tab}"][data-index="${index}"]`);
  
  if (titleInput && urlInput && watchMeData[tab][index]) {
    watchMeData[tab][index].title = titleInput.value.trim();
    watchMeData[tab][index].url = urlInput.value.trim();
  }
}

function deleteWatchMeEntry(tab, index) {
  if (confirm('Are you sure you want to delete this link?')) {
    watchMeData[tab].splice(index, 1);
    renderWatchMeContent(tab);
  }
}

async function saveWatchMeLinks(tab) {
  const saveBtn = document.getElementById(`save${tab.charAt(0).toUpperCase() + tab.slice(1)}WatchMeBtn`);
  const originalText = saveBtn.textContent;
  
  try {
    // Check authentication before saving
    await ensureAuthenticated();
    
    // Show saving state
    saveBtn.textContent = 'â³ Saving...';
    saveBtn.disabled = true;
    
    // Prepare data for saving
    const data = {
      watch_me_json: JSON.stringify(watchMeData)
    };
    
    console.log(`Saving ${tab} Watch Me links to Firestore:`, watchMeData[tab]);
    
    // Save to Firestore
    await db.collection('classData').doc('current').set(data, { merge: true });
    
    console.log(`${tab} Watch Me links saved successfully to Firestore`);
    
    // Show success state
    saveBtn.textContent = 'âœ… Saved!';
    
    // Reset button after 2 seconds
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 2000);
    
  } catch (error) {
    console.error(`Failed to save ${tab} Watch Me links:`, error);
    alert(`Failed to save links: ${error.message}`);
    
    // Show error state
    saveBtn.textContent = 'âŒ Save Failed';
    
    // Reset button after 3 seconds
    setTimeout(() => {
      saveBtn.textContent = originalText;
      saveBtn.disabled = false;
    }, 3000);
  }
}


function updateWatchMeData(watchMeJson) {
  if (!watchMeJson) {
    // Initialize with empty arrays if no data
    watchMeData = {
      skills: [],
      listening: [],
      math: []
    };
  } else {
    try {
      const parsed = JSON.parse(watchMeJson);
      // Ensure all three tabs have data
      watchMeData = {
        skills: parsed.skills || [],
        listening: parsed.listening || [],
        math: parsed.math || []
      };
    } catch (e) {
      console.error('Failed to parse Watch Me JSON:', e);
      watchMeData = {
        skills: [],
        listening: [],
        math: []
      };
    }
  }
  
  // Render all three tabs
  renderWatchMeContent('skills');
  renderWatchMeContent('listening');
  renderWatchMeContent('math');
}


// Error display functions
function showDataLoadError(message) {
  // Only show error banner to users in edit mode (teachers/admins)
  // Regular visitors (parents/students) should not see Firebase connection issues
  if (!document.body.classList.contains('editing')) {
    console.log(`Data load notice (hidden from visitors): ${message}`);
    return;
  }
  
  // Create or update error banner for teachers/admins only
  let errorBanner = document.getElementById('dataLoadError');
  if (!errorBanner) {
    errorBanner = document.createElement('div');
    errorBanner.id = 'dataLoadError';
    errorBanner.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #f56565;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 1000;
      font-weight: bold;
    `;
    document.body.insertBefore(errorBanner, document.body.firstChild);
  }
  errorBanner.textContent = `âš ï¸ ${message}`;
  errorBanner.style.display = 'block';
}

function hideDataLoadError() {
  const errorBanner = document.getElementById('dataLoadError');
  if (errorBanner) {
    errorBanner.style.display = 'none';
  }
}

// Default fallback data when Firestore is unavailable
function getDefaultFallbackData() {
  return {
    week: "Week of September 1â€“5",
    recap: "This week we explored magical stories and practiced our sight words. The students loved reading about brave characters and sharing their favorite parts! We also worked on counting by 5s and 10s using fun games and manipulatives. Our art projects focused on fall colors and textures - the students created beautiful leaf collages and practiced writing descriptive words.",
    dates_json: JSON.stringify([
      { icon: "ğŸƒ", text: "Halloween Party - October 31st at 2pm" },
      { icon: "ğŸ¦ƒ", text: "Thanksgiving Break - November 23-27" }
    ]),
    looking_ahead: [
      "Field trip permission slips due",
      "Parent-teacher conferences", 
      "Winter concert practice begins"
    ],
    snacks_json: JSON.stringify([
      { emoji: "ğŸ¥¯", item: "Breakfast Bars", claimed_by: "", checked: false, is_default: true },
      { emoji: "ğŸ¬", item: "Gummies", claimed_by: "", checked: false, is_default: true },
      { emoji: "ğŸš", item: "Rice Krispy Treats", claimed_by: "", checked: false, is_default: true },
      { emoji: "ğŸ§ƒ", item: "Juice", claimed_by: "", checked: false, is_default: true }
    ]),
    snack_message: "Snacks help keep our energy up during learning time and teach us about sharing and community!",
    scholar_name: "Scholar of the Month",
    scholar_blurb: "Our scholar will be announced soon!",
    scholar_skill: "Kindness and helping others",
    skills_text: "This week we focused on phonics and reading skills.",
    sounds_json: JSON.stringify(["ch", "sh", "th", "wh"]),
    listening_text: "We practiced active listening and following directions.",
    ask_json: JSON.stringify(["What is the main idea?", "How do you know?", "What evidence supports this?"]),
    math_text: "We explored numbers and counting patterns.",
    math_vocab_json: JSON.stringify(["add", "subtract", "count", "pattern"]),
    extras_json: JSON.stringify([]),
    about_me_html: "Welcome to our classroom!",
    fun_facts_html: ["I love teaching first grade!", "Reading is my favorite subject", "I enjoy outdoor activities"],
    photo_urls_json: JSON.stringify([]),
    gallery_urls_json: JSON.stringify({}),
    calendar_url: "#"
  };
}

async function fetchFirestoreData() {
  try {
    // Check if Firebase is available
    if (typeof db === 'undefined') {
      console.error('Firebase not available - checking localStorage fallback');
      // Check if we have saved snack data in localStorage
      const savedSnacksData = localStorage.getItem('classData_snacks_json');
      if (savedSnacksData) {
        const fallbackData = getDefaultFallbackData();
        fallbackData.snacks_json = savedSnacksData;
        console.log('Using localStorage fallback data for snacks');
        showDataLoadError('Firebase connection not available - using saved local data');
        return fallbackData;
      } else {
        showDataLoadError('Firebase connection not available');
        return null;
      }
    }
    
    const doc = await db.collection('classData').doc('current').get();
    if (doc.exists) {
      hideDataLoadError(); // Hide any previous error messages
      return doc.data();
    } else {
      console.log('No document found, using defaults');
      showDataLoadError('No saved data found - showing default content');
      return null;
    }
  } catch (e) {
    console.error('Failed to fetch Firestore data:', e);
    showDataLoadError('Unable to load data from server - showing default content');
    return null;
  }
}
document.addEventListener('DOMContentLoaded', function() {
  // Debug mode - add to URL: ?debug=true
  const urlParams = new URLSearchParams(window.location.search);
  const isDebugMode = urlParams.get('debug') === 'true';
  
  if (isDebugMode) {
    // Create debug console in page
    const debugConsole = document.createElement('div');
    debugConsole.id = 'debugConsole';
    debugConsole.style.cssText = `
      position: fixed; 
      bottom: 10px; 
      right: 10px; 
      width: 400px; 
      max-height: 300px; 
      background: black; 
      color: lime; 
      font-family: monospace; 
      font-size: 12px; 
      padding: 10px; 
      border: 1px solid #333; 
      overflow-y: auto; 
      z-index: 10000;
      display: none;
    `;
    debugConsole.innerHTML = '<div style="color: yellow; font-weight: bold;">ğŸ”§ DEBUG CONSOLE</div>';
    document.body.appendChild(debugConsole);
    
    // Override console.log for debug mode
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    function addToDebugConsole(level, ...args) {
      const msg = args.join(' ');
      const color = level === 'error' ? 'red' : level === 'warn' ? 'orange' : 'lime';
      debugConsole.innerHTML += `<div style="color: ${color};">[${level.toUpperCase()}] ${msg}</div>`;
      debugConsole.scrollTop = debugConsole.scrollHeight;
    }
    
    console.log = function(...args) {
      originalLog.apply(console, args);
      addToDebugConsole('log', ...args);
    };
    
    console.error = function(...args) {
      originalError.apply(console, args);
      addToDebugConsole('error', ...args);
    };
    
    console.warn = function(...args) {
      originalWarn.apply(console, args);
      addToDebugConsole('warn', ...args);
    };
    
    // Add toggle button
    const toggleBtn = document.createElement('button');
    toggleBtn.textContent = 'ğŸ”§ Debug';
    toggleBtn.style.cssText = `
      position: fixed; 
      bottom: 10px; 
      left: 10px; 
      z-index: 10001; 
      background: #333; 
      color: white; 
      border: none; 
      padding: 5px 10px; 
      cursor: pointer;
    `;
    toggleBtn.onclick = () => {
      debugConsole.style.display = debugConsole.style.display === 'none' ? 'block' : 'none';
    };
    document.body.appendChild(toggleBtn);
    
    console.log('Debug mode enabled');
  }
  
  // Test Firebase Storage connection on page load
  setTimeout(async () => {
    if (typeof storage !== 'undefined') {
      const connectionTest = await window.testStorageConnection();
      if (connectionTest) {
        console.log('âœ… Firebase Storage connection verified');
      } else {
        console.error('âŒ Firebase Storage connection failed');
      }
    } else {
      console.error('âŒ Firebase Storage not initialized');
    }
  }, 500);
  
  setTimeout(async () => {
    try {
      const data = await fetchFirestoreData();
      
      // Validate all image URLs if in debug mode or if data exists
      if (data && (isDebugMode || data.photo_urls_json || data.gallery_urls_json)) {
        console.log('Validating stored image URLs...');
        const urlValidation = await window.validateAllImageUrls(data);
        
        if (urlValidation.invalid.length > 0) {
          console.warn(`Found ${urlValidation.invalid.length} invalid image URLs that need to be fixed`);
          
          // Show warning in UI if there are broken images
          const warningDiv = document.createElement('div');
          warningDiv.className = 'fixed top-4 left-4 bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded shadow-lg z-50';
          warningDiv.innerHTML = `
            <div class="flex">
              <div class="flex-shrink-0">
                <span class="text-yellow-500">âš ï¸</span>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium">Image Issues Detected</p>
                <p class="text-sm">${urlValidation.invalid.length} stored image(s) could not be loaded. They may have been deleted from storage.</p>
              </div>
              <div class="ml-auto pl-3">
                <button class="text-yellow-400 hover:text-yellow-600" onclick="this.parentElement.parentElement.parentElement.remove()">
                  <span class="sr-only">Dismiss</span>
                  âœ•
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(warningDiv);
          
          // Auto-remove warning after 10 seconds
          setTimeout(() => {
            if (warningDiv.parentNode) {
              warningDiv.parentNode.removeChild(warningDiv);
            }
          }, 10000);
        }
      }
      
      populateDataFromSheet(data);
    } catch (error) {
      console.error('Error during initial data load:', error);
      showDataLoadError('Failed to load content - showing default content');
      populateDataFromSheet(null); // This will trigger fallback data
    }
  }, 350);
  
  // Set up modal event listeners
  const contactBtn = document.getElementById('contactMeBtn');
  if (contactBtn) {
    contactBtn.addEventListener('click', openContactModal);
  }
  
  const learningHubBtn = document.getElementById('learningHubBtn');
  if (learningHubBtn) {
    learningHubBtn.addEventListener('click', openLearningHubModal);
  }
  
  const familyHubBtn = document.getElementById('familyHubBtn');
  if (familyHubBtn) {
    familyHubBtn.addEventListener('click', openFamilyHubModal);
  }
  
  const aboutMeDavisBtn = document.getElementById('aboutMeDavisBtn');
  if (aboutMeDavisBtn) {
    aboutMeDavisBtn.addEventListener('click', openAboutMeDavisModal);
  }
  
  // Mobile accordion functionality for navigation tabs
  function initMobileAccordion() {
    const isMobile = window.innerWidth <= 768;
    
    if (!isMobile) return; // Only run on mobile
    
    // Get all accordion headers
    const accordionHeaders = document.querySelectorAll('.mobile-tab-header');
    
    accordionHeaders.forEach(header => {
      header.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const content = this.nextElementSibling;
        const arrow = this.querySelector('.mobile-tab-arrow');
        
        // Toggle this accordion
        if (content && content.classList.contains('mobile-tab-content')) {
          content.classList.toggle('active');
          if (arrow) {
            arrow.classList.toggle('rotated');
          }
        }
      });
    });
    
    // Sync recap text to mobile accordion
    function syncRecapText() {
      const desktopRecap = document.getElementById('recapText');
      const mobileRecap = document.getElementById('mobileRecapText');
      if (desktopRecap && mobileRecap) {
        mobileRecap.textContent = desktopRecap.textContent;
      }
    }
    
    // Sync dates to mobile accordion
    function syncDates() {
      const desktopEventsList = document.getElementById('eventsList');
      const mobileDatesList = document.getElementById('mobileDatesList');
      
      if (desktopEventsList && mobileDatesList) {
        const events = desktopEventsList.querySelectorAll('.event-item');
        mobileDatesList.innerHTML = '';
        
        events.forEach(event => {
          const emoji = event.querySelector('.event-emoji')?.textContent || '';
          const text = event.querySelector('.event-text')?.textContent || '';
          
          const dateItem = document.createElement('div');
          dateItem.className = 'flex items-center gap-2 mb-2 text-sm';
          dateItem.innerHTML = `<span class="text-lg">${emoji}</span><span>${text}</span>`;
          mobileDatesList.appendChild(dateItem);
        });
      }
    }
    
    // Initial sync
    syncRecapText();
    syncDates();
    
    // Observe changes to sync automatically
    const recapText = document.getElementById('recapText');
    if (recapText) {
      const observer = new MutationObserver(syncRecapText);
      observer.observe(recapText, { childList: true, characterData: true, subtree: true });
    }
    
    const eventsList = document.getElementById('eventsList');
    if (eventsList) {
      const observer = new MutationObserver(syncDates);
      observer.observe(eventsList, { childList: true, subtree: true });
    }
  }
  
  // Initialize mobile accordion on load and resize
  initMobileAccordion();
  window.addEventListener('resize', initMobileAccordion);
  
  const shoutoutBtn = document.getElementById('shoutoutBtn');
  if (shoutoutBtn) {
    shoutoutBtn.addEventListener('click', function(e) {
      e.preventDefault();
      showPage('shoutouts');
    });
  }
  
  // NEW SHOUTOUT PAGE LISTENERS
  
  // Shuffle button on TV page
  const shuffleTVBtn = document.getElementById('shuffleTVBtn');
  if (shuffleTVBtn) {
    shuffleTVBtn.addEventListener('click', shuffleShoutoutTV);
  }
  
  // Create shoutout button
  const createShoutBtn = document.getElementById('createShoutoutBtn');
  if (createShoutBtn) {
    createShoutBtn.addEventListener('click', openCreateShoutoutModal);
  }
  
  // Admin shoutouts button
  const createdShoutsBtn = document.getElementById('createdShoutsBtn');
  if (createdShoutsBtn) {
    createdShoutsBtn.addEventListener('click', openAdminShoutsModal);
  }
  
  // Load shoutouts data on page load
  loadShoutoutsFromFirebase();
  
  // Load main TV message on page load
  loadMainMessage().then(() => {
    updateTVDisplay();
  });
  
  // OLD SHOUTOUT MODAL LISTENERS (kept for compatibility)
  const shuffleBtn = document.getElementById('shuffleShoutoutBtn');
  if (shuffleBtn) {
    shuffleBtn.addEventListener('click', function() {
      currentShoutoutPinTarget = 'shuffle';
      openShoutoutPinModal();
    });
  }
  
  const editBtn = document.getElementById('editShoutoutBtn');
  if (editBtn) {
    editBtn.addEventListener('click', function() {
      currentShoutoutPinTarget = 'edit';
      openShoutoutPinModal();
    });
  }
  
  // Shoutout PIN modal listeners
  const pinCancel = document.getElementById('shoutoutPinCancel');
  if (pinCancel) {
    pinCancel.addEventListener('click', closeShoutoutPinModal);
  }
  
  const pinSubmit = document.getElementById('shoutoutPinSubmit');
  if (pinSubmit) {
    pinSubmit.addEventListener('click', function() {
      const pin = document.getElementById('shoutoutPinInput').value;
      if (pin === '2213') {
        closeShoutoutPinModal();
        if (currentShoutoutPinTarget === 'shuffle') {
          shuffleShoutout();
        } else if (currentShoutoutPinTarget === 'edit') {
          editShoutout();
        }
        currentShoutoutPinTarget = null;
      } else {
        // Invalid PIN - show error
        const input = document.getElementById('shoutoutPinInput');
        input.style.borderColor = '#ef4444';
        setTimeout(() => {
          input.style.borderColor = '';
        }, 900);
      }
    });
  }
  
  // Add Enter key support for PIN input
  const pinInput = document.getElementById('shoutoutPinInput');
  if (pinInput) {
    pinInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        pinSubmit.click();
      }
    });
  }
});

// Flags to prevent periodic refresh during save/upload operations
let isSaving = false;
let isUploading = false;

setInterval(async () => {
  // Skip refresh if we're in the middle of a save or upload operation
  if (isSaving || isUploading) {
    console.log('Skipping periodic refresh - save/upload operation in progress');
    return;
  }
  
  try {
    const data = await fetchFirestoreData();
    populateDataFromSheet(data);
  } catch (error) {
    console.error('Error during periodic data refresh:', error);
    // Don't show error for periodic refreshes, just log it
  }
}, 300000);

// New JavaScript functions for enhanced functionality

// Profile photo upload functionality
function editProfilePhoto(el, section) {
  // Only allow editing in edit mode with PIN
  if (!document.body.classList.contains('editing')) {
    return;
  }
  
  // Create file input
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.style.display = 'none';
  
  fileInput.onchange = async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('File size too large. Please select an image smaller than 10MB.');
      return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('Please select a valid image file.');
      return;
    }
    
    let attempt = 0;
    const maxAttempts = 3;
    
    while (attempt < maxAttempts) {
      try {
        console.log(`Profile photo upload attempt ${attempt + 1} for section: ${section}`);
        
        // Set uploading flag to prevent periodic refresh interference
        isUploading = true;
        
        // Show uploading state
        el.innerHTML = '<div style="font-size: 12px; text-align: center;">â³<br>Uploading...</div>';
        el.style.pointerEvents = 'none';
        
        // Test storage connection first
        const storageConnected = await window.testStorageConnection();
        if (!storageConnected) {
          throw new Error('Firebase Storage connection failed');
        }
        
        // Generate unique filename
        const timestamp = Date.now();
        const fileName = `profile_${section}_${timestamp}_${file.name}`;
        
        console.log(`Uploading to: profiles/${fileName}`);
        
        // Upload to Firebase Storage
        const storageRef = storage.ref(`profiles/${fileName}`);
        const uploadTask = await storageRef.put(file);
        const downloadURL = await uploadTask.ref.getDownloadURL();
        
        console.log('Profile photo upload successful, URL:', downloadURL);
        
        // Validate the generated URL
        const urlValid = await window.validateStorageUrl(downloadURL);
        if (!urlValid) {
          console.warn('Generated URL failed validation, but proceeding anyway');
        }
        
        // Update the display
        el.innerHTML = `<img src="${downloadURL}" alt="Profile" style="width:100%; height:100%; object-fit:cover;">`;
        el.style.pointerEvents = 'auto';
        
        // Store the photo URL for later collection
        el.setAttribute('data-profile-url', downloadURL);
        
        // Show save button since we have changes
        const saveBtn = document.getElementById('saveChangesBtn');
        if (saveBtn) saveBtn.style.display = 'block';
        
        // Clear uploading flag
        isUploading = false;
        
        // Auto-save after successful upload to ensure persistence
        setTimeout(() => {
          if (saveBtn && saveBtn.style.display === 'block' && !isSaving) {
            console.log('Auto-saving after profile photo upload');
            saveChangesToFirestore();
          }
        }, 500);
        
        // Success - break out of retry loop
        break;
        
      } catch (error) {
        attempt++;
        console.error(`Profile photo upload attempt ${attempt} failed:`, error);
        
        if (attempt >= maxAttempts) {
          // Clear uploading flag on final failure
          isUploading = false;
          
          const errorMessage = window.handleUploadError(error, 'profile photo upload');
          
          // Show user-friendly error in UI
          const errorDiv = document.createElement('div');
          errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
          errorDiv.innerHTML = `
            <div class="flex">
              <div class="flex-shrink-0">
                <span class="text-red-500">âš ï¸</span>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium">Upload Failed</p>
                <p class="text-sm">${errorMessage}</p>
              </div>
              <div class="ml-auto pl-3">
                <button class="text-red-400 hover:text-red-600" onclick="this.parentElement.parentElement.parentElement.remove()">
                  <span class="sr-only">Dismiss</span>
                  âœ•
                </button>
              </div>
            </div>
          `;
          document.body.appendChild(errorDiv);
          
          // Auto-remove error after 5 seconds
          setTimeout(() => {
            if (errorDiv.parentNode) {
              errorDiv.parentNode.removeChild(errorDiv);
            }
          }, 5000);
          
          // Reset on error
          el.innerHTML = '';
          el.style.pointerEvents = 'auto';
        } else {
          // Wait before retry
          await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
        }
      }
    }
    
    document.body.removeChild(fileInput);
  };
  
  document.body.appendChild(fileInput);
  fileInput.click();
}

// Confetti animation for celebrate button
function triggerConfetti() {
  // Create confetti container
  const confettiContainer = document.createElement('div');
  confettiContainer.style.position = 'fixed';
  confettiContainer.style.top = '0';
  confettiContainer.style.left = '0';
  confettiContainer.style.width = '100%';
  confettiContainer.style.height = '100%';
  confettiContainer.style.pointerEvents = 'none';
  confettiContainer.style.zIndex = '9999';
  
  // Create multiple confetti pieces with more variety and flow
  const colors = ['#E0B14A', '#E9867D', '#F2C9BE', '#7B8E9E', '#F7EFE2'];
  const emojis = ['ğŸ‰', 'ğŸŒŸ', 'âœ¨', 'ğŸŠ', 'ğŸˆ', 'ğŸ†', 'â­', 'ğŸ’«', 'ğŸ¯'];
  
  // Create more confetti pieces for a fuller effect
  for (let i = 0; i < 80; i++) {
    const confetti = document.createElement('div');
    confetti.style.position = 'absolute';
    confetti.style.fontSize = Math.random() * 10 + 15 + 'px'; // Vary sizes
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.top = '-50px'; // Start above the screen
    
    // Add random horizontal drift for more flowy movement
    const drift = (Math.random() - 0.5) * 200; // -100px to +100px drift
    const fallDuration = Math.random() * 2 + 3; // 3-5 seconds fall time
    const rotationSpeed = Math.random() * 720 + 360; // 360-1080 degrees
    
    confetti.style.animationDuration = fallDuration + 's';
    confetti.style.animationDelay = Math.random() * 1.5 + 's'; // Stagger the start
    confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    
    // Enhanced falling animation with drift and rotation
    confetti.style.animation = `confettiFlowFall ${fallDuration}s ease-in forwards`;
    confetti.style.setProperty('--drift', drift + 'px');
    confetti.style.setProperty('--rotation', rotationSpeed + 'deg');
    
    confettiContainer.appendChild(confetti);
  }
  
  document.body.appendChild(confettiContainer);
  
  // Remove confetti after animation
  setTimeout(() => {
    if (document.body.contains(confettiContainer)) {
      document.body.removeChild(confettiContainer);
    }
  }, 7000);
}

// Website URL update functionality  
function updateWebsiteUrl(input) {
  const websiteCard = input.closest('.website-card');
  const link = websiteCard.querySelector('.website-link');
  if (link && input.value) {
    link.href = input.value;
    
    // Show save button since we have changes
    const saveBtn = document.getElementById('saveChangesBtn');
    if (saveBtn) saveBtn.style.display = 'block';
  }
}

// Add CSS for confetti animation
const style = document.createElement('style');
style.textContent = `
  @keyframes confettiFlowFall {
    0% {
      transform: translateY(-100vh) translateX(0) rotate(0deg);
      opacity: 1;
    }
    25% {
      opacity: 1;
    }
    75% {
      opacity: 0.8;
    }
    100% {
      transform: translateY(100vh) translateX(var(--drift)) rotate(var(--rotation));
      opacity: 0;
    }
  }
  
  @keyframes confettiFall {
    0% {
      transform: translateY(-100vh) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translateY(100vh) rotate(720deg);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);
  </script>
  
  <!-- Transportation Modal -->
  <div id="transportationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; justify-content: center; align-items: center;" onclick="closeTransportationModal()">
    <div class="bg-[color:var(--card-bg)] rounded-2xl shadow-soft p-8 max-w-lg mx-4" onclick="event.stopPropagation();" style="border: 3px solid var(--modal-border-color);">
      <div class="text-center mb-6">
        <div id="transportationModalIcon" class="text-6xl mb-4">ğŸšŒ</div>
        <h3 id="transportationModalTitle" class="text-2xl font-display font-bold mb-2" style="color: var(--modal-title-color);">Bus Riders</h3>
        <p class="text-sm text-gray-600">Manage transportation details</p>
      </div>
      
      <div class="space-y-4">
        <textarea id="transportationModalTextarea" class="w-full h-40 p-4 text-sm border rounded-lg resize-none" placeholder="Student name and transportation details"></textarea>
      </div>
      
      <div class="flex gap-3 justify-center mt-6">
        <button onclick="closeTransportationModal()" class="px-6 py-3 rounded-xl border font-semibold">Cancel</button>
        <button id="transportationModalSaveBtn" onclick="saveTransportationFromModal()" class="px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-coral);">
          ğŸ’¾ Save
        </button>
      </div>
    </div>
  </div>

  <!-- Contact Me Modal -->
  <div id="contactModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; justify-content: center; align-items: center;" onclick="closeContactModal()">
    <div class="bg-[color:var(--card-bg)] rounded-2xl shadow-soft p-8 max-w-md mx-4" onclick="event.stopPropagation();" style="border: 2px solid var(--md-coral);">
      <div class="text-center">
        <div class="text-4xl mb-4">ğŸ‘¨â€ğŸ«</div>
        <h3 class="text-2xl font-display font-bold mb-6" style="color: var(--md-coral);">Contact Mr. Davis</h3>
        <div class="space-y-4">
          <div class="bg-white rounded-xl p-4" style="border: 1px solid var(--md-coral);">
            <div class="text-sm font-semibold text-gray-600 mb-2">ğŸ“§ Email</div>
            <a href="mailto:dgonzalezjr@crossroadsschoolskc.org" class="text-[color:var(--md-coral)] font-semibold hover:underline">
              dgonzalezjr@crossroadsschoolskc.org
            </a>
          </div>
          <div class="bg-white rounded-xl p-4" style="border: 1px solid var(--md-coral);">
            <div class="text-sm font-semibold text-gray-600 mb-2">ğŸ“ Phone</div>
            <a href="tel:8164821708" class="text-[color:var(--md-coral)] font-semibold hover:underline">
              816-482-1708
            </a>
          </div>
        </div>
        <button onclick="closeContactModal()" class="mt-6 px-6 py-2 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-coral);">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Learning Hub Popup Modal -->
  <div id="learningHubModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; justify-content: center; align-items: center;" onclick="closeLearningHubModal()">
    <div class="bg-[color:var(--card-bg)] rounded-2xl shadow-soft p-8 max-w-md mx-4" onclick="event.stopPropagation();" style="border: 3px solid var(--md-slate);">
      <div class="text-center">
        <div class="text-5xl mb-4">ğŸ“š</div>
        <h3 class="text-2xl font-display font-bold mb-6" style="color: var(--md-slate);">Learning Hub</h3>
        <div class="space-y-3">
          <button class="pageTab w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90"
                  data-page="skills" style="background: var(--md-slate);" onclick="closeLearningHubModal(); showPage('skills');">
            <span>ğŸ“–</span><span>Skills</span>
          </button>
          <button class="pageTab w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90"
                  data-page="listening" style="background: var(--md-coral);" onclick="closeLearningHubModal(); showPage('listening');">
            <span>ğŸ‘‚</span><span>Listening & Learning</span>
          </button>
          <button class="pageTab w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold text-[color:var(--md-ink)] hover:opacity-90"
                  data-page="math" style="background: var(--md-blush);" onclick="closeLearningHubModal(); showPage('math');">
            <span>ğŸ§®</span><span>Math</span>
          </button>
          <button class="pageTab w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-semibold text-white hover:opacity-90"
                  data-page="practice" style="background: var(--md-pebble); color: var(--md-ink);" onclick="closeLearningHubModal(); showPage('practice');">
            <span>ğŸ’»</span><span>Practice Websites</span>
          </button>
        </div>
        <button onclick="closeLearningHubModal()" class="mt-6 px-6 py-2 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-slate);">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Family Hub Popup Modal -->
  <div id="familyHubModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; justify-content: center; align-items: center;" onclick="closeFamilyHubModal()">
    <div class="bg-[color:var(--card-bg)] rounded-2xl shadow-soft p-8 max-w-md mx-4" onclick="event.stopPropagation();" style="border: 3px solid var(--md-coral);">
      <div class="text-center">
        <div class="text-5xl mb-4">ğŸ«</div>
        <h3 class="text-2xl font-display font-bold mb-6" style="color: var(--md-coral);">Family Hub</h3>
        <div class="space-y-3">
          <a href="https://classdojo.com" target="_blank"
             class="w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90"
             style="background:#6b7280;">
            <span>ğŸ¯</span><span>ClassDojo</span>
          </a>
          <button class="pageTab w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90"
                  data-page="transportation" style="background: var(--md-slate);" onclick="closeFamilyHubModal(); showPage('transportation');">
            <span>ğŸšŒ</span><span>Transportation</span>
          </button>
          <button class="pageTab w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90"
                  data-page="birthdays" style="background: var(--md-coral);" onclick="closeFamilyHubModal(); showPage('birthdays');">
            <span>ğŸ‚</span><span>Birthdays</span>
          </button>
          <button class="pageTab w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90"
                  data-page="snacks" style="background: var(--md-mustard);" onclick="closeFamilyHubModal(); showPage('snacks');">
            <span>ğŸ¥¨</span><span>Snack Helpers</span>
          </button>
        </div>
        <button onclick="closeFamilyHubModal()" class="mt-6 px-6 py-2 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-coral);">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- About Mr. Davis Popup Modal -->
  <div id="aboutMeDavisModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; justify-content: center; align-items: center;" onclick="closeAboutMeDavisModal()">
    <div class="bg-[color:var(--card-bg)] rounded-2xl shadow-soft p-8 max-w-md mx-4" onclick="event.stopPropagation();" style="border: 3px solid var(--md-coral);">
      <div class="text-center">
        <div class="text-5xl mb-4">ğŸ‘¨â€ğŸ«</div>
        <h3 class="text-2xl font-display font-bold mb-6" style="color: var(--md-coral);">About Mr. Davis</h3>
        <div class="space-y-3">
          <button onclick="closeAboutMeDavisModal(); showPage('aboutme');" class="w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-coral);">
            <span>ğŸ‘¨â€ğŸ«</span><span>About Mr. Davis</span>
          </button>
          <button onclick="closeAboutMeDavisModal(); openContactModal();" class="w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-coral);">
            <span>ğŸ“§</span><span>Contact Me</span>
          </button>
        </div>
        <button onclick="closeAboutMeDavisModal()" class="mt-6 px-6 py-2 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-coral);">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Shoutout Modal -->
  <div id="shoutoutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9997; justify-content: center; align-items: center;" onclick="closeShoutoutModal()">
    <div class="bg-[color:var(--card-bg)] rounded-2xl shadow-soft p-8 max-w-2xl mx-4" onclick="event.stopPropagation();" style="border: 3px solid var(--md-coral);">
      <div class="text-center">
        <div class="text-6xl mb-4">ğŸ“º</div>
        <h3 class="text-3xl font-display font-bold mb-6" style="color: var(--md-coral); font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif;">Shoutout TV!</h3>
        <div class="bg-black rounded-xl p-6 mb-6" style="min-height: 200px; display: flex; align-items: center; justify-content: center;">
          <div id="shoutoutDisplay" class="text-white text-center" style="font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif; font-size: 1.5rem; line-height: 1.4;">
            We're cheering for you and all your hard work.
          </div>
        </div>
        <div class="flex gap-3 justify-center">
          <button id="shuffleShoutoutBtn" class="px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-mustard);">
            ğŸ² Shuffle
          </button>
          <button id="editShoutoutBtn" class="px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-slate);">
            âœï¸ Edit
          </button>
          <button onclick="closeShoutoutModal()" class="px-4 py-2 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-coral);">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Shoutout PIN Modal -->
  <div id="shoutoutPinModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;">
    <div class="bg-white rounded-2xl p-8 max-w-md mx-4">
      <h3 class="text-xl font-bold text-center mb-4">Enter PIN</h3>
      <p class="text-center text-gray-600 mb-6">Enter PIN to access this feature</p>
      <div class="space-y-4">
        <input id="shoutoutPinInput" type="password" placeholder="Enter PIN" class="w-full px-4 py-3 rounded-xl border text-center text-lg">
        <div class="flex gap-3">
          <button id="shoutoutPinCancel" class="flex-1 px-4 py-3 rounded-xl border font-semibold">Cancel</button>
          <button id="shoutoutPinSubmit" class="flex-1 px-4 py-3 rounded-xl font-semibold text-white" style="background: var(--md-slate);">Enter</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Shoutout Modal -->
  <div id="createShoutoutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; justify-content: center; align-items: center;" onclick="closeCreateShoutoutModal()">
    <div class="bg-[color:var(--card-bg)] rounded-2xl shadow-soft p-8 max-w-lg mx-4" onclick="event.stopPropagation();" style="border: 3px solid var(--md-coral);">
      <div class="text-center">
        <div class="text-6xl mb-4">âœ¨</div>
        <h3 class="text-3xl font-display font-bold mb-6" style="color: var(--md-coral); font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif;">Create a Shoutout!</h3>
        
        <form id="shoutoutForm" class="space-y-4 text-left">
          <div>
            <label class="block text-sm font-semibold mb-2" style="color: var(--md-slate);">Scholar's Name</label>
            <input id="scholarNameInput" type="text" placeholder="e.g. Giovanni" class="w-full px-4 py-3 rounded-xl border text-center" style="font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif;">
          </div>
          
          <div>
            <label class="block text-sm font-semibold mb-2" style="color: var(--md-slate);">From</label>
            <input id="fromInput" type="text" placeholder="e.g. Mommy, Grandpa, Auntie Rose" class="w-full px-4 py-3 rounded-xl border text-center" style="font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif;">
          </div>
          
          <div>
            <label class="block text-sm font-semibold mb-2" style="color: var(--md-slate);">Message</label>
            <textarea id="messageInput" rows="4" class="w-full px-4 py-3 rounded-xl border resize-none" style="font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif;" placeholder="â€¢ We're so proud of your kindness!
â€¢ Keep up the great work!
â€¢ You are amazing!
â€¢ Your hard work makes us smile!"></textarea>
          </div>
        </form>
        
        <div class="flex gap-3 justify-center mt-4 mb-4 edit-only" style="display: none;">
          <button onclick="generateShoutout()" class="px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-mustard);">
            ğŸ² Generate
          </button>
        </div>
        
        <div class="flex gap-3 justify-center">
          <button onclick="closeCreateShoutoutModal()" class="px-6 py-3 rounded-xl border font-semibold">Cancel</button>
          <button onclick="submitShoutout()" class="px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-coral);">
            Send Shoutout! ğŸ’Œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Shoutouts Management Modal -->
  <div id="adminShoutsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; justify-content: center; align-items: center;" onclick="closeAdminShoutsModal()">
    <div class="bg-[color:var(--card-bg)] rounded-2xl shadow-soft p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation();" style="border: 3px solid var(--md-slate);">
      <div class="text-center mb-6">
        <h3 class="text-2xl font-display font-bold" style="color: var(--md-slate);">ğŸ“‹ Manage Shoutouts</h3>
        <div class="flex gap-2 justify-center mt-4">
          <button id="filterAll" class="px-3 py-1 rounded-lg text-sm font-semibold filter-btn active" onclick="filterShoutouts('all')">All</button>
          <button id="filterPending" class="px-3 py-1 rounded-lg text-sm font-semibold filter-btn" onclick="filterShoutouts('pending')">Pending</button>
          <button id="filterApproved" class="px-3 py-1 rounded-lg text-sm font-semibold filter-btn" onclick="filterShoutouts('approved')">Approved</button>
          <button id="filterArchived" class="px-3 py-1 rounded-lg text-sm font-semibold filter-btn" onclick="filterShoutouts('archived')">Archived</button>
        </div>
      </div>
      
      <!-- Main TV Message Section -->
      <div class="mb-6 p-4 rounded-xl" style="background: color-mix(in oklab, var(--md-cream) 70%, var(--md-mustard) 30%); border: 2px solid var(--md-mustard);">
        <div class="text-center mb-3">
          <h4 class="text-lg font-semibold" style="color: var(--md-slate);">ğŸ“º TV Main Message</h4>
          <p class="text-sm" style="color: var(--md-slate); opacity: 0.8;">This message appears on the TV by default and when no shoutouts are available</p>
        </div>
        <div class="flex gap-3 items-start">
          <textarea id="mainMessageTextarea" class="flex-1 p-3 rounded-lg border resize-none" rows="3" style="font-family: 'Comic Sans MS', 'Comic Neue', cursive, sans-serif;" placeholder="Enter the main message for the TV display...">Welcome to our amazing first grade classroom! Keep being awesome, scholars!</textarea>
          <button id="saveMainMessageBtn" class="px-4 py-3 rounded-lg text-white font-semibold hover:opacity-90" style="background: var(--md-coral);" onclick="saveMainMessage()">
            ğŸ’¾ Save Message
          </button>
        </div>
      </div>
      
      <div id="adminShoutsContainer" class="space-y-3 max-h-96 overflow-y-auto">
        <!-- Shoutouts will be populated here -->
      </div>
      
      <div class="text-center mt-6">
        <button onclick="closeAdminShoutsModal()" class="px-6 py-3 rounded-xl text-white font-semibold hover:opacity-90" style="background: var(--md-slate);">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Image Enlargement Modal -->
  <div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;" onclick="closeImageModal()">
    <div style="position: relative; max-width: 90%; max-height: 90%; display: flex; justify-content: center; align-items: center;">
      <img id="modalImage" src="" alt="Enlarged view" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);">
      <button onclick="closeImageModal()" style="position: absolute; top: -40px; right: -40px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;" title="Close">âœ•</button>
    </div>
  </div>
</body>
</html>
